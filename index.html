<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus HR â€” Enterprise Command</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            /* Theme Colors - Deep Space Dark */
            --bg: #0a0b0d;
            --bg-elevated: #13151a;
            --bg-card: rgba(22, 24, 29, 0.8);
            --fg: #f0f0f2;
            --fg-muted: #9ca3af;
            --fg-dim: #4b5563;
            
            /* Accents */
            --accent: #f59e0b; /* Amber */
            --accent-dim: rgba(245, 158, 11, 0.15);
            --accent-glow: rgba(245, 158, 11, 0.4);
            --danger: #ef4444;
            --success: #10b981;
            --info: #3b82f6;
            --purple: #8b5cf6;
            
            /* Structure */
            --border: rgba(255, 255, 255, 0.08);
            --border-strong: rgba(255, 255, 255, 0.15);
            --radius: 12px;
            --radius-lg: 20px;
            
            /* Typography */
            --font-display: 'Space Grotesk', sans-serif;
            --font-ui: 'DM Sans', sans-serif;
        }

        /* Local Mode Overrides */
        body.local-mode {
            --bg: #0f172a; /* Darker Blue-Grey */
            --bg-elevated: #1e293b;
            --accent: #06b6d4; /* Cyan */
            --accent-dim: rgba(6, 182, 212, 0.15);
            --accent-glow: rgba(6, 182, 212, 0.4);
        }

        /* Reset & Base */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: var(--font-ui); background: var(--bg); color: var(--fg); 
            min-height: 100vh; overflow-x: hidden; line-height: 1.5; 
            transition: background 0.4s ease;
        }

        /* Ambient Background */
        .bg-gradient-orb { position: fixed; border-radius: 50%; filter: blur(100px); opacity: 0.25; animation: orbFloat 25s ease-in-out infinite; pointer-events: none; z-index: 0; }
        .orb-1 { width: 500px; height: 500px; background: radial-gradient(circle, var(--accent) 0%, transparent 70%); top: -150px; right: -150px; }
        .orb-2 { width: 400px; height: 400px; background: radial-gradient(circle, var(--purple) 0%, transparent 70%); bottom: -100px; left: -100px; animation-delay: -12s; }
        @keyframes orbFloat { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-30px, 30px); } }

        /* Layout */
        .screen { position: relative; z-index: 10; min-height: 100vh; padding: 80px 16px 100px; max-width: 1000px; margin: 0 auto; }
        .hidden { display: none !important; }
        
        /* Cards */
        .card { background: var(--bg-card); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); transition: transform 0.2s, border-color 0.2s; }
        .card:hover { border-color: var(--border-strong); }

        /* Typography */
        h1, h2, h3, h4 { font-family: var(--font-display); color: var(--fg); font-weight: 600; letter-spacing: -0.02em; }
        h1 { font-size: 1.8rem; }
        h2 { font-size: 1.25rem; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        h3 { font-size: 0.75rem; margin-bottom: 12px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; border: none; border-radius: 10px; font-family: var(--font-ui); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; width: 100%; }
        .btn-primary { background: var(--accent); color: #000; box-shadow: 0 4px 15px var(--accent-dim); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--accent-glow); }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-success { background: var(--success); color: #000; }
        .btn-ghost { background: rgba(255, 255, 255, 0.03); color: var(--fg-muted); border: 1px solid var(--border); }
        .btn-ghost:hover { background: rgba(255, 255, 255, 0.08); color: var(--fg); }
        .btn-sm { padding: 8px 12px; font-size: 0.8rem; border-radius: 8px; }

        /* Forms */
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.75rem; font-weight: 600; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px 14px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border); border-radius: 10px; color: var(--fg); font-family: var(--font-ui); font-size: 0.95rem; transition: all 0.2s; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-dim); }
        
        /* Navigation (Bottom Dock) */
        .tab-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; padding: 8px 16px; background: rgba(10, 11, 13, 0.9); backdrop-filter: blur(24px); border-radius: 50px; z-index: 100; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); max-width: 95%; overflow-x: auto; }
        
        .tab-btn { 
            width: 44px; height: 44px; 
            border: none; background: transparent; color: var(--fg-dim); font-size: 1.1rem; 
            cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            transition: all 0.3s; position: relative; flex-shrink: 0;
        }
        /* Tab Glow Effect */
        .tab-btn::after { content: ''; position: absolute; inset: 0; border-radius: 50%; background: var(--accent); opacity: 0; transform: scale(0.8); transition: 0.3s; z-index: -1; box-shadow: 0 0 10px var(--accent-glow); }
        .tab-btn.active { color: #000; transform: translateY(-2px); }
        .tab-btn.active::after { opacity: 1; transform: scale(1); box-shadow: 0 0 15px var(--accent); }
        .tab-btn.exit-btn { color: var(--danger); margin-left: 8px; }
        .tab-btn.exit-btn.active::after { background: var(--danger); }
        
        /* Grid & Layouts */
        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media(min-width: 768px) { .settings-grid { grid-template-columns: 1fr 1fr; } }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-0 { margin-bottom: 0; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-muted { color: var(--fg-muted); }
        .font-bold { font-weight: 700; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: 0.3s; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6); }
        .modal-overlay.open .modal-content { transform: scale(1); }

        /* Toast */
        .toast-container { position: fixed; top: 80px; left: 20px; right: 20px; z-index: 300; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: var(--bg-elevated); border: 1px solid var(--border); padding: 12px 16px; border-radius: 10px; display: flex; align-items: center; gap: 10px; animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto; border-left: 3px solid var(--accent); }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        @keyframes toastIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Components */
        .profile-photo { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; position: relative; }
        .profile-photo img { width: 100%; height: 100%; object-fit: cover; }
        .profile-photo.sm { width: 40px; height: 40px; }
        .profile-photo.lg { width: 100px; height: 100px; margin: 0 auto; }

        #map-container { height: 300px; width: 100%; border-radius: var(--radius); border: 1px solid var(--border); margin-top: 16px; z-index: 1; }
        .leaflet-container { background: var(--bg-elevated) !important; }

        .list-container { display: flex; flex-direction: column; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; background: rgba(0,0,0,0.2); }
        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.01); transition: 0.2s; }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: rgba(255,255,255,0.03); }
        .list-item-content { display: flex; align-items: center; gap: 12px; flex: 1; }
        
        .stat-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; }
        .stat-card:hover { border-color: var(--accent); background: var(--accent-dim); }
        .stat-val { font-size: 2.5rem; font-weight: 700; font-family: var(--font-display); background: linear-gradient(135deg, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge.pending { background: rgba(245, 158, 11, 0.2); color: var(--accent); }
        .badge.approved { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge.rejected { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge.online { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }

        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; inset: 0; background-color: #333; border-radius: 24px; transition: .3s; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .3s; }
        input:checked + .toggle-slider { background-color: var(--accent); }
        input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* Table */
        .log-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .log-table th { text-align: left; color: var(--fg-muted); padding: 8px; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; }
        .log-table td { padding: 10px 8px; border-bottom: 1px solid var(--border); color: var(--fg); }
        .log-table tr:hover td { background: rgba(255,255,255,0.02); }

        .status-p { color: var(--success); font-weight: 800; }
        .status-l { color: var(--accent); font-weight: 800; }
        .status-a { color: var(--danger); font-weight: 800; }
        
        .code-font { font-family: monospace; font-size: 0.8rem; color: var(--accent); }

        /* --- CHAT STYLES --- */
        .chat-layout { display: flex; height: 600px; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; background: rgba(0,0,0,0.3); }
        .chat-sidebar { width: 35%; border-right: 1px solid var(--border); background: rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .chat-main { width: 65%; display: flex; flex-direction: column; background: var(--bg-card); position: relative; }
        @media(max-width: 768px) { 
            .chat-layout { flex-direction: column; height: 70vh; } 
            .chat-sidebar { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid var(--border); display: none; }
            .chat-sidebar.mobile-visible { display: flex; }
            .chat-main { width: 100%; height: 60%; display: none; }
            .chat-main.mobile-visible { display: flex; }
        }
        .chat-header { padding: 12px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.03); font-weight: 600; display: flex; align-items: center; justify-content: space-between; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .message-bubble { max-width: 75%; padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg-sent { align-self: flex-end; background: var(--accent); color: #000; border-bottom-right-radius: 2px; }
        .msg-received { align-self: flex-start; background: var(--bg-elevated); color: var(--fg); border: 1px solid var(--border); border-bottom-left-radius: 2px; }
        .msg-meta { font-size: 0.65rem; opacity: 0.7; text-align: right; margin-top: 4px; display: block; }
        .chat-input-area { padding: 12px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); display: flex; gap: 10px; }
        .contact-item { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
        .contact-item:hover, .contact-item.active { background: rgba(255,255,255,0.05); }
        .contact-info { flex: 1; overflow: hidden; }
        .contact-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .contact-last-msg { font-size: 0.75rem; color: var(--fg-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    </style>
</head>
<body>
    <div class="bg-gradient-orb orb-1"></div>
    <div class="bg-gradient-orb orb-2"></div>

    <!-- Header -->
    <header style="position: fixed; top: 0; left: 0; right: 0; height: 64px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(10, 11, 13, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); z-index: 100;">
        <div class="flex items-center gap-3">
            <div style="width: 36px; height: 36px; background: var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #000; font-size: 1.1rem; box-shadow: 0 0 15px var(--accent-glow);">N</div>
            <div style="font-weight: 700; font-size: 1.2rem; font-family: var(--font-display);">Nexus<span style="color:var(--accent)">HR</span></div>
        </div>
        <div id="cloud-indicator" class="badge online" style="cursor: pointer;" onclick="manualSync()">Local</div>
    </header>

    <main id="app-container">
        <!-- Login Screen -->
        <section id="login-screen" class="screen">
            <div class="flex items-center justify-center" style="min-height: 80vh;">
                <div class="card" style="width: 100%; max-width: 380px; text-align: center;">
                    <div style="margin-bottom: 24px;">
                        <div style="width: 80px; height: 80px; background: var(--accent); border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #000; box-shadow: 0 0 30px var(--accent-glow);">
                            <i class="fa-solid fa-fingerprint"></i>
                        </div>
                        <h1 style="font-size: 1.6rem;">Workforce Command</h1>
                        <p style="color: var(--fg-muted); font-size: 0.9rem;">Secure Enterprise Access</p>
                    </div>
                    
                    <!-- Local Mode Toggle -->
                    <div class="flex justify-between items-center mb-4" style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; margin-bottom: 24px;">
                        <span style="font-size: 0.85rem; font-weight: 600;">Local Offline Mode</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="login-local-mode" onchange="toggleLocalMode(this)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <form onsubmit="handleLogin(event)">
                        <div class="input-group">
                            <input type="text" id="username" placeholder="User ID" required style="text-align: center; font-size: 1.1rem;">
                        </div>
                        <div class="input-group mb-0">
                            <input type="password" id="password" placeholder="Password" required style="text-align: center; font-size: 1.1rem;">
                        </div>
                        <button type="submit" class="btn btn-primary mt-4">Authenticate</button>
                        <div style="margin-top: 16px; font-size: 0.75rem; color: var(--fg-muted);">Default: admin / admin</div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Admin Panel -->
        <section id="admin-panel" class="screen hidden">
            <!-- Dashboard View -->
            <div id="admin-view-dashboard">
                <div class="card">
                    <h2>Command Center <i class="fa-solid fa-chart-line" style="color: var(--fg-muted); font-size: 0.9rem;"></i></h2>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div class="stat-card" onclick="openStatModal('total')">
                            <div class="stat-val" id="stat-total">0</div>
                            <div style="font-size: 0.8rem; color: var(--fg-muted); margin-top: 5px;">Total Staff</div>
                        </div>
                        <div class="stat-card" onclick="openStatModal('online')">
                            <div class="stat-val" id="stat-online">0</div>
                            <div style="font-size: 0.8rem; color: var(--fg-muted); margin-top: 5px;">Active Now</div>
                        </div>
                        <div class="stat-card" onclick="openStatModal('pending')">
                            <div class="stat-val" id="stat-adv">0</div>
                            <div style="font-size: 0.8rem; color: var(--fg-muted); margin-top: 5px;">Pending Advances</div>
                        </div>
                        <div class="stat-card" onclick="openStatModal('checkins')">
                            <div class="stat-val" id="stat-checkins">0</div>
                            <div style="font-size: 0.8rem; color: var(--fg-muted); margin-top: 5px;">Present Today</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 24px; margin-bottom: 12px; display: flex; justify-content: space-between;">
                        Live Operations Map 
                        <span class="text-xs text-muted" style="font-weight: 400;">GPS Enabled</span>
                    </h3>
                    <div id="map-container"></div>
                </div>

                <div class="card">
                    <h2>Security Log <span class="text-xs text-muted font-normal">Recent Access</span></h2>
                    <div style="overflow-x: auto;">
                        <table class="log-table">
                            <thead><tr><th>User</th><th>Device</th><th>IP</th><th>Time</th></tr></thead>
                            <tbody id="security-log-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Team View -->
            <div id="admin-view-team" class="hidden">
                <div class="card">
                    <h2>Team Directory <button class="btn btn-sm btn-primary" onclick="openEmpModal()" style="margin-left: auto;"><i class="fa-solid fa-plus"></i> Add</button></h2>
                    <div id="team-list"></div>
                </div>
            </div>

            <!-- Advances View -->
            <div id="admin-view-advances" class="hidden">
                <div class="card">
                    <h2>Advance Requests <span class="text-xs text-muted font-normal">Finance Approval</span></h2>
                    <div id="admin-advance-list"></div>
                </div>
            </div>

            <!-- Leaves View -->
            <div id="admin-view-leaves" class="hidden">
                <div class="card">
                    <h2>Leave Requests <span class="text-xs text-muted font-normal">HR Approval</span></h2>
                    <div id="admin-leave-list"></div>
                </div>
            </div>

            <!-- Communication Hub -->
            <div id="admin-view-msg" class="hidden">
                <div class="card">
                    <h2>Communication Hub</h2>
                    <div class="settings-grid">
                        <div class="stat-card" onclick="openMsgModal('chat')">
                            <i class="fa-brands fa-whatsapp" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                            <div style="font-weight: 600;">WhatsApp Chat</div>
                            <div class="text-xs text-muted">Direct / Group</div>
                        </div>
                        <div class="stat-card" onclick="openMsgModal('meeting')">
                            <i class="fa-solid fa-video" style="font-size: 2rem; color: var(--purple); margin-bottom: 10px;"></i>
                            <div style="font-weight: 600;">Schedule Meeting</div>
                            <div class="text-xs text-muted">Link & Notifications</div>
                        </div>
                        <div class="stat-card" onclick="openMsgModal('important')">
                            <i class="fa-solid fa-file-excel" style="font-size: 2rem; color: var(--accent); margin-bottom: 10px;"></i>
                            <div style="font-weight: 600;">Important Doc</div>
                            <div class="text-xs text-muted">Send Excel/PDF via WA</div>
                        </div>
                        <div class="stat-card" onclick="openMsgModal('projector')">
                            <i class="fa-solid fa-bell" style="font-size: 2rem; color: var(--info); margin-bottom: 10px;"></i>
                            <div style="font-weight: 600;">Service Reminder</div>
                            <div class="text-xs text-muted">DCI / Non-DCI Alerts</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports View (Updated) -->
            <div id="admin-view-reports" class="hidden">
                <div class="card">
                    <h2>Attendance Reports</h2>
                    <div class="settings-grid">
                        <div>
                            <div class="input-group"><label>Report Type</label>
                                <select id="report-type-select" onchange="toggleReportDateInput()">
                                    <option value="daily">Daily Report</option>
                                    <option value="monthly">Monthly Summary</option>
                                </select>
                            </div>
                            
                            <!-- NEW: Company Selection -->
                            <div class="input-group">
                                <label>Select Company (Optional)</label>
                                <select id="report-company-select" multiple style="height: 100px;">
                                    <option value="all">All Companies</option>
                                    <!-- Populated by JS -->
                                </select>
                                <p class="text-xs text-muted mt-1">Hold Ctrl/Cmd to select multiple. Leave blank/All for everyone.</p>
                            </div>

                            <div class="input-group" id="report-date-container">
                                <label id="report-date-label">Select Date</label>
                                <input type="date" id="report-date-input">
                            </div>
                            <button class="btn btn-primary" onclick="generateReport()"><i class="fa-solid fa-magnifying-glass"></i> Generate Report</button>
                        </div>
                        <div class="flex flex-col justify-center items-center text-center" style="background: rgba(0,0,0,0.2); border-radius: var(--radius); padding: 20px;">
                            <div class="text-sm text-muted mb-2">Default Sender Email</div>
                            <div class="code-font" id="report-sender-display">Not Configured</div>
                            <div class="text-xs text-muted mt-2">Used for Export functionality</div>
                        </div>
                    </div>
                </div>

                <div id="report-result-card" class="card hidden">
                    <h2>Report <span id="report-period-display" style="font-size: 0.9rem; font-weight: 400; color: var(--fg-muted);"></span></h2>
                    <div style="overflow-x: auto;">
                        <table class="log-table" id="report-table">
                            <!-- JS Generated -->
                        </table>
                    </div>
                    
                    <div class="settings-grid" style="margin-top: 20px;">
                        <button class="btn btn-ghost" onclick="downloadReportPDF()"><i class="fa-solid fa-file-pdf"></i> Export PDF (Color)</button>
                        <button class="btn btn-ghost" onclick="shareReport('wa')"><i class="fa-brands fa-whatsapp"></i> WhatsApp</button>
                        <button class="btn btn-ghost" onclick="shareReport('telegram')"><i class="fa-brands fa-telegram"></i> Telegram</button>
                        <button class="btn btn-ghost" onclick="shareReport('email')"><i class="fa-solid fa-envelope"></i> Email</button>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="admin-view-settings" class="hidden">
                <div class="card">
                    <h2>System Configuration</h2>
                    
                    <div class="settings-grid">
                        <!-- Cloud & API -->
                        <div>
                            <h3>Cloud & API Keys</h3>
                            <div class="input-group"><label>JSON Bin ID</label><input type="text" id="cfg-bin-id" placeholder="Enter Bin ID"></div>
                            <div class="input-group"><label>JSON Master Key</label><input type="password" id="cfg-master-key" placeholder="Enter Master Key"></div>
                            <div class="input-group"><label>ImgBB API Key</label><input type="password" id="cfg-imgbb-key" placeholder="ImgBB Key"></div>
                            <button class="btn btn-ghost btn-sm" onclick="saveCloudSettings()"><i class="fa-solid fa-save"></i> Save Credentials</button>
                        </div>

                        <!-- Security -->
                        <div>
                            <h3>Security & Tracking</h3>
                            <div class="flex justify-between items-center mb-4">
                                <span style="font-size: 0.9rem;">Enable Geo-Tracking</span>
                                <label class="toggle-switch"><input type="checkbox" id="cfg-tracking" onchange="saveGlobalSettings()"><span class="toggle-slider"></span></label>
                            </div>
                            <p class="text-muted text-xs mb-2">When enabled, captures IP, GPS, and UserAgent on every login.</p>
                        </div>
                    </div>

                    <div style="height: 1px; background: var(--border); margin: 24px 0;"></div>

                    <h3>Company Management</h3>
                    <div class="input-group flex gap-2">
                        <div style="flex: 1;"><label>Company Name</label><input type="text" id="new-comp-name" placeholder="e.g. Nexus Corp"></div>
                        <button class="btn btn-primary" style="height: 42px; align-self: flex-end;" onclick="addCompany()">Add</button>
                    </div>
                    <div id="company-list" class="list-container" style="margin-top: 12px;"></div>

                    <div style="height: 1px; background: var(--border); margin: 24px 0;"></div>

                    <h3>Automation Templates</h3>
                    <div class="input-group"><label>Sender Email ID (Admin)</label><input type="email" id="cfg-sender-email" placeholder="admin@nexus.com"></div>
                    <div class="input-group"><label>Advance Approval WhatsApp Msg</label><textarea id="tpl-wa-adv" rows="2"></textarea></div>
                    <div class="input-group mb-0"><label>Birthday WhatsApp Msg</label><textarea id="tpl-wa-bday" rows="2"></textarea></div>
                    <button class="btn btn-primary mt-4" onclick="saveGlobalSettings()">Save Settings</button>
                </div>

                <div class="card">
                    <h2>Data Management</h2>
                    <div class="settings-grid">
                        <div>
                            <h3>Master Database (JSON)</h3>
                            <p class="text-xs text-muted mb-2">Full system backup including settings, logs, and attendance.</p>
                            <button class="btn btn-ghost btn-sm mb-2" onclick="downloadMasterJSON()"><i class="fa-solid fa-download"></i> Download Backup</button>
                            <input type="file" id="jsonRestoreInput" accept=".json" class="hidden" onchange="handleRestoreJSON(this)">
                            <button class="btn btn-primary btn-sm" onclick="document.getElementById('jsonRestoreInput').click()"><i class="fa-solid fa-upload"></i> Restore from JSON</button>
                        </div>
                        <div>
                            <h3>User Profiles (Excel)</h3>
                            <p class="text-xs text-muted mb-2">Export/Import Employees and Admins via Excel sheets.</p>
                            <button class="btn btn-ghost btn-sm mb-2" onclick="exportToExcel()"><i class="fa-solid fa-file-excel"></i> Export to Excel</button>
                            <input type="file" id="excelImportInput" accept=".xlsx, .xls" class="hidden" onchange="handleImportExcel(this)">
                            <button class="btn btn-success btn-sm" onclick="document.getElementById('excelImportInput').click()"><i class="fa-solid fa-file-import"></i> Import from Excel</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Employee Panel -->
        <section id="employee-panel" class="screen hidden">
            <!-- Home View -->
            <div id="emp-view-home">
                <div class="card">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="profile-photo" id="emp-dash-photo"><i class="fa-solid fa-user"></i></div>
                        <div>
                            <h2 id="emp-dash-name" style="margin: 0; border: none; padding: 0; font-size: 1.3rem;">Employee</h2>
                            <div class="text-xs text-muted" id="emp-dash-role">Designation</div>
                        </div>
                    </div>

                    <div class="text-center" style="margin: 32px 0;">
                        <div id="clock-display" style="font-size: 3rem; font-weight: 700; font-family: var(--font-display); color: var(--fg); text-shadow: 0 0 20px rgba(255,255,255,0.1);">--:--</div>
                        <div id="date-display" style="color: var(--accent); font-size: 0.9rem; margin-top: 4px; font-weight: 600;"></div>
                    </div>

                    <button id="btn-check-in" class="btn btn-primary" onclick="performCheckIn()"><i class="fa-solid fa-location-dot"></i> Check In</button>
                    <button id="btn-check-out" class="btn btn-danger hidden" onclick="performCheckOut()"><i class="fa-solid fa-person-walking-arrow-right"></i> Check Out</button>
                    
                    <div id="att-status" class="hidden" style="margin-top: 20px; background: rgba(0,0,0,0.3); padding: 16px; border-radius: 12px; text-align: center; border: 1px solid var(--border);">
                        <div class="text-xs text-muted">Current Status</div>
                        <div class="badge approved" style="font-size: 0.9rem; margin: 4px 0;">Checked In</div>
                        <div style="margin-top: 8px; font-size: 0.95rem; font-weight: 600;" id="att-times">--:--</div>
                    </div>
                </div>

                <div class="card">
                    <h2>Quick Actions</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <button class="btn btn-ghost" onclick="openAdvanceModal()"><i class="fa-solid fa-money-bill-wave"></i> Advance</button>
                        <button class="btn btn-ghost" onclick="openLeaveModal()"><i class="fa-regular fa-calendar-check"></i> Leave</button>
                    </div>
                </div>

                <div class="card">
                    <h2>My Requests</h2>
                    <div id="my-advance-list" style="margin-bottom: 16px;"></div>
                    <div id="my-leave-list"></div>
                </div>
            </div>

            <!-- Employee Chat View -->
            <div id="emp-view-chat" class="hidden">
                <div class="card" style="padding: 0; height: calc(100vh - 180px); overflow: hidden;">
                    <div class="chat-layout">
                        <!-- Sidebar -->
                        <div class="chat-sidebar" id="emp-chat-sidebar">
                            <div class="chat-header">
                                <span>Chats</span>
                                <button class="btn btn-sm btn-primary" onclick="openNewChatModal()"><i class="fa-solid fa-plus"></i> New</button>
                            </div>
                            <div id="emp-contact-list" style="overflow-y: auto; flex: 1;">
                                <!-- Contacts Loaded Here -->
                            </div>
                        </div>
                        <!-- Main Chat -->
                        <div class="chat-main" id="emp-chat-main">
                            <div class="chat-header">
                                <div class="flex items-center gap-2">
                                    <button class="btn btn-sm btn-ghost hidden" id="emp-back-to-list" onclick="toggleEmpChatView(false)" style="width:30px; padding:0;"><i class="fa-solid fa-arrow-left"></i></button>
                                    <div id="emp-current-chat-name" style="font-size: 0.95rem;">Select a chat</div>
                                </div>
                                <button class="btn btn-sm btn-ghost" onclick="openChatOptions()"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            </div>
                            <div class="chat-messages" id="emp-messages-container">
                                <div class="text-center text-muted" style="margin-top: 50px;">Select a contact to start chatting</div>
                            </div>
                            <div class="chat-input-area">
                                <input type="text" id="emp-chat-input" placeholder="Type a message..." onkeypress="handleChatInputKey(event)">
                                <button class="btn btn-primary" style="width: auto;" onclick="sendEmpMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Navigation: Admin -->
    <nav id="admin-nav" class="tab-nav hidden">
        <button class="tab-btn active" onclick="switchAdminTab('dashboard', this)"><i class="fa-solid fa-chart-pie"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('team', this)"><i class="fa-solid fa-users"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('advances', this)"><i class="fa-solid fa-money-bill-transfer"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('leaves', this)"><i class="fa-regular fa-calendar-check"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('msg', this)"><i class="fa-solid fa-comments"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('reports', this)"><i class="fa-solid fa-file-invoice"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('settings', this)"><i class="fa-solid fa-cogs"></i></button>
        <!-- Admin Profile Button -->
        <button class="tab-btn" onclick="openAdminProfileModal()"><i class="fa-solid fa-user-shield"></i></button>
        <button class="tab-btn exit-btn" onclick="logout()"><i class="fa-solid fa-power-off"></i></button>
    </nav>
    
    <!-- Navigation: Employee -->
    <nav id="emp-nav" class="tab-nav hidden">
        <button class="tab-btn active" onclick="switchEmpTab('home', this)"><i class="fa-solid fa-house"></i></button>
        <!-- Employee Chat Tab -->
        <button class="tab-btn" onclick="switchEmpTab('chat', this)"><i class="fa-solid fa-comments"></i></button>
        <button class="tab-btn exit-btn" onclick="logout()"><i class="fa-solid fa-power-off"></i></button>
    </nav>

    <!-- Modals -->
    
    <!-- Location Permission Modal (Mandatory) -->
    <div id="locPermModal" class="modal-overlay" style="z-index: 500;">
        <div class="modal-content" style="text-align: center; max-width: 400px;">
            <div style="font-size: 3rem; color: var(--accent); margin-bottom: 16px;"><i class="fa-solid fa-location-crosshairs"></i></div>
            <h2>Location Required</h2>
            <p style="margin-bottom: 20px; color: var(--fg-muted);">Nexus HR requires location access for Check-In/Out security tracking. Please allow location access to continue.</p>
            <button class="btn btn-primary" onclick="requestLocationPermission()">Allow Location Access</button>
            <p class="text-xs text-muted mt-4">If denied, the app cannot be used.</p>
        </div>
    </div>

    <!-- Location Error Modal (Permanent Block) -->
    <div id="locErrorModal" class="modal-overlay" style="z-index: 600;">
        <div class="modal-content" style="text-align: center; max-width: 400px;">
            <div style="font-size: 3rem; color: var(--danger); margin-bottom: 16px;"><i class="fa-solid fa-triangle-exclamation"></i></div>
            <h2>Access Denied</h2>
            <p style="margin-bottom: 20px; color: var(--fg-muted);">Location permission was denied. You cannot use the Employee Dashboard without enabling Location Services.</p>
            <button class="btn btn-primary" onclick="location.reload()">Try Again</button>
            <p class="text-xs text-muted mt-4">Please enable location in your browser settings and reload.</p>
        </div>
    </div>

    <div id="statModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="statModalTitle">Details</h2>
            <div id="statModalList" class="list-container" style="max-height: 300px; overflow-y: auto;"></div>
            <button class="btn btn-ghost mt-4" onclick="closeModal('statModal')">Close</button>
        </div>
    </div>

    <!-- NEW: Manual Attendance Modal -->
    <div id="manualAttModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Manual Attendance Entry</h2>
            <div class="input-group"><label>Employee</label><select id="manual-emp-select"></select></div>
            <div class="input-group"><label>Date</label><input type="date" id="manual-att-date"></div>
            <div class="input-group"><label>Check-In Time</label><input type="time" id="manual-att-in"></div>
            <div class="input-group mb-0"><label>Check-Out Time (Optional)</label><input type="time" id="manual-att-out"></div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" onclick="saveManualAttendance()">Save Entry</button>
                <button class="btn btn-ghost w-full" onclick="closeModal('manualAttModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="empModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="empModalTitle">Add Employee</h2>
            <input type="hidden" id="emp-edit-idx">
            <div class="flex items-center gap-3 mb-4">
                <div class="profile-photo" id="emp-modal-photo"><i class="fa-solid fa-user"></i></div>
                <div style="flex: 1;">
                    <label class="btn btn-sm btn-ghost w-full text-xs"><input type="file" hidden onchange="handleImgUpload(this, 'emp-modal-photo', 'emp-photo-url')">Upload Img</label>
                    <input type="hidden" id="emp-photo-url">
                    <div class="input-group mb-0 mt-2"><input type="text" id="emp-photo-paste" placeholder="Or Paste Image URL" onchange="document.getElementById('emp-modal-photo').innerHTML = this.value ? `<img src='${this.value}'>` : '<i class=fa-solid fa-user></i>'; document.getElementById('emp-photo-url').value = this.value;"></div>
                </div>
            </div>
            <div class="input-group"><label>Full Name</label><input type="text" id="emp-name"></div>
            <div class="input-group"><label>Employee ID</label><input type="text" id="emp-id"></div>
            <div class="input-group"><label>Mobile (WhatsApp)</label><input type="tel" id="emp-mobile"></div>
            <div class="input-group"><label>Company</label><select id="emp-company"></select></div>
            <!-- Extra Fields -->
            <div class="input-group"><label>Gmail ID</label><input type="email" id="emp-gmail"></div>
            <div class="input-group"><label>Company Mail ID</label><input type="email" id="emp-comp-mail"></div>
            <div class="input-group"><label>Date of Birth</label><input type="date" id="emp-dob"></div>
            <div class="input-group mb-0"><label>Password</label><input type="text" id="emp-pass" value="123456"></div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" onclick="saveEmployee()">Save</button>
                <button class="btn btn-ghost w-full" onclick="closeModal('empModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="compModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Edit Company</h2>
            <input type="hidden" id="comp-edit-id">
            <div class="input-group"><label>Company Name</label><input type="text" id="comp-edit-name"></div>
            <div class="input-group"><label>Finance Email (To)</label><input type="email" id="comp-edit-email"></div>
            <div class="input-group"><label>CC Email</label><input type="text" id="comp-edit-cc"></div>
            <div class="input-group"><label>WhatsApp Group Link</label><input type="text" id="comp-edit-wa"></div>
            <div class="input-group mb-0"><label>Default Advance Body</label><textarea id="comp-edit-body" rows="5"></textarea></div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" onclick="saveCompanyEdit()">Save</button>
                <button class="btn btn-ghost w-full" onclick="closeModal('compModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="advReqModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Request Advance</h2>
            <div class="input-group"><label>Amount (INR)</label><input type="number" id="adv-amount"></div>
            <div class="input-group"><label>Reason</label><textarea id="adv-reason" rows="2"></textarea></div>
            <h4 style="margin: 16px 0 8px; color: var(--accent); font-size: 0.9rem;">Email Preview (To: Finance)</h4>
            <div class="input-group"><label>Recipient</label><input type="text" id="adv-to-email" readonly style="opacity: 0.7;"></div>
            <div class="input-group"><label>Subject</label><input type="text" id="adv-subject"></div>
            <div class="input-group mb-0"><label>Body</label><textarea id="adv-body" rows="6"></textarea></div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" onclick="submitAdvance()">Send Request</button>
                <button class="btn btn-ghost w-full" onclick="closeModal('advReqModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="leaveReqModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Apply for Leave</h2>
            <div class="input-group"><label>Leave Type</label>
                <select id="leave-type">
                    <option value="Sick Leave">Sick Leave</option>
                    <option value="Casual Leave">Casual Leave</option>
                    <option value="Earned Leave">Earned Leave</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="input-group"><label>Start Date</label><input type="date" id="leave-start"></div>
            <div class="input-group"><label>End Date</label><input type="date" id="leave-end"></div>
            <div class="input-group mb-0"><label>Reason</label><textarea id="leave-reason" rows="3" placeholder="Reason for leave..."></textarea></div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" onclick="submitLeave()">Submit Request</button>
                <button class="btn btn-ghost w-full" onclick="closeModal('leaveReqModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- MSG Modal -->
    <div id="msgModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="msgModalTitle">Message</h2>
            
            <div id="msg-content-chat" class="hidden">
                <div class="input-group"><label>Recipient</label>
                    <select id="msg-recipient-select" onchange="toggleMsgGroupLink()">
                        <option value="one">One Employee</option>
                        <option value="multiple">Multiple Employees</option>
                        <option value="all">All Employees (Group)</option>
                    </select>
                </div>
                
                <div class="input-group hidden" id="msg-employee-select-container">
                    <label>Select Employees</label>
                    <select id="msg-employee-select" multiple style="height: 100px;"></select>
                </div>

                <div class="input-group"><label>Message</label><textarea id="msg-text" rows="4" placeholder="Type your message..."></textarea></div>
                
                <button class="btn btn-success w-full" onclick="sendWhatsAppMsg()"><i class="fa-brands fa-whatsapp"></i> Send via WhatsApp</button>
            </div>

            <div id="msg-content-meeting" class="hidden">
                <div class="input-group"><label>Recipient</label><select id="meet-recipient-select"><option value="all">All Employees</option><option value="one">One Employee</option></select></div>
                <div class="input-group hidden" id="meet-employee-select-container"><label>Select Employee</label><select id="meet-employee-select"></select></div>
                <div class="input-group"><label>Date</label><input type="date" id="meet-date"></div>
                <div class="input-group"><label>Time</label><input type="time" id="meet-time"></div>
                <div class="input-group"><label>Meeting Link</label><input type="text" id="meet-link" placeholder="https://meet.google.com/..."></div>
                <button class="btn btn-success w-full" onclick="scheduleMeeting()"><i class="fa-solid fa-paper-plane"></i> Send Invite</button>
            </div>

            <div id="msg-content-important" class="hidden">
                <div class="input-group"><label>Recipient</label><select id="imp-recipient-select"><option value="all">All Employees</option><option value="one">One Employee</option></select></div>
                <div class="input-group hidden" id="imp-employee-select-container"><label>Select Employee</label><select id="imp-employee-select"></select></div>
                <div class="input-group"><label>Upload Document (Excel/PDF)</label><input type="file" id="imp-file" accept=".xlsx, .xls, .pdf"></div>
                <div class="input-group"><label>Message</label><textarea id="imp-text" rows="3" placeholder="Important notice..."></textarea></div>
                <button class="btn btn-success w-full" onclick="sendImportantMsg()"><i class="fa-solid fa-paper-plane"></i> Send Document</button>
            </div>

            <div id="msg-content-projector" class="hidden">
                <div class="input-group"><label>Reminder Type</label>
                    <select id="proj-type">
                        <option value="Non-DCI Projector Servicing Pending Reminder">Non-DCI Projector Servicing Pending Reminder</option>
                        <option value="DCI Projector Servicing Pending Reminder">DCI Projector Servicing Pending Reminder</option>
                    </select>
                </div>
                <div class="input-group"><label>Recipient</label><select id="proj-recipient-select"><option value="all">All Employees</option><option value="one">One Employee</option></select></div>
                <div class="input-group hidden" id="proj-employee-select-container"><label>Select Employee</label><select id="proj-employee-select"></select></div>
                <div class="input-group"><label>Custom Message (Optional)</label><textarea id="proj-text" rows="3"></textarea></div>
                <button class="btn btn-success w-full" onclick="sendProjectorReminder()"><i class="fa-solid fa-bell"></i> Send Reminder</button>
            </div>

            <button class="btn btn-ghost mt-4" onclick="closeModal('msgModal')">Close</button>
        </div>
    </div>

    <!-- New Chat Modal (Employee) -->
    <div id="newChatModal" class="modal-overlay">
        <div class="modal-content">
            <h2>New Conversation</h2>
            <div class="input-group">
                <label>Recipients</label>
                <select id="new-chat-recipients" multiple style="height: 150px;">
                    <!-- Populated via JS -->
                </select>
                <p class="text-xs text-muted mt-1">Hold Ctrl/Cmd to select multiple</p>
            </div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" onclick="startNewChat()">Start Chat</button>
                <button class="btn btn-ghost w-full" onclick="closeModal('newChatModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Admin Profile Modal -->
    <div id="adminProfileModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Admin Profile</h2>
            <div class="flex justify-center mb-4">
                <div class="profile-photo lg" id="admin-modal-photo-preview">
                    <i class="fa-solid fa-user-shield" style="font-size: 2.5rem;"></i>
                </div>
            </div>
            
            <div class="flex justify-center gap-2 mb-4">
                <label class="btn btn-sm btn-ghost"><input type="file" hidden onchange="handleAdminImgUpload(this)">Upload Photo</label>
                <button class="btn btn-sm btn-ghost" onclick="document.getElementById('admin-photo-paste').value = ''; document.getElementById('admin-modal-photo-preview').innerHTML = '<i class=\'fa-solid fa-user-shield\' style=\'font-size: 2.5rem;\'></i>';">Remove</button>
            </div>
            <input type="hidden" id="admin-photo-hidden">
            <div class="input-group mb-4">
                <input type="text" id="admin-photo-paste" placeholder="Or Paste Image URL" onchange="updateAdminPhotoPreview(this.value)">
            </div>

            <div class="input-group"><label>Admin Name</label><input type="text" id="admin-edit-name"></div>
            <div class="input-group"><label>Mobile Number</label><input type="tel" id="admin-edit-mobile"></div>
            <div class="input-group"><label>Email ID</label><input type="email" id="admin-edit-email"></div>
            <div class="input-group mb-0"><label>New Password</label><input type="password" id="admin-edit-pass" placeholder="Leave blank to keep current"></div>
            
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" onclick="saveAdminProfile()">Save Changes</button>
                <button class="btn btn-ghost w-full" onclick="closeModal('adminProfileModal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="toast-box" class="toast-container"></div>

    <script>
        // --- State & Configuration ---
        const DEFAULT_DB = {
            admins: [{ id: 'admin', pass: 'admin', name: 'Super Admin', photo: '', mobile: '', email: '' }],
            employees: [],
            companies: [],
            advances: [],
            leaves: [],
            attendance: [],
            logs: [],
            messages: [], 
            chats: [], // Added Chat Metadata
            settings: {
                binId: '6989fe3fae596e708f1dd133',
                masterKey: '$2a$10$31RRwjp5GFNYo/puv4Q/wOln3poLiM/SM3lXde69LjAIKizHfzYSe',
                imgbbKey: '2ea092d1a232ac1ae234c650f19a7b37',
                senderEmail: '',
                trackingEnabled: true,
                tplWaAdv: 'Dear {name}, your advance of {amount} is {status}.',
                tplWaBday: 'Happy Birthday {name}!'
            }
        };

        let APP = {
            user: null,
            db: JSON.parse(JSON.stringify(DEFAULT_DB)),
            map: null,
            mapMarkers: [],
            isLocalMode: false,
            currentReportData: [],
            activeChatId: null, 
            locationPermissionGranted: false
        };

        // --- Init ---
        window.onload = () => {
            loadSettings(); 
            loadData(); 
            startClock();
            document.getElementById('report-date-input').value = new Date().toISOString().split('T')[0];
        };

        function startClock() {
            setInterval(() => {
                const now = new Date();
                const el = document.getElementById('clock-display');
                if(el) el.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const d = document.getElementById('date-display');
                if(d) d.textContent = now.toLocaleDateString(undefined, {weekday: 'long', month: 'short', day: 'numeric'});
            }, 1000);
        }

        // --- Data & Cloud Logic ---
        function loadSettings() {
            const creds = localStorage.getItem('nexushr_creds');
            if (creds) {
                const c = JSON.parse(creds);
                APP.db.settings.binId = c.binId || APP.db.settings.binId;
                APP.db.settings.masterKey = c.masterKey || APP.db.settings.masterKey;
                APP.db.settings.imgbbKey = c.imgbbKey || APP.db.settings.imgbbKey;
                APP.db.settings.senderEmail = c.senderEmail || APP.db.settings.senderEmail;
            }
            if(document.getElementById('cfg-bin-id')) document.getElementById('cfg-bin-id').value = APP.db.settings.binId;
            if(document.getElementById('cfg-master-key')) document.getElementById('cfg-master-key').value = APP.db.settings.masterKey;
            if(document.getElementById('cfg-imgbb-key')) document.getElementById('cfg-imgbb-key').value = APP.db.settings.imgbbKey;
            if(document.getElementById('cfg-sender-email')) document.getElementById('cfg-sender-email').value = APP.db.settings.senderEmail;
        }

        function saveCloudSettings() {
            APP.db.settings.binId = document.getElementById('cfg-bin-id').value;
            APP.db.settings.masterKey = document.getElementById('cfg-master-key').value;
            APP.db.settings.imgbbKey = document.getElementById('cfg-imgbb-key').value;
            APP.db.settings.senderEmail = document.getElementById('cfg-sender-email').value;
            localStorage.setItem('nexushr_creds', JSON.stringify({
                binId: APP.db.settings.binId,
                masterKey: APP.db.settings.masterKey,
                imgbbKey: APP.db.settings.imgbbKey,
                senderEmail: APP.db.settings.senderEmail
            }));
            saveData();
            showToast('Credentials saved', 'success');
            updateCloudStatus();
        }

        function loadData() {
            if (APP.db.settings.binId && APP.db.settings.masterKey && !APP.isLocalMode) {
                fetch(`https://api.jsonbin.io/v3/b/${APP.db.settings.binId}/latest`, {
                    headers: { 'X-Master-Key': APP.db.settings.masterKey }
                })
                .then(r => r.json())
                .then(res => {
                    if(res.record) {
                        APP.db = { ...DEFAULT_DB, ...res.record };
                        APP.db.settings = { ...DEFAULT_DB.settings, ...res.record.settings };
                        // Ensure Chat arrays exist if missing from old backup
                        if(!APP.db.chats) APP.db.chats = [];
                        if(!APP.db.messages) APP.db.messages = [];
                        loadSettings();
                        renderUI();
                        updateCloudStatus('online');
                    }
                })
                .catch(() => {
                    loadLocalBackup();
                    updateCloudStatus('error');
                });
            } else {
                loadLocalBackup();
                updateCloudStatus(APP.isLocalMode ? 'local' : 'error');
            }
        }

        function loadLocalBackup() {
            const local = localStorage.getItem('nexushr_db_v3');
            if(local) APP.db = { ...DEFAULT_DB, ...JSON.parse(local) };
            // Ensure Chat arrays exist
            if(!APP.db.chats) APP.db.chats = [];
            if(!APP.db.messages) APP.db.messages = [];
            renderUI();
        }

        function saveData() {
            localStorage.setItem('nexushr_db_v3', JSON.stringify(APP.db));
            if(!APP.isLocalMode) {
                syncToCloud();
            } else {
                updateCloudStatus('local');
            }
        }

        function syncToCloud() {
            if(!APP.db.settings.binId || !APP.db.settings.masterKey) return;
            document.getElementById('cloud-indicator').textContent = 'Syncing...';
            fetch(`https://api.jsonbin.io/v3/b/${APP.db.settings.binId}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Master-Key': APP.db.settings.masterKey 
                },
                body: JSON.stringify(APP.db)
            })
            .then(() => updateCloudStatus('online'))
            .catch(() => updateCloudStatus('error'));
        }
        
        function manualSync() { 
            APP.isLocalMode = false; 
            document.getElementById('login-local-mode').checked = false;
            document.body.classList.remove('local-mode');
            loadData(); 
        }

        function updateCloudStatus(status) {
            const el = document.getElementById('cloud-indicator');
            if(status === 'online') { el.textContent = 'Cloud Synced'; el.className = 'badge online'; }
            else if(status === 'error') { el.textContent = 'Cloud Error'; el.className = 'badge rejected'; }
            else { el.textContent = 'Local Mode'; el.className = 'badge pending'; }
        }

        function toggleLocalMode(checkbox) {
            APP.isLocalMode = checkbox.checked;
            if(APP.isLocalMode) {
                document.body.classList.add('local-mode');
                updateCloudStatus('local');
                showToast('Local Mode Active', 'info');
            } else {
                document.body.classList.remove('local-mode');
                manualSync();
            }
        }

        // --- Authentication & Security ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(u === APP.db.admins[0].id && p === APP.db.admins[0].pass) {
                postLoginSuccess(APP.db.admins[0], 'admin');
                return;
            }
            const emp = APP.db.employees.find(x => x.id === u && x.pass === p);
            if(emp) { postLoginSuccess(emp, 'employee'); return; }
            showToast('Invalid credentials', 'error');
        }

        async function postLoginSuccess(user, role) {
            APP.user = user;
            
            if (role === 'employee') {
                // MANDATORY LOCATION CHECK
                const permResult = await checkLocationPermission();
                
                if(permResult === 'denied') {
                    // Show Blocking Error Modal
                    document.getElementById('locErrorModal').classList.add('open');
                    return; 
                } else if (permResult === 'prompt') {
                    // Show "Allow Location" Modal
                    document.getElementById('locPermModal').classList.add('open');
                    return;
                }
                // If granted, proceed below
            }

            if(APP.db.settings.trackingEnabled) { await captureSecurityData(user); }
            document.getElementById('login-screen').classList.add('hidden');
            if(role === 'admin') {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-nav').classList.remove('hidden');
                renderAdminDashboard();
                setTimeout(initMap, 500);
            } else {
                document.getElementById('employee-panel').classList.remove('hidden');
                document.getElementById('emp-nav').classList.remove('hidden');
                renderEmployeeDashboard();
                loadEmpChatContacts(); 
            }
        }

        // --- ROBUST LOCATION PERMISSION LOGIC ---
        async function checkLocationPermission() {
            // 1. Check if Geolocation API exists
            if (!navigator.geolocation) return 'denied';

            // 2. Check Permission Status (if supported)
            if (navigator.permissions) {
                try {
                    const result = await navigator.permissions.query({ name: 'geolocation' });
                    if (result.state === 'denied') return 'denied';
                    if (result.state === 'granted') return 'granted';
                    // If 'prompt', we show the modal to trigger the actual browser popup
                    if (result.state === 'prompt') return 'prompt';
                } catch (e) {
                    // Fallback for browsers that don't support query
                    console.warn("Permissions API not supported, trying direct access");
                }
            }
            
            // 3. Try direct access to verify hardware status
            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        APP.locationPermissionGranted = true;
                        resolve('granted');
                    },
                    (error) => {
                        if (error.code === error.PERMISSION_DENIED) {
                            resolve('denied');
                        } else {
                            // Other errors (timeout, unavailable) - we treat as prompt/try again
                            resolve('prompt');
                        }
                    },
                    { timeout: 5000, enableHighAccuracy: true } // Short timeout to just check status
                );
            });
        }

        function requestLocationPermission() {
            // This triggers the actual browser prompt
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    APP.locationPermissionGranted = true;
                    document.getElementById('locPermModal').classList.remove('open');
                    // Proceed to dashboard
                    postLoginSuccess(APP.user, 'employee');
                },
                (error) => {
                    console.error(error);
                    // If they click "Block" on the browser prompt
                    if(error.code === error.PERMISSION_DENIED) {
                        document.getElementById('locPermModal').classList.remove('open');
                        document.getElementById('locErrorModal').classList.add('open');
                    } else {
                        showToast('Could not get location. Please try again.', 'error');
                    }
                },
                { timeout: 15000, enableHighAccuracy: true }
            );
        }

        async function captureSecurityData(user) {
            let loc = { lat: null, lng: null };
            let ip = 'Unknown';
            try { 
                const ipRes = await fetch('https://api.ipify.org?format=json'); 
                const ipData = await ipRes.json(); 
                ip = ipData.ip; 
            } catch(e){}
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    logSecurity(user, ip, loc);
                }, () => logSecurity(user, ip, loc));
            } else { logSecurity(user, ip, loc); }
        }

        function logSecurity(user, ip, loc) {
            const ua = navigator.userAgent;
            let device = 'Desktop';
            if(/Mobile/i.test(ua)) device = 'Mobile';
            if(/Tablet/i.test(ua)) device = 'Tablet';
            APP.db.logs.unshift({ user: user.name, device: `${device} (${navigator.platform})`, ip: ip, loc: loc, time: new Date().toLocaleString() });
            saveData();
        }

        function logout() { location.reload(); }

        // --- Admin Dashboard ---
        function renderUI() {
            if(APP.user && APP.user.role === 'admin') renderAdminDashboard();
            if(APP.user && APP.user.role !== 'admin') renderEmployeeDashboard();
        }

        function renderAdminDashboard() {
            document.getElementById('stat-total').textContent = APP.db.employees.length;
            document.getElementById('stat-online').textContent = Math.floor(APP.db.employees.length * 0.7);
            document.getElementById('stat-adv').textContent = APP.db.advances.filter(a => a.status === 'Pending').length;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('stat-checkins').textContent = APP.db.attendance.filter(a => a.date === today).length;
            renderSecurityLog();
            renderCompanyList();
            renderAdvanceListAdmin();
            renderAdminLeaves();
            renderTeamList();
            loadSettingsUI();
            document.getElementById('report-sender-display').textContent = APP.db.settings.senderEmail || 'Not Set';
            
            // Populate Report Company Select
            const compSelect = document.getElementById('report-company-select');
            if(compSelect) {
                while(compSelect.options.length > 1) { compSelect.remove(1); }
                APP.db.companies.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = c.name;
                    compSelect.appendChild(opt);
                });
            }
        }

        function renderSecurityLog() {
            const tbody = document.getElementById('security-log-body');
            tbody.innerHTML = APP.db.logs.slice(0, 5).map(l => `<tr><td>${l.user}</td><td class="text-xs text-muted">${l.device}</td><td class="code-font">${l.ip}</td><td class="text-xs">${l.time.split(',')[1]}</td></tr>`).join('') || '<tr><td colspan="4" class="text-center text-muted">No logs yet</td></tr>';
        }

        function initMap() {
            if(APP.map) APP.map.remove();
            APP.map = L.map('map-container').setView([20.5937, 78.9629], 5); 
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(APP.map);
            const today = new Date().toISOString().split('T')[0];
            let markerCount = 0;
            APP.db.employees.forEach(emp => {
                const lastAtt = APP.db.attendance.find(a => a.empId === emp.id && a.date === today);
                if(lastAtt && lastAtt.lat) { 
                    L.marker([lastAtt.lat, lastAtt.lng]).addTo(APP.map).bindPopup(`<b>${emp.name}</b><br>Checked In: ${lastAtt.in}`); 
                    markerCount++;
                }
            });
            if(markerCount === 0) {
                APP.db.employees.forEach(emp => {
                   if(emp.companyId) L.marker([20.5937 + (Math.random()-0.5)*5, 78.9629 + (Math.random()-0.5)*5]).addTo(APP.map).bindPopup(`<b>${emp.name}</b><br><span style="color:#888">Location Estimate</span>`);
                });
            }
        }

        // --- Company Management ---
        function renderCompanyList() {
            const list = document.getElementById('company-list');
            const select = document.getElementById('emp-company');
            select.innerHTML = '<option value="">Select Company</option>';
            list.innerHTML = APP.db.companies.map((c, i) => {
                select.innerHTML += `<option value="${c.id}">${c.name}</option>`;
                return `<div class="list-item"><div><div style="font-weight: 600;">${c.name}</div><div class="text-xs text-muted">${c.email}</div></div><div class="flex gap-2"><button class="btn btn-sm btn-ghost" onclick="editCompany(${i})"><i class="fa-solid fa-pen"></i></button><button class="btn btn-sm btn-ghost" style="color:var(--danger)" onclick="deleteCompany(${i})"><i class="fa-solid fa-trash"></i></button></div></div>`;
            }).join('') || '<div class="p-3 text-center text-muted">No companies added</div>';
        }

        function addCompany() {
            const name = document.getElementById('new-comp-name').value;
            if(!name) return;
            APP.db.companies.push({ id: 'c' + Date.now(), name: name, email: '', cc: '', wa: '', subject: 'Advance Required', body: `Dear Sir,\n\nEmployee Name: {name}\nID: {id}\nAmount: {amount}\n\nKindly approve.` });
            document.getElementById('new-comp-name').value = '';
            saveData();
            renderCompanyList();
        }

        function editCompany(idx) {
            const c = APP.db.companies[idx];
            document.getElementById('comp-edit-id').value = idx;
            document.getElementById('comp-edit-name').value = c.name;
            document.getElementById('comp-edit-email').value = c.email;
            document.getElementById('comp-edit-cc').value = c.cc;
            document.getElementById('comp-edit-wa').value = c.wa;
            document.getElementById('comp-edit-body').value = c.body;
            document.getElementById('compModal').classList.add('open');
        }

        function saveCompanyEdit() {
            const idx = document.getElementById('comp-edit-id').value;
            APP.db.companies[idx] = {
                ...APP.db.companies[idx],
                name: document.getElementById('comp-edit-name').value,
                email: document.getElementById('comp-edit-email').value,
                cc: document.getElementById('comp-edit-cc').value,
                wa: document.getElementById('comp-edit-wa').value,
                body: document.getElementById('comp-edit-body').value
            };
            saveData();
            renderCompanyList();
            closeModal('compModal');
        }

        function deleteCompany(idx) {
            if(confirm('Delete this company?')) {
                APP.db.companies.splice(idx, 1);
                saveData();
                renderCompanyList();
            }
        }

        // --- Employee Management ---
        function renderTeamList() {
            const list = document.getElementById('team-list');
            list.innerHTML = APP.db.employees.map((e, i) => `
                <div class="list-item">
                    <div class="list-item-content">
                        <div class="profile-photo sm" style="cursor:pointer" onclick="openEmpActionModal(${i})">
                            ${e.photo ? `<img src="${e.photo}">` : '<i class="fa-solid fa-user"></i>'}
                        </div>
                        <div>
                            <div style="font-weight: 600;">${e.name}</div>
                            <div class="text-xs text-muted">${e.id} | ${e.companyId ? APP.db.companies.find(c=>c.id===e.companyId)?.name : 'No Company'}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-ghost" title="Edit Employee" onclick="openEmpModal(${i})"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn btn-sm btn-ghost" title="Reset Password" onclick="resetEmployeePassword(${i})"><i class="fa-solid fa-key"></i></button>
                    </div>
                </div>
            `).join('') || '<div class="p-3 text-center text-muted">No employees</div>';
        }

        function openEmpModal(idx = null) {
            document.getElementById('empModalTitle').textContent = idx !== null ? 'Edit Employee' : 'Add Employee';
            document.getElementById('emp-edit-idx').value = idx !== null ? idx : '-1';
            if(idx !== null) {
                const e = APP.db.employees[idx];
                document.getElementById('emp-name').value = e.name;
                document.getElementById('emp-id').value = e.id;
                document.getElementById('emp-mobile').value = e.mobile || '';
                document.getElementById('emp-company').value = e.companyId || '';
                document.getElementById('emp-gmail').value = e.gmail || '';
                document.getElementById('emp-comp-mail').value = e.compMail || '';
                document.getElementById('emp-dob').value = e.dob || '';
                document.getElementById('emp-pass').value = e.pass;
                document.getElementById('emp-modal-photo').innerHTML = e.photo ? `<img src="${e.photo}">` : '<i class="fa-solid fa-user"></i>';
                document.getElementById('emp-photo-url').value = e.photo || '';
            } else {
                document.getElementById('emp-name').value = '';
                document.getElementById('emp-id').value = '';
                document.getElementById('emp-mobile').value = '';
                document.getElementById('emp-company').value = '';
                document.getElementById('emp-gmail').value = '';
                document.getElementById('emp-comp-mail').value = '';
                document.getElementById('emp-dob').value = '';
                document.getElementById('emp-pass').value = '123456';
                document.getElementById('emp-modal-photo').innerHTML = '<i class="fa-solid fa-user"></i>';
                document.getElementById('emp-photo-url').value = '';
            }
            renderCompanyList();
            document.getElementById('empModal').classList.add('open');
        }

        async function handleImgUpload(input, previewId, hiddenId) {
            const file = input.files[0];
            if(!file) return;
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', APP.db.settings.imgbbKey);
            showToast('Uploading photo...', 'pending');
            try {
                const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if(data.success) {
                    document.getElementById(previewId).innerHTML = `<img src="${data.data.url}">`;
                    document.getElementById(hiddenId).value = data.data.url;
                    showToast('Photo uploaded', 'success');
                } else throw new Error('Upload failed');
            } catch(e) { showToast('ImgBB Error: Check API Key', 'error'); }
        }

        function saveEmployee() {
            const idx = parseInt(document.getElementById('emp-edit-idx').value);
            const emp = {
                name: document.getElementById('emp-name').value,
                id: document.getElementById('emp-id').value,
                mobile: document.getElementById('emp-mobile').value,
                companyId: document.getElementById('emp-company').value,
                gmail: document.getElementById('emp-gmail').value,
                compMail: document.getElementById('emp-comp-mail').value,
                dob: document.getElementById('emp-dob').value,
                pass: document.getElementById('emp-pass').value,
                photo: document.getElementById('emp-photo-url').value
            };
            if(!emp.name || !emp.id) { showToast('Name & ID required', 'error'); return; }
            if(idx === -1 && APP.db.employees.find(e => e.id === emp.id)) { showToast('ID exists', 'error'); return; }
            if(idx === -1) APP.db.employees.push(emp);
            else APP.db.employees[idx] = emp;
            saveData();
            renderTeamList();
            closeModal('empModal');
            showToast('Saved', 'success');
        }

        function resetEmployeePassword(idx) {
            const emp = APP.db.employees[idx];
            const newPass = prompt(`Reset password for ${emp.name}:\nEnter new password:`, emp.pass);
            if(newPass !== null && newPass.trim() !== "") {
                APP.db.employees[idx].pass = newPass.trim();
                saveData();
                showToast('Password updated successfully', 'success');
            }
        }

        // --- Advance Logic ---
        function renderAdvanceListAdmin() {
            const list = document.getElementById('admin-advance-list');
            const pending = APP.db.advances.filter(a => a.status === 'Pending');
            list.innerHTML = pending.map(a => `
                <div class="list-item" style="flex-direction: column; align-items: flex-start;">
                    <div class="flex justify-between w-full mb-2"><strong>${a.empName}</strong><span style="color: var(--accent)">Rs. ${a.amount}</span></div>
                    <div class="text-xs text-muted mb-3">${a.reason}</div>
                    <div class="flex gap-2 w-full">
                        <button class="btn btn-sm btn-success w-full" onclick="processAdvance('${a.id}', 'Approved')"><i class="fa-solid fa-check"></i> Approve</button>
                        <button class="btn btn-sm btn-danger w-full" onclick="processAdvance('${a.id}', 'Rejected')"><i class="fa-solid fa-times"></i> Reject</button>
                        <button class="btn btn-sm btn-ghost w-full" onclick="deleteAdvance('${a.id}')"><i class="fa-solid fa-trash"></i> Delete</button>
                    </div>
                </div>
            `).join('') || '<div class="p-3 text-center text-muted">No pending requests</div>';
        }

        function openAdvanceModal() {
            const user = APP.user;
            const company = APP.db.companies.find(c => c.id === user.companyId);
            if(!company) { showToast('Please assign a Company to your profile first', 'error'); return; }
            document.getElementById('adv-amount').value = '';
            document.getElementById('adv-reason').value = '';
            document.getElementById('adv-to-email').value = company.email || 'Not Set';
            document.getElementById('adv-subject').value = company.subject || 'Advance Request';
            let body = company.body || 'Name: {name}\nAmount: {amount}';
            body = body.replace('{name}', user.name).replace('{id}', user.id).replace('{amount}', '{AMOUNT_PLACEHOLDER}');
            document.getElementById('adv-body').value = body;
            document.getElementById('advReqModal').classList.add('open');
        }

        function submitAdvance() {
            const amt = document.getElementById('adv-amount').value;
            if(!amt) return showToast('Enter amount', 'error');
            let body = document.getElementById('adv-body').value.replace('{AMOUNT_PLACEHOLDER}', amt);
            const req = { id: Date.now().toString(), empId: APP.user.id, empName: APP.user.name, amount: amt, reason: document.getElementById('adv-reason').value, date: new Date().toISOString().split('T')[0], status: 'Pending' };
            APP.db.advances.push(req);
            saveData();
            const subject = encodeURIComponent(document.getElementById('adv-subject').value);
            const to = document.getElementById('adv-to-email').value;
            window.open(`mailto:${to}?subject=${subject}&body=${encodeURIComponent(body)}`);
            closeModal('advReqModal');
            showMyAdvances();
            showToast('Request Sent', 'success');
        }

        function processAdvance(id, status) {
            const req = APP.db.advances.find(a => a.id === id);
            if(req) {
                req.status = status;
                saveData();
                renderAdvanceListAdmin();
                const emp = APP.db.employees.find(e => e.id === req.empId);
                const tpl = APP.db.settings.tplWaAdv || 'Your request is {status}.';
                const msg = tpl.replace('{name}', emp.name).replace('{amount}', req.amount).replace('{status}', status);
                if(emp.mobile) { const url = `https://wa.me/91${emp.mobile}?text=${encodeURIComponent(msg)}`; window.open(url, '_blank'); }
            }
        }

        function deleteAdvance(id) {
            if(confirm("Are you sure you want to delete this advance request?")) {
                APP.db.advances = APP.db.advances.filter(a => a.id !== id);
                saveData();
                renderAdvanceListAdmin();
                showToast("Request deleted", "success");
            }
        }

        // --- LEAVE LOGIC ---
        function renderAdminLeaves() {
            const list = document.getElementById('admin-leave-list');
            const pending = APP.db.leaves.filter(l => l.status === 'Pending');
            list.innerHTML = pending.map(l => `
                <div class="list-item" style="flex-direction: column; align-items: flex-start;">
                    <div class="flex justify-between w-full mb-2"><strong>${l.empName}</strong><span style="color: var(--accent)">${l.type}</span></div>
                    <div class="text-xs text-muted mb-1">From: ${l.start} To: ${l.end}</div>
                    <div class="text-xs text-muted mb-3">${l.reason}</div>
                    <div class="flex gap-2 w-full">
                        <button class="btn btn-sm btn-success w-full" onclick="processLeave('${l.id}', 'Approved')"><i class="fa-solid fa-check"></i> Approve</button>
                        <button class="btn btn-sm btn-danger w-full" onclick="processLeave('${l.id}', 'Rejected')"><i class="fa-solid fa-times"></i> Reject</button>
                        <button class="btn btn-sm btn-ghost w-full" onclick="deleteLeave('${l.id}')"><i class="fa-solid fa-trash"></i> Delete</button>
                    </div>
                </div>
            `).join('') || '<div class="p-3 text-center text-muted">No pending leave requests</div>';
        }

        function openLeaveModal() {
            document.getElementById('leave-type').value = 'Sick Leave';
            document.getElementById('leave-start').value = '';
            document.getElementById('leave-end').value = '';
            document.getElementById('leave-reason').value = '';
            document.getElementById('leaveReqModal').classList.add('open');
        }

        function submitLeave() {
            const type = document.getElementById('leave-type').value;
            const start = document.getElementById('leave-start').value;
            const end = document.getElementById('leave-end').value;
            const reason = document.getElementById('leave-reason').value;
            if(!start || !end) { showToast('Please select dates', 'error'); return; }
            if(new Date(start) > new Date(end)) { showToast('End date cannot be before start date', 'error'); return; }
            const req = { id: Date.now().toString(), empId: APP.user.id, empName: APP.user.name, type: type, start: start, end: end, reason: reason, dateApplied: new Date().toISOString().split('T')[0], status: 'Pending' };
            APP.db.leaves.push(req);
            saveData();
            closeModal('leaveReqModal');
            showMyLeaves();
            showToast('Leave Request Sent', 'success');
        }

        function processLeave(id, status) {
            const req = APP.db.leaves.find(l => l.id === id);
            if(req) { req.status = status; saveData(); renderAdminLeaves(); showToast(`Leave ${status}`, status === 'Approved' ? 'success' : 'error'); }
        }

        function deleteLeave(id) {
            if(confirm("Are you sure you want to delete this leave request?")) {
                APP.db.leaves = APP.db.leaves.filter(l => l.id !== id);
                saveData();
                renderAdminLeaves();
                showToast("Request deleted", "success");
            }
        }

        // --- MSG LOGIC ---
        function openMsgModal(type) {
            document.getElementById('msgModalTitle').textContent = type === 'chat' ? 'WhatsApp Chat' : type === 'meeting' ? 'Schedule Meeting' : type === 'important' ? 'Important Message' : 'Projector Reminder';
            
            ['chat','meeting','important','projector'].forEach(t => document.getElementById(`msg-content-${t}`).classList.add('hidden'));
            document.getElementById(`msg-content-${type}`).classList.remove('hidden');
            
            const selectOptions = APP.db.employees.map(e => `<option value="${e.id}">${e.name} (${e.mobile || 'No Mobile'})</option>`).join('');
            ['msg-employee-select', 'meet-employee-select', 'imp-employee-select', 'proj-employee-select'].forEach(id => document.getElementById(id).innerHTML = selectOptions);

            document.getElementById('msgModal').classList.add('open');
        }

        function toggleMsgGroupLink() {
            const type = document.getElementById('msg-recipient-select').value;
            const container = document.getElementById('msg-employee-select-container');
            if(type === 'one' || type === 'multiple') {
                container.classList.remove('hidden');
                if(type === 'one') document.getElementById('msg-employee-select').removeAttribute('multiple');
                else document.getElementById('msg-employee-select').setAttribute('multiple', true);
            } else {
                container.classList.add('hidden');
            }
        }

        function sendWhatsAppMsg() {
            const type = document.getElementById('msg-recipient-select').value;
            const text = document.getElementById('msg-text').value;
            if(!text) return showToast('Enter message', 'error');

            if(type === 'all') {
                const comp = APP.db.companies[0];
                if(comp && comp.wa) { window.open(comp.wa, '_blank'); }
                else { showToast('No Group Link set in Company Settings', 'error'); }
            } else {
                const select = document.getElementById('msg-employee-select');
                const selectedEmps = Array.from(select.selectedOptions).map(opt => opt.value);
                if(selectedEmps.length === 0) return showToast('Select employee', 'error');
                const emp = APP.db.employees.find(e => e.id === selectedEmps[0]);
                if(emp && emp.mobile) { window.open(`https://wa.me/91${emp.mobile}?text=${encodeURIComponent(text)}`, '_blank'); }
                else { showToast('Employee has no mobile number', 'error'); }
            }
        }

        function scheduleMeeting() {
            const type = document.getElementById('meet-recipient-select').value;
            const date = document.getElementById('meet-date').value;
            const time = document.getElementById('meet-time').value;
            const link = document.getElementById('meet-link').value;
            if(!date || !time || !link) return showToast('Fill all fields', 'error');
            const msg = `Meeting Scheduled\nDate: ${date}\nTime: ${time}\nLink: ${link}`;
            if(type === 'all') {
                const comp = APP.db.companies[0];
                if(comp && comp.wa) window.open(`${comp.wa}&text=${encodeURIComponent(msg)}`, '_blank');
                else showToast('No Group Link', 'error');
            } else {
                const empId = document.getElementById('meet-employee-select').value;
                const emp = APP.db.employees.find(e => e.id === empId);
                if(emp && emp.mobile) window.open(`https://wa.me/91${emp.mobile}?text=${encodeURIComponent(msg)}`, '_blank');
            }
        }

        async function sendImportantMsg() {
            const type = document.getElementById('imp-recipient-select').value;
            const text = document.getElementById('imp-text').value;
            const file = document.getElementById('imp-file').files[0];
            if(!file) return showToast('Select a file', 'error');
            showToast('Uploading file...', 'pending');
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', APP.db.settings.imgbbKey);
            try {
                const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if(data.success) {
                    const fileUrl = data.data.url;
                    const fullMsg = `${text}\n\nDocument/Attachment:\n${fileUrl}`;
                    if(type === 'all') {
                        const comp = APP.db.companies[0];
                        if(comp && comp.wa) window.open(`${comp.wa}&text=${encodeURIComponent(fullMsg)}`, '_blank');
                        else showToast('No Group Link', 'error');
                    } else {
                        const empId = document.getElementById('imp-employee-select').value;
                        const emp = APP.db.employees.find(e => e.id === empId);
                        if(emp && emp.mobile) window.open(`https://wa.me/91${emp.mobile}?text=${encodeURIComponent(fullMsg)}`, '_blank');
                    }
                }
            } catch(e) { showToast('Upload failed', 'error'); }
        }

        function sendProjectorReminder() {
            const type = document.getElementById('proj-type').value;
            const recipient = document.getElementById('proj-recipient-select').value;
            const customMsg = document.getElementById('proj-text').value;
            const fullMsg = `Reminder: ${type}\n${customMsg}`;
            if(recipient === 'all') {
                const comp = APP.db.companies[0];
                if(comp && comp.wa) window.open(`${comp.wa}&text=${encodeURIComponent(fullMsg)}`, '_blank');
                else showToast('No Group Link', 'error');
            } else {
                const empId = document.getElementById('proj-employee-select').value;
                const emp = APP.db.employees.find(e => e.id === empId);
                if(emp && emp.mobile) window.open(`https://wa.me/91${emp.mobile}?text=${encodeURIComponent(fullMsg)}`, '_blank');
            }
        }

        // --- UPDATED REPORT LOGIC ---
        function toggleReportDateInput() {
            const type = document.getElementById('report-type-select').value;
            const container = document.getElementById('report-date-container');
            if(type === 'daily') {
                document.getElementById('report-date-label').textContent = 'Select Date';
                document.getElementById('report-date-input').type = 'date';
            } else {
                document.getElementById('report-date-label').textContent = 'Select Month';
                document.getElementById('report-date-input').type = 'month';
            }
        }

        function generateReport() {
            const type = document.getElementById('report-type-select').value;
            const dateVal = document.getElementById('report-date-input').value;
            if(!dateVal) return showToast('Select date/month', 'error');

            // NEW: Get Company Selection
            const compSelect = document.getElementById('report-company-select');
            const selectedComps = Array.from(compSelect.selectedOptions).map(opt => opt.value);
            const includeAll = selectedComps.includes('all') || selectedComps.length === 0;

            let reportData = [];
            let periodStr = '';

            // Filter Employees based on company selection
            let targetEmployees = APP.db.employees;
            if(!includeAll) {
                targetEmployees = APP.db.employees.filter(e => selectedComps.includes(e.companyId));
            }

            if(type === 'daily') {
                periodStr = dateVal;
                targetEmployees.forEach((e, i) => {
                    const att = APP.db.attendance.find(a => a.empId === e.id && a.date === dateVal);
                    let status = 'A'; 
                    let statusClass = 'status-a';
                    if(att) { status = 'P'; statusClass = 'status-p'; }
                    const leave = APP.db.leaves.find(l => l.empId === e.id && l.start <= dateVal && l.end >= dateVal && l.status === 'Approved');
                    if(leave) { status = 'L'; statusClass = 'status-l'; }
                    reportData.push({ sl: i + 1, name: e.name, id: e.id, status: status, class: statusClass });
                });
            } else {
                periodStr = dateVal;
                const [year, month] = dateVal.split('-');
                const daysInMonth = new Date(year, month, 0).getDate();
                targetEmployees.forEach((e, i) => {
                    let presentCount = 0;
                    let leaveCount = 0;
                    for(let d=1; d<=daysInMonth; d++) {
                        const dayStr = `${year}-${month}-${d.toString().padStart(2,'0')}`;
                        if(APP.db.attendance.find(a => a.empId === e.id && a.date === dayStr)) presentCount++;
                        if(APP.db.leaves.find(l => l.empId === e.id && l.start <= dayStr && l.end >= dayStr && l.status === 'Approved')) leaveCount++;
                    }
                    reportData.push({ sl: i+1, name: e.name, id: e.id, status: `P:${presentCount} / L:${leaveCount}`, class: '' });
                });
            }

            APP.currentReportData = reportData;

            const tbody = document.getElementById('report-table');
            tbody.innerHTML = `<thead><tr><th>SL No</th><th>Name</th><th>ID</th><th>Status</th></tr></thead><tbody>` + 
                reportData.map(r => `<tr><td>${r.sl}</td><td>${r.name}</td><td>${r.id}</td><td class="${r.class}">${r.status}</td></tr>`).join('') + 
                `</tbody>`;

            document.getElementById('report-period-display').textContent = periodStr;
            document.getElementById('report-result-card').classList.remove('hidden');
        }

        function downloadReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text(`Attendance Report - ${document.getElementById('report-period-display').textContent}`, 14, 15);
            
            const tableColumn = ["SL No", "Name", "ID", "Status"];
            const tableRows = [];
            
            APP.currentReportData.forEach(row => {
                let rowStyle = {};
                let statusText = row.status;

                // Apply Color Coding
                if(row.status === 'P') { rowStyle.textColor = [16, 185, 129]; } // Green
                else if(row.status === 'L') { rowStyle.textColor = [245, 158, 11]; } // Orange
                else if(row.status === 'A') { rowStyle.textColor = [239, 68, 68]; } // Red
                
                tableRows.push([row.sl, row.name, row.id, { content: statusText, styles: rowStyle }]);
            });
            
            doc.autoTable({ 
                head: [tableColumn], 
                body: tableRows, 
                startY: 20,
                theme: 'grid',
                styles: { fontSize: 10, cellPadding: 3 },
                headStyles: { fillColor: [10, 11, 13] } // Dark Header
            });
            doc.save("Attendance_Report.pdf");
        }

        function shareReport(platform) {
            const text = `Attendance Report:\n${APP.currentReportData.map(r => `${r.sl}. ${r.name}: ${r.status}`).join('\n')}`;
            if(platform === 'wa') window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            else if(platform === 'telegram') window.open(`https://t.me/share/url?url=&text=${encodeURIComponent(text)}`, '_blank');
            else if(platform === 'email') {
                const to = APP.db.settings.senderEmail || '';
                window.open(`mailto:${to}?subject=Attendance Report&body=${encodeURIComponent(text)}`, '_self');
            }
        }

        // --- NEW: Admin Manual Attendance Logic ---
        function openManualAttModal() {
            const select = document.getElementById('manual-emp-select');
            select.innerHTML = '';
            APP.db.employees.forEach(e => {
                const opt = document.createElement('option');
                opt.value = e.id;
                opt.textContent = `${e.name} (${e.id})`;
                select.appendChild(opt);
            });
            document.getElementById('manual-att-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('manual-att-in').value = '09:00';
            document.getElementById('manual-att-out').value = '';
            document.getElementById('manualAttModal').classList.add('open');
        }

        function saveManualAttendance() {
            const empId = document.getElementById('manual-emp-select').value;
            const date = document.getElementById('manual-att-date').value;
            const inTime = document.getElementById('manual-att-in').value;
            const outTime = document.getElementById('manual-att-out').value;

            if(!date || !inTime) return showToast('Date and Check-In time required', 'error');

            // Check if entry exists, if so overwrite (Correction right)
            const existingIdx = APP.db.attendance.findIndex(a => a.empId === empId && a.date === date);
            const emp = APP.db.employees.find(e => e.id === empId);

            const entry = {
                empId: empId,
                empName: emp ? emp.name : 'Unknown',
                date: date,
                in: inTime,
                out: outTime || null,
                lat: null, lng: null // Manual entry has no GPS
            };

            if(existingIdx >= 0) {
                APP.db.attendance[existingIdx] = entry;
            } else {
                APP.db.attendance.push(entry);
            }
            saveData();
            closeModal('manualAttModal');
            showToast('Attendance Saved', 'success');
            // Refresh dashboard stats if needed
            renderAdminDashboard();
        }

        // --- Employee Dashboard ---
        function renderEmployeeDashboard() {
            const u = APP.user;
            document.getElementById('emp-dash-name').textContent = u.name;
            document.getElementById('emp-dash-role').textContent = u.id;
            const photo = document.getElementById('emp-dash-photo');
            photo.innerHTML = u.photo ? `<img src="${u.photo}">` : '<i class="fa-solid fa-user"></i>';
            const today = new Date().toISOString().split('T')[0];
            const att = APP.db.attendance.find(a => a.empId === u.id && a.date === today);
            if(att) {
                document.getElementById('btn-check-in').classList.add('hidden');
                document.getElementById('btn-check-out').classList.remove('hidden');
                document.getElementById('att-status').classList.remove('hidden');
                document.getElementById('att-times').textContent = `In: ${att.in} ${att.out ? '| Out: ' + att.out : ''}`;
                if(att.out) document.getElementById('btn-check-out').classList.add('hidden');
            } else {
                document.getElementById('btn-check-in').classList.remove('hidden');
                document.getElementById('btn-check-out').classList.add('hidden');
                document.getElementById('att-status').classList.add('hidden');
            }
            showMyAdvances();
            showMyLeaves();
        }

        // --- FIXED: Check In Logic with proper GPS handling ---
        function performCheckIn() {
            showToast('Acquiring GPS location...', 'pending');
            
            if (!navigator.geolocation) {
                showToast('Geolocation is not supported by your browser.', 'error');
                return;
            }

            const options = {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    APP.db.attendance.push({ 
                        empId: APP.user.id, 
                        empName: APP.user.name, 
                        date: new Date().toISOString().split('T')[0], 
                        in: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), 
                        out: null, 
                        lat: position.coords.latitude, 
                        lng: position.coords.longitude 
                    });
                    saveData();
                    renderEmployeeDashboard();
                    showToast('Checked In Successfully', 'success');
                },
                (error) => {
                    let errMsg = 'Location error.';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errMsg = "User denied the request for Geolocation. Please allow location in settings.";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errMsg = "Location information is unavailable. Check GPS signal.";
                            break;
                        case error.TIMEOUT:
                            errMsg = "The request to get user location timed out. Try again.";
                            break;
                        case error.UNKNOWN_ERROR:
                            errMsg = "An unknown error occurred.";
                            break;
                    }
                    showToast(errMsg, 'error');
                },
                options
            );
        }

        function performCheckOut() {
            const today = new Date().toISOString().split('T')[0];
            const rec = APP.db.attendance.find(a => a.empId === APP.user.id && a.date === today);
            if(rec) {
                rec.out = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                saveData();
                renderEmployeeDashboard();
                showToast('Checked Out', 'success');
            }
        }

        function showMyAdvances() {
            const list = document.getElementById('my-advance-list');
            const mine = APP.db.advances.filter(a => a.empId === APP.user.id).reverse();
            list.innerHTML = mine.map(a => `<div class="list-item" style="padding: 8px 12px;"><div class="flex justify-between w-full"><span>Rs. ${a.amount}</span><span class="badge ${a.status.toLowerCase()}">${a.status}</span></div><div class="text-xs text-muted">${a.date}</div></div>`).join('');
        }

        function showMyLeaves() {
            const list = document.getElementById('my-leave-list');
            const mine = APP.db.leaves.filter(l => l.empId === APP.user.id).reverse();
            list.innerHTML = mine.map(l => `<div class="list-item" style="padding: 8px 12px;"><div class="flex justify-between w-full"><span>${l.type}</span><span class="badge ${l.status.toLowerCase()}">${l.status}</span></div><div class="text-xs text-muted">${l.start} to ${l.end}</div></div>`).join('');
        }

        // --- Interactive Dashboard ---
        function openStatModal(type) {
            let users = [];
            let title = '';
            if(type === 'total') { title = 'All Staff'; users = APP.db.employees.map((e, i) => ({...e, realIdx: i})); }
            else if (type === 'online') { title = 'Active Staff'; users = APP.db.employees.slice(0, Math.ceil(APP.db.employees.length * 0.6)).map((e, i) => ({...e, realIdx: i})); }
            else if (type === 'pending') {
                title = 'Pending Advances';
                const html = APP.db.advances.filter(a => a.status === 'Pending').map(a => `<div class="list-item"><div><strong>${a.empName}</strong><br><span class="text-xs text-muted">Rs. ${a.amount}</span></div><span class="badge pending">Pending</span></div>`).join('') || '<div class="p-3 text-center">None</div>';
                document.getElementById('statModalTitle').textContent = title;
                document.getElementById('statModalList').innerHTML = html;
                document.getElementById('statModal').classList.add('open');
                return;
            } else if (type === 'checkins') {
                const today = new Date().toISOString().split('T')[0];
                const presentIds = APP.db.attendance.filter(a => a.date === today).map(a => a.empId);
                title = 'Present Today';
                users = APP.db.employees.filter(e => presentIds.includes(e.id)).map((e, i) => { const realIdx = APP.db.employees.findIndex(x => x.id === e.id); return {...e, realIdx: realIdx}; });
            }
            const html = users.map(u => `<div class="list-item" onclick="openEmpActionModal(${u.realIdx})"><div class="list-item-content"><div class="profile-photo sm">${u.photo ? `<img src="${u.photo}">` : '<i class="fa-solid fa-user"></i>'}</div><div><strong>${u.name}</strong><div class="text-xs text-muted">${type === 'online' ? '<span class="badge online">â— Online</span>' : 'Offline'}</div></div></div><i class="fa-solid fa-chevron-right" style="color:var(--fg-dim)"></i></div>`).join('') || '<div class="p-3 text-center">No records</div>';
            document.getElementById('statModalTitle').textContent = title;
            document.getElementById('statModalList').innerHTML = html;
            document.getElementById('statModal').classList.add('open');
        }

        function openEmpActionModal(idx) {
            const e = APP.db.employees[idx];
            if(e.mobile) window.open(`https://wa.me/91${e.mobile}`, '_blank');
            else showToast('No mobile number', 'error');
        }

        // --- Settings UI ---
        function loadSettingsUI() {
            document.getElementById('cfg-tracking').checked = APP.db.settings.trackingEnabled;
            document.getElementById('tpl-wa-adv').value = APP.db.settings.tplWaAdv;
            document.getElementById('tpl-wa-bday').value = APP.db.settings.tplWaBday;
        }

        function saveGlobalSettings() {
            APP.db.settings.trackingEnabled = document.getElementById('cfg-tracking').checked;
            APP.db.settings.tplWaAdv = document.getElementById('tpl-wa-adv').value;
            APP.db.settings.tplWaBday = document.getElementById('tpl-wa-bday').value;
            saveData();
            showToast('Settings Saved', 'success');
        }

        // --- Backup & Restore Logic ---
        function downloadMasterJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(APP.db, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "NexusHR_Backup_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function handleRestoreJSON(input) {
            const file = input.files[0];
            if(!file) return;
            if(!confirm("WARNING: This will overwrite the entire current database. Are you sure?")) { input.value = ''; return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.employees && json.settings) { APP.db = json; saveData(); alert("Database restored. Reloading..."); location.reload(); }
                    else { showToast("Invalid backup file format", "error"); }
                } catch(err) { showToast("Error parsing JSON", "error"); }
            };
            reader.readAsText(file);
        }

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const empData = APP.db.employees.map(e => ({ ID: e.id, Name: e.name, Mobile: e.mobile || '', Password: e.pass, CompanyID: e.companyId || '', PhotoURL: e.photo || '', Gmail: e.gmail || '', CompMail: e.compMail || '', DOB: e.dob || '' }));
            const wsEmp = XLSX.utils.json_to_sheet(empData);
            XLSX.utils.book_append_sheet(wb, wsEmp, "Employees");
            const admData = APP.db.admins.map(a => ({ ID: a.id, Name: a.name, Password: a.pass, PhotoURL: a.photo || '' }));
            const wsAdm = XLSX.utils.json_to_sheet(admData);
            XLSX.utils.book_append_sheet(wb, wsAdm, "Admins");
            XLSX.writeFile(wb, "NexusHR_Users_" + new Date().toISOString().split('T')[0] + ".xlsx");
        }

        function handleImportExcel(input) {
            const file = input.files[0];
            if(!file) return;
            if(!confirm("This will merge/update Employees and Admins from the Excel file. Continue?")) { input.value = ''; return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                if(workbook.Sheets["Employees"]) {
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets["Employees"]);
                    const newEmps = rows.map(r => ({
                        id: r['ID'] || r['id'], name: r['Name'] || r['name'], mobile: r['Mobile'] || r['mobile'], pass: r['Password'] || r['pass'] || '123456', companyId: r['CompanyID'] || r['companyId'], photo: r['PhotoURL'] || r['photo'], gmail: r['Gmail'] || r['gmail'], compMail: r['CompMail'] || r['compMail'], dob: r['DOB'] || r['dob']
                    }));
                    newEmps.forEach(importedEmp => {
                        if(!importedEmp.id || !importedEmp.name) return;
                        const existingIdx = APP.db.employees.findIndex(e => e.id === importedEmp.id);
                        if(existingIdx >= 0) APP.db.employees[existingIdx] = importedEmp;
                        else APP.db.employees.push(importedEmp);
                    });
                }
                if(workbook.Sheets["Admins"]) {
                    const rows = XLSX.utils.sheet_to_json(workbook.Sheets["Admins"]);
                    const newAdms = rows.map(r => ({ id: r['ID'] || r['id'], name: r['Name'] || r['name'], pass: r['Password'] || r['pass'] || 'admin', photo: r['PhotoURL'] || r['photo'] }));
                     newAdms.forEach(importedAdm => {
                        if(!importedAdm.id || !importedAdm.name) return;
                        const existingIdx = APP.db.admins.findIndex(a => a.id === importedAdm.id);
                        if(existingIdx >= 0) APP.db.admins[existingIdx] = importedAdm;
                        else APP.db.admins.push(importedAdm);
                    });
                }
                saveData();
                alert("Import successful. Reloading...");
                location.reload();
            };
            reader.readAsArrayBuffer(file);
        }

        // --- Admin Profile Logic ---
        function openAdminProfileModal() {
            const admin = APP.db.admins[0];
            document.getElementById('admin-edit-name').value = admin.name || '';
            document.getElementById('admin-edit-mobile').value = admin.mobile || '';
            document.getElementById('admin-edit-email').value = admin.email || '';
            document.getElementById('admin-edit-pass').value = '';
            document.getElementById('admin-photo-hidden').value = admin.photo || '';
            updateAdminPhotoPreview(admin.photo);
            document.getElementById('adminProfileModal').classList.add('open');
        }

        function updateAdminPhotoPreview(url) {
            const preview = document.getElementById('admin-modal-photo-preview');
            if(url && url.length > 5) {
                preview.innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                preview.innerHTML = '<i class="fa-solid fa-user-shield" style="font-size: 2.5rem;"></i>';
            }
        }

        async function handleAdminImgUpload(input) {
            const file = input.files[0];
            if(!file) return;
            const formData = new FormData();
            formData.append('image', file);
            formData.append('key', APP.db.settings.imgbbKey);
            showToast('Uploading photo...', 'pending');
            try {
                const res = await fetch('https://api.imgbb.com/1/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if(data.success) {
                    document.getElementById('admin-photo-hidden').value = data.data.url;
                    document.getElementById('admin-photo-paste').value = data.data.url;
                    updateAdminPhotoPreview(data.data.url);
                    showToast('Photo uploaded', 'success');
                } else throw new Error('Upload failed');
            } catch(e) { showToast('ImgBB Error: Check API Key', 'error'); }
        }

        function saveAdminProfile() {
            const name = document.getElementById('admin-edit-name').value;
            const mobile = document.getElementById('admin-edit-mobile').value;
            const email = document.getElementById('admin-edit-email').value;
            const pass = document.getElementById('admin-edit-pass').value;
            const photo = document.getElementById('admin-photo-hidden').value;

            if(!name) { showToast('Name is required', 'error'); return; }

            APP.db.admins[0].name = name;
            APP.db.admins[0].mobile = mobile;
            APP.db.admins[0].email = email;
            if(pass && pass.trim() !== "") {
                APP.db.admins[0].pass = pass.trim();
            }
            APP.db.admins[0].photo = photo;
            
            APP.user.name = name;
            APP.user.photo = photo;
            APP.user.mobile = mobile;
            APP.user.email = email;

            saveData();
            closeModal('adminProfileModal');
            showToast('Profile Updated', 'success');
        }

        // --- EMPLOYEE CHAT SYSTEM ---
        function switchEmpTab(tab, btn) {
            document.querySelectorAll('#emp-nav .tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if(tab === 'home') {
                document.getElementById('emp-view-home').classList.remove('hidden');
                document.getElementById('emp-view-chat').classList.add('hidden');
            } else if (tab === 'chat') {
                document.getElementById('emp-view-home').classList.add('hidden');
                document.getElementById('emp-view-chat').classList.remove('hidden');
                loadEmpChatContacts();
            }
        }

        function toggleEmpChatView(showMain) {
            const sidebar = document.getElementById('emp-chat-sidebar');
            const main = document.getElementById('emp-chat-main');
            const backBtn = document.getElementById('emp-back-to-list');
            
            if(showMain) {
                sidebar.classList.remove('mobile-visible');
                main.classList.add('mobile-visible');
                backBtn.classList.remove('hidden');
            } else {
                sidebar.classList.add('mobile-visible');
                main.classList.remove('mobile-visible');
                backBtn.classList.add('hidden');
            }
        }

        function openNewChatModal() {
            const select = document.getElementById('new-chat-recipients');
            select.innerHTML = '';
            
            const adminOpt = document.createElement('option');
            adminOpt.value = 'admin';
            adminOpt.textContent = 'Admin (Super Admin)';
            select.appendChild(adminOpt);

            APP.db.employees.forEach(e => {
                if(e.id !== APP.user.id) {
                    const opt = document.createElement('option');
                    opt.value = e.id;
                    opt.textContent = `${e.name} (${e.id})`;
                    select.appendChild(opt);
                }
            });

            document.getElementById('newChatModal').classList.add('open');
        }

        function startNewChat() {
            const select = document.getElementById('new-chat-recipients');
            const selected = Array.from(select.selectedOptions).map(o => o.value);
            
            if(selected.length === 0) return showToast('Select at least one recipient', 'error');
            
            const participants = [APP.user.id, ...selected].sort();
            const chatId = participants.join('-');
            
            let chat = APP.db.chats.find(c => c.id === chatId);
            if(!chat) {
                chat = {
                    id: chatId,
                    participants: participants,
                    createdAt: new Date().toISOString()
                };
                APP.db.chats.push(chat);
                saveData();
            }

            closeModal('newChatModal');
            loadEmpChatContacts();
            openChat(chatId);
        }

        function loadEmpChatContacts() {
            const list = document.getElementById('emp-contact-list');
            list.innerHTML = '';

            if(!APP.db.chats) APP.db.chats = [];

            const myChats = APP.db.chats.filter(c => c.participants.includes(APP.user.id));
            
            if(myChats.length === 0) {
                list.innerHTML = '<div class="p-3 text-center text-muted">No active chats.<br>Click + to start.</div>';
                return;
            }

            myChats.forEach(chat => {
                let otherParticipants = chat.participants.filter(id => id !== APP.user.id);
                let displayNames = otherParticipants.map(id => {
                    if(id === 'admin') return 'Admin';
                    const e = APP.db.employees.find(x => x.id === id);
                    return e ? e.name : 'Unknown';
                }).join(', ');

                const msgs = APP.db.messages.filter(m => m.chatId === chat.id);
                const lastMsg = msgs.length > 0 ? msgs[msgs.length - 1].text : 'No messages yet';
                const time = msgs.length > 0 ? new Date(msgs[msgs.length - 1].timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

                const item = document.createElement('div');
                item.className = `contact-item ${APP.activeChatId === chat.id ? 'active' : ''}`;
                item.onclick = () => openChat(chat.id);
                item.innerHTML = `
                    <div class="profile-photo sm"><i class="fa-solid fa-user"></i></div>
                    <div class="contact-info">
                        <div class="contact-name">${displayNames}</div>
                        <div class="contact-last-msg">${lastMsg} <span style="float:right; opacity:0.5">${time}</span></div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function openChat(chatId) {
            APP.activeChatId = chatId;
            loadEmpChatContacts(); 
            
            const chat = APP.db.chats.find(c => c.id === chatId);
            let otherParticipants = chat.participants.filter(id => id !== APP.user.id);
            let displayNames = otherParticipants.map(id => {
                if(id === 'admin') return 'Admin';
                const e = APP.db.employees.find(x => x.id === id);
                return e ? e.name : 'Unknown';
            }).join(', ');
            document.getElementById('emp-current-chat-name').textContent = displayNames;

            toggleEmpChatView(true);

            const container = document.getElementById('emp-messages-container');
            container.innerHTML = '';
            
            const msgs = APP.db.messages.filter(m => m.chatId === chatId).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            if(msgs.length === 0) {
                container.innerHTML = '<div class="text-center text-muted" style="margin-top:50px; font-size:0.8rem;">Say hello!</div>';
            } else {
                msgs.forEach(m => {
                    const isMe = m.senderId === APP.user.id;
                    const bubble = document.createElement('div');
                    bubble.className = `message-bubble ${isMe ? 'msg-sent' : 'msg-received'}`;
                    
                    let senderName = '';
                    if(!isMe) {
                         if(m.senderId === 'admin') senderName = 'Admin';
                         else {
                             const e = APP.db.employees.find(x => x.id === m.senderId);
                             senderName = e ? e.name : 'Unknown';
                         }
                    }

                    bubble.innerHTML = `
                        ${!isMe && chat.participants.length > 2 ? `<div style="font-size:0.65rem; color:var(--accent); margin-bottom:2px; font-weight:bold;">${senderName}</div>` : ''}
                        ${escapeHtml(m.text)}
                        <span class="msg-meta">${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                    `;
                    container.appendChild(bubble);
                });
                container.scrollTop = container.scrollHeight;
            }
        }

        function sendEmpMessage() {
            const input = document.getElementById('emp-chat-input');
            const text = input.value.trim();
            if(!text || !APP.activeChatId) return;

            const msg = {
                id: Date.now().toString(),
                chatId: APP.activeChatId,
                senderId: APP.user.id,
                text: text,
                timestamp: new Date().toISOString()
            };

            APP.db.messages.push(msg);
            saveData();
            
            input.value = '';
            openChat(APP.activeChatId); 
            loadEmpChatContacts(); 
        }

        function handleChatInputKey(e) {
            if(e.key === 'Enter') sendEmpMessage();
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function openChatOptions() {
            showToast('Chat options coming soon', 'info');
        }

        // --- Utils ---
        function switchAdminTab(tab, btn) {
            document.querySelectorAll('#admin-nav .tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            document.querySelectorAll('#admin-panel > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(`admin-view-${tab}`).classList.remove('hidden');

            // If reports tab, refresh company select
            if(tab === 'reports') renderAdminDashboard(); 
        }

        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function showToast(msg, type='success') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerHTML = type === 'success' ? `<i class="fa-solid fa-check-circle"></i> ${msg}` : `<i class="fa-solid fa-triangle-exclamation"></i> ${msg}`;
            document.getElementById('toast-box').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        document.querySelectorAll('.modal-overlay').forEach(o => {
            o.addEventListener('click', e => { if(e.target === o) o.classList.remove('open'); });
        });
    </script>
</body>
</html>