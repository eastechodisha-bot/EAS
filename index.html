<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus HR â€” Enterprise Management</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- JS PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <!-- Leaflet Map -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --bg-deep: #050505;
            --bg-surface: #121212;
            --bg-glass: rgba(20, 20, 20, 0.7);
            --primary: #6366f1; /* Indigo */
            --primary-glow: rgba(99, 102, 241, 0.4);
            --accent: #d946ef; /* Fuchsia */
            --success: #22c55e;
            --warning: #f97316;
            --danger: #ef4444;
            --fg-main: #f3f4f6;
            --fg-muted: #9ca3af;
            --border: rgba(255, 255, 255, 0.1);
            --radius-lg: 24px;
            --radius-md: 12px;
            --font-display: 'Space Grotesk', sans-serif;
            --font-ui: 'Inter', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: var(--font-ui); 
            background-color: var(--bg-deep);
            color: var(--fg-main);
            min-height: 100vh; overflow-x: hidden; 
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(217, 70, 239, 0.15) 0%, transparent 40%);
        }

        /* --- UTILITIES --- */
        .screen { position: relative; z-index: 5; padding: 80px 16px 100px; max-width: 1200px; margin: 0 auto; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .grid { display: grid; gap: 12px; }
        .grid-2 { grid-template-columns: 1fr 1fr; }
        .grid-3 { grid-template-columns: repeat(3, 1fr); }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-4 { margin-top: 16px; }
        .mb-4 { margin-bottom: 16px; }
        
        /* --- COMPONENTS --- */
        .card { 
            background: var(--bg-glass); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border); 
            border-radius: var(--radius-lg); 
            padding: 24px; 
            margin-bottom: 20px; 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); 
        }
        
        /* --- INPUTS --- */
        input, select, textarea { 
            width: 100%; background: rgba(0,0,0,0.4); border: 1px solid var(--border); 
            color: var(--fg-main); padding: 12px 16px; border-radius: var(--radius-md); 
            font-family: var(--font-ui); font-size: 0.95rem; transition: 0.3s; 
        }
        input:focus, select:focus, textarea:focus { 
            border-color: var(--primary); box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); 
        }

        /* --- BUTTONS --- */
        .btn { 
            border: none; border-radius: var(--radius-md); padding: 12px 20px; font-weight: 600; 
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; 
            transition: 0.2s; width: 100%; font-size: 0.9rem; 
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 0 20px var(--primary-glow); }
        .btn-accent { background: var(--accent); color: white; }
        .btn-success { background: rgba(34, 197, 94, 0.15); color: var(--success); border: 1px solid var(--success); }
        .btn-danger { background: rgba(239, 68, 68, 0.15); color: var(--danger); border: 1px solid var(--danger); }
        .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--fg-muted); }
        .btn-ghost:hover { background: rgba(255,255,255,0.05); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 0.8rem; width: auto; }
        .btn-icon { width: 36px; height: 36px; padding: 0; border-radius: 50%; }

        /* --- HEADER --- */
        header { 
            position: fixed; top: 0; left: 0; right: 0; height: 64px; 
            background: rgba(5, 5, 5, 0.8); backdrop-filter: blur(20px); 
            border-bottom: 1px solid var(--border); z-index: 50; 
            display: flex; align-items: center; justify-content: space-between; padding: 0 20px; 
        }
        .brand { display: flex; align-items: center; gap: 12px; font-family: var(--font-display); font-weight: 700; font-size: 1.2rem; }
        .brand-icon { 
            width: 36px; height: 36px; background: linear-gradient(135deg, var(--primary), var(--accent)); 
            border-radius: 10px; display: flex; align-items: center; justify-content: center; 
            font-size: 1.2rem; color: white; box-shadow: 0 0 15px var(--primary-glow); 
        }

        /* --- NAV --- */
        .nav-dock { 
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); 
            background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(20px); 
            border: 1px solid var(--border); padding: 8px 16px; border-radius: 40px; 
            display: flex; gap: 8px; z-index: 50; box-shadow: 0 10px 40px rgba(0,0,0,0.6); 
            max-width: 98%; overflow-x: auto; 
        }
        .nav-btn { 
            width: 48px; height: 48px; border-radius: 50%; border: none; background: transparent; 
            color: var(--fg-muted); font-size: 1.1rem; cursor: pointer; transition: 0.3s; 
            display: flex; align-items: center; justify-content: center; flex-shrink: 0; 
        }
        .nav-btn:hover { color: white; background: rgba(255,255,255,0.05); }
        .nav-btn.active { background: var(--primary); color: white; transform: translateY(-5px); box-shadow: 0 5px 15px var(--primary-glow); }
        .nav-btn.exit { color: var(--danger); margin-left: 8px; }
        .nav-btn.exit.active { background: var(--danger); color: white; }

        /* --- LIST ITEMS --- */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid var(--border); }
        .list-item:last-child { border-bottom: none; }
        .list-content h4 { font-size: 0.95rem; font-weight: 600; margin-bottom: 2px; color: var(--fg-main); }
        .list-content p { font-size: 0.8rem; color: var(--fg-muted); }

        /* --- MAP --- */
        #map-container { height: 350px; width: 100%; border-radius: var(--radius-md); border: 1px solid var(--border); margin-top: 16px; z-index: 1; overflow: hidden; }

        /* --- AVATAR --- */
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: #333; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; overflow: hidden; object-fit: cover; border: 2px solid var(--border); }
        .avatar.lg { width: 80px; height: 80px; font-size: 2rem; border-width: 3px; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        /* --- TABLE --- */
        .table-container { overflow-x: auto; border-radius: var(--radius-md); border: 1px solid var(--border); }
        .report-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 600px; }
        .report-table th { text-align: left; padding: 14px; background: rgba(255,255,255,0.05); color: var(--fg-muted); font-weight: 600; border-bottom: 1px solid var(--border); }
        .report-table td { padding: 14px; border-bottom: 1px solid var(--border); }
        .report-table tr:hover td { background: rgba(255,255,255,0.02); }
        
        /* Status Colors */
        .status-cell { font-weight: 700; text-transform: uppercase; font-size: 0.75rem; padding: 4px 8px; border-radius: 4px; display: inline-block; }
        .status-P { color: #000; background: var(--success); }
        .status-L { color: #000; background: var(--warning); }
        .status-A { color: #fff; background: var(--danger); }

        /* --- CHAT --- */
        .chat-layout { display: flex; height: 600px; border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; background: rgba(0,0,0,0.3); }
        .chat-sidebar { width: 35%; border-right: 1px solid var(--border); background: rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .chat-main { width: 65%; display: flex; flex-direction: column; background: var(--bg-glass); position: relative; }
        @media(max-width: 768px) { 
            .chat-layout { flex-direction: column; height: 80vh; } 
            .chat-sidebar { width: 100%; height: 40%; display: none; }
            .chat-sidebar.mobile-visible { display: flex; }
            .chat-main { width: 100%; height: 60%; display: none; }
            .chat-main.mobile-visible { display: flex; }
        }
        .chat-header { padding: 12px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.03); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        .message-bubble { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; position: relative; word-wrap: break-word; animation: popIn 0.2s ease; }
        .msg-sent { align-self: flex-end; background: var(--primary); color: #fff; border-bottom-right-radius: 2px; }
        .msg-received { align-self: flex-start; background: #333; color: var(--fg-main); border: 1px solid var(--border); border-bottom-left-radius: 2px; }
        .msg-meta { font-size: 0.65rem; opacity: 0.7; text-align: right; margin-top: 4px; display: block; }
        .chat-input-area { padding: 12px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); display: flex; gap: 10px; }
        .contact-item { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
        .contact-item:hover, .contact-item.active { background: rgba(255,255,255,0.05); }
        .contact-info { flex: 1; overflow: hidden; }
        .contact-name { font-weight: 600; font-size: 0.9rem; }
        .contact-last-msg { font-size: 0.75rem; color: var(--fg-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- BADGE --- */
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; display: inline-block; }
        .badge.pending { background: rgba(249, 115, 22, 0.15); color: var(--warning); }
        .badge.approved { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .badge.rejected { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .badge.online { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid #60a5fa; cursor: pointer; }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { background: #1e1e1e; border: 1px solid var(--border); padding: 24px; border-radius: 20px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: 0.3s; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.7); }
        .modal-overlay.open .modal-content { transform: scale(1); }

        /* --- TOAST --- */
        #toast-container { position: fixed; top: 80px; right: 20px; z-index: 200; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { pointer-events: auto; background: #1e1e1e; border: 1px solid var(--border); border-left: 4px solid var(--primary); color: white; padding: 12px 20px; border-radius: var(--radius-md); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- AI CHAT --- */
        .ai-bubble { background: linear-gradient(135deg, rgba(99,102,241,0.2), rgba(217,70,239,0.2)); border: 1px solid rgba(99,102,241,0.3); }
    </style>
</head>
<body>
    
    <!-- HEADER -->
    <header>
        <div class="brand">
            <div class="brand-icon"><i class="fa-solid fa-cube"></i></div>
            <div>Nexus HR <span style="font-size:0.7em; color:var(--primary); font-weight:400;" id="version-display">v2.1</span></div>
        </div>
        <div style="display:flex; gap:10px; align-items: center;">
            <div id="cloud-status" class="badge online" onclick="manualSync()">Local</div>
            <i class="fa-solid fa-bell" style="cursor:pointer; color: var(--fg-muted);" onclick="showNotification('System Active', 'info')"></i>
        </div>
    </header>

    <!-- LOGIN SCREEN -->
    <section id="login-screen" class="screen">
        <div style="max-width: 380px; margin: 8vh auto; text-align: center;">
            <div style="width: 100px; height: 100px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 28px; margin: 0 auto 32px; display: flex; align-items: center; justify-content: center; font-size: 3rem; color: white; box-shadow: 0 20px 50px rgba(99, 102, 241, 0.4);">
                <i class="fa-solid fa-fingerprint"></i>
            </div>
            <h1 style="margin-bottom: 8px;">Enterprise Access</h1>
            <p style="color: var(--fg-muted); margin-bottom: 40px;">Secure AI-Powered HR System</p>
            
            <form onsubmit="handleLogin(event)">
                <div class="input-group">
                    <input type="text" id="username" placeholder="User ID (admin)" required style="text-align: center; font-size: 1.1rem;">
                </div>
                <div class="input-group">
                    <input type="password" id="password" placeholder="Password (admin)" required style="text-align: center; font-size: 1.1rem;">
                </div>
                <button type="submit" class="btn btn-primary" style="height: 54px; font-size: 1rem; border-radius: 30px;">Authenticate</button>
            </form>
            <p class="mt-4" style="font-size: 0.8rem; color: var(--fg-muted);">Default: admin / admin</p>
        </div>
    </section>

    <!-- ADMIN PANEL -->
    <section id="admin-panel" class="screen hidden">
        
        <!-- Dashboard -->
        <div id="view-dashboard">
            <div class="card">
                <h2>Command Center <i class="fa-solid fa-chart-pie" style="opacity:0.3"></i></h2>
                <div class="grid grid-2">
                    <div class="card" style="padding: 20px; text-align: center; margin-bottom: 0; cursor: pointer; background: rgba(99, 102, 241, 0.1);" onclick="switchAdminTab('team')">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary);" id="adm-stat-emp">0</div>
                        <div style="font-size: 0.85rem; color: var(--fg-muted);">Employees</div>
                    </div>
                    <div class="card" style="padding: 20px; text-align: center; margin-bottom: 0; cursor: pointer; background: rgba(249, 115, 22, 0.1);" onclick="switchAdminTab('pending')">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--warning);" id="adm-stat-req">0</div>
                        <div style="font-size: 0.85rem; color: var(--fg-muted);">Pending</div>
                    </div>
                    <div class="card" style="padding: 20px; text-align: center; margin-bottom: 0; cursor: pointer; background: rgba(34, 197, 94, 0.1);" onclick="switchAdminTab('manager')">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--success);"><i class="fa-solid fa-clock-rotate-left"></i></div>
                        <div style="font-size: 0.85rem; color: var(--fg-muted);">Attendance Mgr</div>
                    </div>
                    <div class="card" style="padding: 20px; text-align: center; margin-bottom: 0; cursor: pointer; background: rgba(217, 70, 239, 0.1);" onclick="switchAdminTab('broadcast')">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--accent);"><i class="fa-solid fa-bullhorn"></i></div>
                        <div style="font-size: 0.85rem; color: var(--fg-muted);">Broadcast</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>Live Operations Feed</h2>
                <div id="map-container"></div>
            </div>
        </div>

        <!-- Company Management -->
        <div id="view-company" class="hidden">
            <div class="card">
                <h2>Company Management <button class="btn btn-sm btn-primary" onclick="openModal('companyModal')"><i class="fa-solid fa-plus"></i> Add</button></h2>
                <div id="company-list"></div>
            </div>
        </div>

        <!-- Team Management (UPDATED) -->
        <div id="view-team" class="hidden">
            <div class="card">
                <h2>Team Directory <button class="btn btn-sm btn-primary" onclick="openModal('empModal')"><i class="fa-solid fa-plus"></i> Add</button></h2>
                <div id="team-list"></div>
            </div>
        </div>

        <!-- Pending Requests -->
        <div id="view-pending" class="hidden">
            <div class="card">
                <h2>Pending Requests</h2>
                <div id="pending-list"></div>
            </div>
        </div>

        <!-- Attendance Manager (UPDATED) -->
        <div id="view-manager" class="hidden">
            <div class="card">
                <h2>Attendance Manager <span class="badge pending">Backdated Entry</span></h2>
                <!-- TABS -->
                <div class="flex" style="gap:10px; margin-bottom:20px;">
                    <button class="btn btn-sm btn-primary" onclick="switchMgrTab('single')">Single Entry</button>
                    <button class="btn btn-sm btn-ghost" onclick="switchMgrTab('bulk')">Bulk Entry</button>
                    <button class="btn btn-sm btn-ghost" onclick="switchMgrTab('history')">History / Edit</button>
                </div>

                <!-- SINGLE ENTRY -->
                <div id="mgr-tab-single">
                    <div class="input-group"><label>Select Employee</label><select id="adm-mgr-emp"></select></div>
                    <div class="grid grid-2">
                        <div class="input-group"><label>Date</label><input type="date" id="adm-mgr-date"></div>
                        <div class="input-group">
                            <label>Status</label>
                            <select id="adm-mgr-status">
                                <option value="P">Present (P)</option>
                                <option value="L">Leave (L)</option>
                                <option value="A">Absent (A)</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-2" id="mgr-time-inputs">
                        <div class="input-group"><label>Check In</label><input type="time" id="adm-mgr-in" value="09:30"></div>
                        <div class="input-group"><label>Check Out</label><input type="time" id="adm-mgr-out" value="18:30"></div>
                    </div>
                    <div class="input-group">
                        <label>Coordinates (Lat, Lng)</label>
                        <div class="flex" style="gap: 5px;">
                            <input type="number" id="adm-mgr-lat" placeholder="Lat" step="any">
                            <input type="number" id="adm-mgr-lng" placeholder="Lng" step="any">
                            <button class="btn btn-ghost" style="width: auto;" onclick="fillRandomCoords()"><i class="fa-solid fa-dice"></i></button>
                        </div>
                    </div>
                    <div class="input-group"><label>Notes</label><input type="text" id="adm-mgr-notes"></div>
                    <button class="btn btn-primary" onclick="adminAddAttendance()"><i class="fa-solid fa-plus"></i> Add Record</button>
                </div>

                <!-- BULK ENTRY -->
                <div id="mgr-tab-bulk" class="hidden">
                    <div class="input-group"><label>Date</label><input type="date" id="adm-bulk-date"></div>
                    <div class="grid grid-3">
                        <button class="btn btn-success" onclick="bulkMark('P')">Mark All Present (P)</button>
                        <button class="btn btn-accent" onclick="bulkMark('L')">Mark All Leave (L)</button>
                        <button class="btn btn-danger" onclick="bulkMark('A')">Mark All Absent (A)</button>
                    </div>
                    <p class="mt-4" style="font-size:0.8rem; color:var(--warning);">Warning: This overwrites existing entries for the selected date.</p>
                </div>

                <!-- HISTORY / EDIT -->
                <div id="mgr-tab-history" class="hidden">
                     <div class="input-group"><label>Filter by Date</label><input type="date" id="adm-hist-date" onchange="renderManagerHistory()"></div>
                     <div id="mgr-history-list" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
            </div>
        </div>

        <!-- NEW: BROADCAST MESSAGING (UPDATED) -->
        <div id="view-broadcast" class="hidden">
            <div class="card">
                <h2>Broadcast Message</h2>
                <div class="input-group"><label>Message Type</label>
                    <select id="bc-type">
                        <option value="General">General Announcement</option>
                        <option value="Meeting Scheduled">Meeting Scheduled</option>
                        <option value="Important Message">Important Message</option>
                        <option value="Holiday Notice">Holiday Notice</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Select Recipients</label>
                    <select id="bc-target">
                        <option value="all">All Employees</option>
                    </select>
                </div>
                <div class="input-group"><label>Message Content</label><textarea id="bc-msg" rows="4" placeholder="Type your message here..."></textarea></div>
                
                <!-- EXTERNAL SHARE -->
                <div style="margin-top: 16px; padding-top:16px; border-top: 1px solid var(--border);">
                    <label style="font-size: 0.8rem; color: var(--fg-muted);">Send via External App</label>
                    <div class="flex" style="gap:10px; margin-top:8px;">
                        <button class="btn btn-success" onclick="broadcastToApp('whatsapp')"><i class="fa-brands fa-whatsapp"></i> WhatsApp Group</button>
                        <button class="btn btn-ghost" onclick="broadcastToApp('telegram')"><i class="fa-brands fa-telegram"></i> Telegram</button>
                    </div>
                </div>
                
                <button class="btn btn-accent mt-4" onclick="sendBroadcast()"><i class="fa-solid fa-paper-plane"></i> Send In-App Broadcast</button>
            </div>
        </div>

        <!-- Reports (UPDATED) -->
        <div id="view-reports" class="hidden">
            <div class="card">
                <h2>Attendance Reports</h2>
                <div class="grid grid-2">
                    <div>
                        <label>Report Type</label>
                        <select id="report-type" onchange="toggleReportDate()">
                            <option value="daily">Daily Log</option>
                            <option value="monthly">Monthly Summary</option>
                        </select>
                    </div>
                    <div>
                        <label>Select Date</label>
                        <input type="date" id="report-date">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateReport()"><i class="fa-solid fa-magnifying-glass"></i> Generate Report</button>
                
                <div id="report-preview" class="hidden" style="margin-top: 24px;">
                    <div class="table-container">
                        <table class="report-table" id="report-table-el">
                            <!-- JS -->
                        </table>
                    </div>
                    <div class="flex" style="gap: 10px; margin-top: 16px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="downloadPDF()"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                        <button class="btn btn-success" onclick="shareReport('whatsapp')"><i class="fa-brands fa-whatsapp"></i> WhatsApp</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Map View (Full) -->
        <div id="view-map" class="hidden">
             <div class="card">
                <h2>Live Tracking <span class="badge online">Real-time</span></h2>
                <div id="map-container" style="height: 500px;"></div>
             </div>
        </div>

        <!-- Settings (UPDATED) -->
        <div id="view-settings" class="hidden">
            <div class="card">
                <h2>System Configuration</h2>
                
                <!-- VERSION -->
                <div class="flex" style="justify-content: space-between; align-items: center; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;">
                    <div>
                        <h3 style="margin:0; color:white;">App Version</h3>
                        <p style="font-size:0.8rem; margin:0;">Current: <span id="setting-ver">v2.1</span> | Latest: <span id="setting-latest">v2.1</span></p>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="checkForUpdates()"><i class="fa-solid fa-rotate"></i> Check Update</button>
                </div>

                <h3 style="color: var(--primary); margin-top: 24px;">Database Management</h3>
                <div class="grid grid-2">
                    <button class="btn btn-success" onclick="downloadBackup()"><i class="fa-solid fa-download"></i> Backup Database</button>
                    <button class="btn btn-accent" onclick="document.getElementById('restore-file').click()"><i class="fa-solid fa-upload"></i> Restore Database</button>
                    <input type="file" id="restore-file" style="display:none;" accept=".json" onchange="restoreBackup(this)">
                </div>
                <p class="mt-4" style="font-size:0.75rem; color:var(--fg-muted);">Restoring will overwrite all current data.</p>

                <div style="height: 1px; background: var(--border); margin: 32px 0;"></div>
                
                <h3 style="color: var(--primary);">Cloud Sync (JSONBin)</h3>
                <div class="input-group"><label>Master Key</label><input type="password" id="cfg-master-key" placeholder="$2a$10$..."></div>
                <div class="input-group"><label>Bin ID</label><input type="text" id="cfg-bin-id" placeholder="64b..."></div>
                <button class="btn btn-primary" onclick="saveCloudSettings()"><i class="fa-solid fa-cloud-arrow-up"></i> Save & Connect</button>

                <div style="height: 1px; background: var(--border); margin: 32px 0;"></div>

                <h3 style="color: var(--accent);">ImgBB Integration (Photo Upload)</h3>
                <div class="input-group"><label>ImgBB API Key</label><input type="password" id="cfg-imgbb" placeholder="Enter API Key here..."></div>
                <p class="text-sm text-muted">Used for Employee and Admin profile photo uploads.</p>

                <div style="height: 1px; background: var(--border); margin: 32px 0;"></div>

                <h3 style="color: var(--success);">WhatsApp Automation</h3>
                <div class="input-group"><label>Default Group Link</label><input type="text" id="cfg-wa-checkin" placeholder="https://chat.whatsapp.com/..."></div>
                <div class="input-group"><label>Birthday Group Link</label><input type="text" id="cfg-wa-bday" placeholder="https://chat.whatsapp.com/..."></div>
                <div class="flex" style="gap:10px; margin-bottom: 20px;">
                    <button class="btn btn-sm btn-success" onclick="testWA('checkin')">Test Check-in Msg</button>
                    <button class="btn btn-sm btn-success" onclick="testWA('birthday')">Test Bday Msg</button>
                </div>

                <h3 style="color: var(--primary);">Email Automation</h3>
                <div class="grid grid-2">
                    <div class="input-group"><label>Leave Request To</label><input type="email" id="cfg-email-leave-to"></div>
                    <div class="input-group"><label>Leave Request CC</label><input type="email" id="cfg-email-leave-cc"></div>
                </div>
                <div class="input-group"><label>Leave Subject</label><input type="text" id="cfg-email-leave-sub" value="New Leave Application"></div>
                <div class="input-group"><label>Leave Body</label><textarea id="cfg-email-leave-body" rows="2">Leave application from {name}.</textarea></div>
                <div class="grid grid-2">
                    <div class="input-group"><label>Attendance Alert To</label><input type="email" id="cfg-email-att-to"></div>
                    <div class="input-group"><label>Attendance Alert CC</label><input type="email" id="cfg-email-att-cc"></div>
                </div>

                <div style="height: 1px; background: var(--border); margin: 32px 0;"></div>
                <h3 style="color: #fff;">Admin Profile</h3>
                <div class="text-center" style="margin-bottom: 20px;">
                    <div class="avatar lg" id="admin-settings-avatar" style="margin: 0 auto;">A</div>
                </div>
                <div class="input-group"><label>Admin Name</label><input type="text" id="cfg-admin-name"></div>
                <div class="input-group"><label>Admin Password</label><input type="password" id="cfg-admin-pass" placeholder="New Password"></div>
                <div class="input-group"><label>Profile Photo</label>
                    <div class="flex" style="gap:10px;">
                        <input type="text" id="cfg-admin-photo" placeholder="https://i.ibb.co/..." readonly>
                        <button class="btn btn-sm btn-ghost" onclick="document.getElementById('admin-photo-upload').click()"><i class="fa-solid fa-upload"></i> Upload</button>
                        <input type="file" id="admin-photo-upload" style="display:none;" accept="image/*" onchange="uploadToImgBB(this, 'admin')">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveAdminProfile()">Update Profile</button>
            </div>
        </div>

    </section>

    <!-- EMPLOYEE PANEL -->
    <section id="emp-panel" class="screen hidden">
        <!-- Dashboard -->
        <div id="emp-view-home">
            <div class="card" style="text-align: center;">
                <div class="avatar avatar lg" style="margin: 0 auto 20px; background: linear-gradient(135deg, var(--primary), var(--accent)); border: none;" id="emp-avatar">U</div>
                <h1 id="emp-name-display">User Name</h1>
                <p style="color: var(--fg-muted); margin-bottom: 24px;" id="emp-role-display">Role</p>
                
                <div class="card" style="background: rgba(0,0,0,0.2); padding: 16px; margin-bottom: 30px;">
                    <div id="clock-display" style="font-size: 3.5rem; font-weight: 700; font-family: var(--font-display); color: var(--fg-main); line-height: 1; margin-bottom: 4px;">--:--</div>
                    <div style="color: var(--primary); font-size: 0.9rem; font-weight: 600; letter-spacing: 1px;" id="date-display">DATE</div>
                </div>

                <div class="flex" style="gap:10px; margin-bottom: 20px;">
                    <button id="btn-checkin" class="btn btn-primary" style="flex:1; height: 60px; font-size: 1.1rem; box-shadow: 0 0 20px var(--primary-glow);" onclick="performCheckIn()">
                        <i class="fa-solid fa-location-crosshairs"></i> Check In
                    </button>
                    <button id="btn-checkout" class="btn btn-danger hidden" style="flex:1; height: 60px; font-size: 1.1rem;" onclick="performCheckOut()">
                        <i class="fa-solid fa-person-walking-arrow-right"></i> Check Out
                    </button>
                </div>
                
                <button class="btn btn-ghost btn-sm" onclick="generateCalendarEvent()" style="margin-bottom:20px;">
                    <i class="fa-solid fa-calendar-plus"></i> Add Daily Check-in to Calendar
                </button>

                <div id="att-status" class="hidden" style="margin-top: 20px; padding: 12px; background: rgba(34, 197, 94, 0.1); border-radius: 8px; border: 1px solid var(--success); color: var(--success);">
                    <i class="fa-solid fa-check-circle"></i> Checked In at <span id="checkin-time" style="font-weight: 700;"></span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <h2>Quick Actions</h2>
                <div class="grid grid-2">
                    <button class="btn btn-ghost" onclick="openModal('advModal')"><i class="fa-solid fa-money-bill-wave" style="color: var(--accent);"></i> Advance</button>
                    <button class="btn btn-ghost" onclick="openModal('leaveModal')"><i class="fa-regular fa-calendar-check" style="color: var(--primary);"></i> Leave</button>
                </div>
            </div>

            <!-- My Requests -->
            <div class="card">
                <h2>My Requests</h2>
                <div id="my-req-list"></div>
            </div>
        </div>

        <!-- Call Report -->
        <div id="emp-view-call" class="hidden">
            <div class="card">
                <h2>Field Report Upload</h2>
                <div class="input-group"><label>Complaint/Job #</label><input type="text" id="call-comp"></div>
                <div class="input-group"><label>Date</label><input type="date" id="call-date"></div>
                <div class="input-group"><label>Remarks</label><textarea id="call-remarks" rows="3"></textarea></div>
                <div class="input-group">
                    <label>Attachment</label>
                    <div class="flex" style="gap:10px;">
                        <input type="file" id="call-file" accept=".pdf, .jpg, .jpeg, .png" style="flex:1;">
                        <button class="btn btn-primary" style="width: auto;" onclick="uploadDrive()"><i class="fa-brands fa-google-drive"></i> Upload</button>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>History</h2>
                <div id="my-call-list"></div>
            </div>
        </div>

        <!-- Profile / Regularization (UPDATED) -->
        <div id="emp-view-profile" class="hidden">
            <div class="card">
                <h2>My Profile</h2>
                <div class="flex" style="gap:10px; align-items:center; margin-bottom: 20px;">
                    <div class="avatar lg" id="edit-emp-avatar-preview">U</div>
                    <div>
                        <h3 id="edit-emp-name-display">Name</h3>
                        <p style="font-size:0.8rem;">You can update your details below.</p>
                    </div>
                </div>
                <div class="input-group"><label>Full Name</label><input type="text" id="edit-emp-name"></div>
                <div class="grid grid-2">
                    <div class="input-group"><label>Phone (WhatsApp)</label><input type="text" id="edit-emp-phone"></div>
                    <div class="input-group"><label>Birthday</label><input type="date" id="edit-emp-dob"></div>
                </div>
                <div class="input-group">
                    <label>Email (Gmail)</label>
                    <div class="flex" style="gap:5px;">
                        <input type="email" id="edit-emp-email" placeholder="user@gmail.com">
                        <select id="edit-emp-email-type" style="width: auto;">
                            <option value="Official">Official</option>
                            <option value="Personal">Personal</option>
                        </select>
                    </div>
                </div>
                <div class="input-group">
                    <label>Profile Photo</label>
                    <div class="flex" style="gap:5px;">
                        <input type="text" id="edit-emp-photo" placeholder="URL will appear here..." readonly>
                        <button class="btn btn-sm btn-ghost" onclick="document.getElementById('emp-photo-upload').click()"><i class="fa-solid fa-upload"></i> Upload</button>
                        <input type="file" id="emp-photo-upload" style="display:none;" accept="image/*" onchange="uploadToImgBB(this, 'employee')">
                    </div>
                </div>
                <div class="input-group"><label>New Password</label><input type="password" id="edit-emp-pass" placeholder="Leave blank to keep current"></div>
                <button class="btn btn-primary" onclick="saveEmployeeProfile()">Save Changes</button>
            </div>

            <div class="card">
                <h2>Regularize Attendance</h2>
                <p style="font-size:0.8rem; color:var(--fg-muted); margin-bottom:20px;">Forgot to check in? Add a backdated entry here.</p>
                <div class="input-group"><label>Date</label><input type="date" id="reg-date"></div>
                <div class="grid grid-2">
                    <div class="input-group"><label>Check In</label><input type="time" id="reg-in" value="09:30"></div>
                    <div class="input-group"><label>Check Out</label><input type="time" id="reg-out" value="18:30"></div>
                </div>
                <div class="input-group"><label>Reason</label><textarea id="reg-reason" rows="2"></textarea></div>
                <button class="btn btn-warning" onclick="submitRegularization()">Submit Request</button>
            </div>
        </div>

        <!-- Drive -->
        <div id="emp-view-drive" class="hidden">
            <div class="card">
                <h2>Company Drive</h2>
                <div id="drive-browser" class="grid" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));"></div>
            </div>
        </div>

        <!-- Chat (UPDATED) -->
        <div id="emp-view-chat" class="hidden">
            <div class="card" style="padding: 0; height: calc(100vh - 180px); overflow: hidden;">
                <div class="chat-layout">
                    <div class="chat-sidebar" id="chat-sidebar">
                        <div class="chat-header">
                            <span>Messages</span>
                            <button class="btn btn-sm btn-primary" onclick="startNewChat('admin')"><i class="fa-solid fa-plus"></i> Admin</button>
                        </div>
                        <div id="contact-list" style="overflow-y: auto; flex: 1;"></div>
                    </div>
                    <div class="chat-main" id="chat-main">
                        <div class="chat-header">
                            <div class="flex items-center gap-2">
                                <button class="btn btn-sm btn-ghost hidden" id="chat-back" onclick="toggleChatView(false)" style="width:30px; padding:0;"><i class="fa-solid fa-arrow-left"></i></button>
                                <div id="chat-title" style="font-size: 0.95rem;">Select a chat</div>
                            </div>
                            <!-- Chat Actions (Share) -->
                            <div id="chat-actions" class="hidden">
                                <div class="flex" style="gap:5px;">
                                    <button class="btn btn-sm btn-success btn-icon" title="Share via WhatsApp" onclick="shareChatViaApp('whatsapp')"><i class="fa-brands fa-whatsapp"></i></button>
                                    <button class="btn btn-sm btn-ghost btn-icon" title="Share via Telegram" onclick="shareChatViaApp('telegram')"><i class="fa-brands fa-telegram"></i></button>
                                    <button class="btn btn-sm btn-ghost btn-icon" title="Share via System" onclick="shareChatViaApp('native')"><i class="fa-solid fa-share-nodes"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="chat-messages" id="message-container">
                            <div class="text-center" style="margin-top: 50px; color: var(--fg-muted); opacity: 0.5;">Select a chat to start messaging</div>
                        </div>
                        <div class="chat-input-area">
                            <select id="msg-category" style="width: auto; padding: 8px; border-radius: 8px; font-size: 0.8rem;">
                                <option value="General">General</option>
                                <option value="DCI Servicing">DCI Servicing</option>
                                <option value="Meeting">Meeting</option>
                                <option value="Urgent">Urgent</option>
                            </select>
                            <input type="text" id="msg-input" placeholder="Type a message..." style="flex:1;" onkeypress="if(event.key==='Enter') sendMessage()">
                            <button class="btn btn-primary" style="width: auto; border-radius: 50%; width: 44px; height: 44px; padding: 0;" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: AI Help Chat -->
        <div id="emp-view-help" class="hidden">
            <div class="card" style="height: calc(100vh - 180px); display: flex; flex-direction: column;">
                <div class="chat-header">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-robot" style="color: var(--accent);"></i>
                        <span>Nexus AI Assistant</span>
                    </div>
                </div>
                <div class="chat-messages" id="ai-message-container">
                    <div class="message-bubble msg-received ai-bubble">
                        Hello! I am Nexus AI. I can help you with attendance, leaves, or connect you to the Admin. Try asking "How to check in?" or "Contact Admin".
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" id="ai-input" placeholder="Ask AI anything..." style="flex:1;" onkeypress="if(event.key==='Enter') sendAIMessage()">
                    <button class="btn btn-accent" style="width: auto; border-radius: 50%; width: 44px; height: 44px; padding: 0;" onclick="sendAIMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

    </section>

    <!-- ADMIN NAV -->
    <nav id="admin-nav" class="nav-dock hidden">
        <button class="nav-btn active" onclick="switchAdminTab('dashboard')"><i class="fa-solid fa-chart-pie"></i></button>
        <button class="nav-btn" onclick="switchAdminTab('company')"><i class="fa-solid fa-building"></i></button>
        <button class="nav-btn" onclick="switchAdminTab('team')"><i class="fa-solid fa-users"></i></button>
        <button class="nav-btn" onclick="switchAdminTab('pending')"><i class="fa-solid fa-file-invoice"></i></button>
        <button class="nav-btn" onclick="switchAdminTab('manager')"><i class="fa-solid fa-clock-rotate-left"></i></button>
        <button class="nav-btn" onclick="switchAdminTab('broadcast')"><i class="fa-solid fa-bullhorn"></i></button>
        <button class="nav-btn" onclick="switchAdminTab('reports')"><i class="fa-solid fa-table"></i></button>
        <button class="nav-btn" onclick="switchAdminTab('map')"><i class="fa-solid fa-map-location-dot"></i></button>
        <button class="nav-btn" onclick="switchAdminTab('settings')"><i class="fa-solid fa-gears"></i></button>
        <button class="nav-btn exit" onclick="logout()"><i class="fa-solid fa-power-off"></i></button>
    </nav>

    <!-- EMP NAV -->
    <nav id="emp-nav" class="nav-dock hidden">
        <button class="nav-btn active" onclick="switchEmpTab('home')"><i class="fa-solid fa-house"></i></button>
        <button class="nav-btn" onclick="switchEmpTab('call')"><i class="fa-solid fa-file-upload"></i></button>
        <button class="nav-btn" onclick="switchEmpTab('profile')"><i class="fa-solid fa-user-gear"></i></button>
        <button class="nav-btn" onclick="switchEmpTab('drive')"><i class="fa-brands fa-google-drive"></i></button>
        <button class="nav-btn" onclick="switchEmpTab('chat')"><i class="fa-solid fa-comments"></i></button>
        <button class="nav-btn" style="color:var(--accent);" onclick="switchEmpTab('help')"><i class="fa-solid fa-robot"></i></button>
        <button class="nav-btn exit" onclick="logout()"><i class="fa-solid fa-power-off"></i></button>
    </nav>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- MODALS -->
    <!-- Company Modal -->
    <div id="companyModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Add Company</h2>
            <div class="input-group"><label>Name</label><input type="text" id="comp-name"></div>
            <div class="flex" style="justify-content: flex-end; gap:10px; margin-top:20px;">
                <button class="btn btn-ghost" onclick="closeModal('companyModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addCompany()">Add Company</button>
            </div>
        </div>
    </div>

    <!-- Employee Modal -->
    <div id="empModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Add Employee</h2>
            <div class="input-group"><label>Name</label><input type="text" id="new-emp-name"></div>
            <div class="input-group"><label>ID</label><input type="text" id="new-emp-id"></div>
            <div class="input-group"><label>Password</label><input type="text" id="new-emp-pass"></div>
            <div class="input-group">
                <label>Email (Gmail)</label>
                <div class="flex" style="gap:5px;">
                    <input type="email" id="new-emp-email" placeholder="user@gmail.com">
                    <select id="new-emp-email-type" style="width: auto;">
                        <option value="Official">Official</option>
                        <option value="Personal">Personal</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-2">
                <div class="input-group"><label>Phone</label><input type="text" id="new-emp-phone"></div>
                <div class="input-group"><label>Birthday</label><input type="date" id="new-emp-dob"></div>
            </div>
            <div class="input-group">
                <label>Profile Photo</label>
                <div class="flex" style="gap:5px;">
                    <input type="text" id="new-emp-photo" placeholder="Upload or paste URL..." readonly>
                    <button class="btn btn-sm btn-ghost" onclick="document.getElementById('new-emp-photo-upload').click()"><i class="fa-solid fa-upload"></i> Upload</button>
                    <input type="file" id="new-emp-photo-upload" style="display:none;" accept="image/*" onchange="uploadToImgBB(this, 'new-employee')">
                </div>
            </div>
            <div class="input-group"><label>Company</label><select id="new-emp-comp"></select></div>
            <div class="flex" style="justify-content: flex-end; gap:10px; margin-top:20px;">
                <button class="btn btn-ghost" onclick="closeModal('empModal')">Cancel</button>
                <button class="btn btn-primary" onclick="addEmployee()">Add Employee</button>
            </div>
        </div>
    </div>

    <!-- Edit Employee Modal (Admin) -->
    <div id="editEmpModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Edit Employee</h2>
            <input type="hidden" id="edit-emp-hidden-id">
            <div class="input-group"><label>Name</label><input type="text" id="admin-edit-emp-name"></div>
            <div class="input-group"><label>New Password</label><input type="text" id="admin-edit-emp-pass" placeholder="Leave blank to keep"></div>
            <div class="input-group">
                <label>Email (Gmail)</label>
                <div class="flex" style="gap:5px;">
                    <input type="email" id="admin-edit-emp-email" placeholder="user@gmail.com">
                    <select id="admin-edit-emp-email-type" style="width: auto;">
                        <option value="Official">Official</option>
                        <option value="Personal">Personal</option>
                    </select>
                </div>
            </div>
            <div class="grid grid-2">
                <div class="input-group"><label>Phone</label><input type="text" id="admin-edit-emp-phone"></div>
                <div class="input-group"><label>Birthday</label><input type="date" id="admin-edit-emp-dob"></div>
            </div>
            <div class="input-group">
                <label>Profile Photo</label>
                <div class="flex" style="gap:5px;">
                    <input type="text" id="admin-edit-emp-photo" placeholder="Upload or paste URL..." readonly>
                    <button class="btn btn-sm btn-ghost" onclick="document.getElementById('admin-edit-emp-photo-upload').click()"><i class="fa-solid fa-upload"></i> Upload</button>
                    <input type="file" id="admin-edit-emp-photo-upload" style="display:none;" accept="image/*" onchange="uploadToImgBB(this, 'edit-employee')">
                </div>
            </div>
            <div class="input-group"><label>Company</label><select id="admin-edit-emp-comp"></select></div>
            <div class="flex" style="justify-content: flex-end; gap:10px; margin-top:20px;">
                <button class="btn btn-ghost" onclick="closeModal('editEmpModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveAdminEditEmployee()">Update</button>
            </div>
        </div>
    </div>

    <!-- Advance Modal -->
    <div id="advModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Request Advance</h2>
            <div class="input-group"><label>Amount</label><input type="number" id="req-amt"></div>
            <div class="input-group"><label>Reason</label><textarea id="req-reason"></textarea></div>
            <div class="flex" style="justify-content: flex-end; gap:10px; margin-top:20px;">
                <button class="btn btn-ghost" onclick="closeModal('advModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitReq('advance')">Submit</button>
            </div>
        </div>
    </div>

    <!-- Leave Modal -->
    <div id="leaveModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Apply Leave</h2>
            <div class="input-group"><label>Type</label><select id="req-type"><option>Sick</option><option>Casual</option></select></div>
            <div class="grid grid-2">
                <div class="input-group"><label>Start</label><input type="date" id="req-start"></div>
                <div class="input-group"><label>End</label><input type="date" id="req-end"></div>
            </div>
            <div class="flex" style="justify-content: flex-end; gap:10px; margin-top:20px;">
                <button class="btn btn-ghost" onclick="closeModal('leaveModal')">Cancel</button>
                <button class="btn btn-primary" onclick="submitReq('leave')">Submit</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const DEFAULT_DB = {
            admin: { id: 'admin', pass: 'admin', name: 'Super Admin', photo: '' },
            companies: [],
            employees: [],
            attendance: [],
            requests: [],
            calls: [],
            chats: [],
            messages: [],
            settings: {
                masterKey: '', binId: '', imgbb: '',
                waCheckin: '', waBday: '',
                leaveTo: '', leaveCc: '', leaveSub: '', leaveBody: '',
                attTo: '', attCc: ''
            }
        };

        let APP = {
            user: null, role: null, db: null, map: null, activeChatId: null
        };

        // --- INIT ---
        window.onload = () => {
            loadData();
            startClock();
            requestBgPermission();
            detectAdminDevice();
        };

        // --- DATA LAYER ---
        function loadData() {
            const local = localStorage.getItem('nexus_hr_final');
            if(local) APP.db = JSON.parse(local);
            else APP.db = JSON.parse(JSON.stringify(DEFAULT_DB));

            // Ensure Admin credentials are default at load
            APP.db.admin.id = 'admin';
            APP.db.admin.pass = 'admin';

            if(APP.db.settings.binId && APP.db.settings.masterKey) {
                syncFromCloud();
            } else {
                updateCloudStatus('Local');
                renderUI(); 
            }
        }

        function saveData() {
            localStorage.setItem('nexus_hr_final', JSON.stringify(APP.db));
            syncToCloud(); 
        }

        function syncToCloud() {
            if(!APP.db.settings.binId || !APP.db.settings.masterKey) return;
            fetch(`https://api.jsonbin.io/v3/b/${APP.db.settings.binId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': APP.db.settings.masterKey },
                body: JSON.stringify(APP.db)
            }).then(() => updateCloudStatus('Cloud Synced')).catch(() => updateCloudStatus('Sync Error'));
        }

        function syncFromCloud() {
            updateCloudStatus('Syncing...');
            fetch(`https://api.jsonbin.io/v3/b/${APP.db.settings.binId}/latest`, {
                headers: { 'X-Master-Key': APP.db.settings.masterKey }
            })
            .then(res => res.ok ? res.json() : Promise.reject())
            .then(data => { APP.db = { ...DEFAULT_DB, ...data.record }; saveData(); updateCloudStatus('Cloud Synced'); renderUI(); })
            .catch(() => { updateCloudStatus('Sync Error'); renderUI(); });
        }

        // --- BACKUP / RESTORE ---
        function downloadBackup() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(APP.db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "nexus_hr_backup_" + new Date().toISOString().split('T')[0] + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function restoreBackup(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.employees && json.admin) {
                        APP.db = json;
                        saveData();
                        showToast('Database Restored Successfully');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('Invalid Database File', 'error');
                    }
                } catch(err) { showToast('Error parsing file', 'error'); }
            };
            reader.readAsText(file);
        }

        // --- IMGBB UPLOAD LOGIC ---
        function uploadToImgBB(input, target) {
            const file = input.files[0];
            if (!file) return;

            if (!APP.db.settings.imgbb) {
                alert("Please configure the ImgBB API Key in Settings first.");
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            showToast('Uploading Image...', 'info');

            fetch('https://api.imgbb.com/1/upload?key=' + APP.db.settings.imgbb, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    const url = data.data.url;
                    showToast('Image Uploaded Successfully', 'success');
                    
                    if(target === 'admin') {
                        document.getElementById('cfg-admin-photo').value = url;
                    } else if (target === 'employee') {
                        document.getElementById('edit-emp-photo').value = url;
                        document.getElementById('edit-emp-avatar-preview').innerHTML = `<img src="${url}" style="width:100%; height:100%; object-fit:cover;">`;
                    } else if (target === 'new-employee') {
                        document.getElementById('new-emp-photo').value = url;
                    } else if (target === 'edit-employee') {
                        document.getElementById('admin-edit-emp-photo').value = url;
                    }
                } else {
                    showToast('Upload Failed', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Upload Error', 'error');
            });
        }

        // --- ADMIN DEVICE DETECTION ---
        function detectAdminDevice() {
            const isSuperAdminDevice = localStorage.getItem('nexus_super_device') === 'true';
            if(isSuperAdminDevice) {
                console.log("Super Admin Device Detected. Auto-Sync Enabled.");
                if(APP.db.settings.masterKey) syncFromCloud();
            }
        }

        function markSuperAdminDevice() {
            localStorage.setItem('nexus_super_device', 'true');
            showToast('Device marked as Super Admin. Auto-sync enabled.');
        }

        // --- AUTH ---
        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            // Force check against default admin credentials for safety
            if(u === 'admin' && p === 'admin') {
                postLogin('admin', APP.db.admin);
            } else {
                const emp = APP.db.employees.find(x => x.id === u && x.pass === p);
                if(emp) {
                    if(emp.email && emp.email.includes('@')) {
                        console.log("Email Verified logic placeholder.");
                    }
                    postLogin('emp', emp);
                }
                else showToast('Invalid Credentials', 'error');
            }
        }

        function postLogin(role, user) {
            APP.user = user;
            APP.role = role;
            document.getElementById('login-screen').classList.add('hidden');
            
            if(role === 'admin') {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-nav').classList.remove('hidden');
                switchAdminTab('dashboard');
                setTimeout(initMap, 500);
            } else {
                document.getElementById('emp-panel').classList.remove('hidden');
                document.getElementById('emp-nav').classList.remove('hidden');
                switchEmpTab('home');
                updateEmpDashboard();
                renderMyReqs();
                renderMyCalls();
                loadChatContacts();
            }
            showNotification(`Welcome back, ${user.name}`, 'success');
        }

        function logout() { location.reload(); }

        function renderUI() {
            if(APP.role === 'admin' && document.getElementById('admin-panel').offsetParent !== null) {
                updateDashboard();
            }
        }

        // --- NAVIGATION ---
        function switchAdminTab(tab) {
            document.querySelectorAll('#admin-panel > div').forEach(el => el.classList.add('hidden'));
            document.getElementById('view-' + tab).classList.remove('hidden');
            
            const btns = document.querySelectorAll('#admin-nav .nav-btn');
            btns.forEach(b => b.classList.remove('active'));
            const idx = ['dashboard','company','team','pending','manager','broadcast','reports','map','settings'].indexOf(tab);
            if(idx > -1) btns[idx].classList.add('active');

            if(tab === 'dashboard') updateDashboard();
            if(tab === 'team') renderTeam();
            if(tab === 'company') renderCompanies();
            if(tab === 'pending') renderPending();
            if(tab === 'manager') loadAttendanceManager();
            if(tab === 'broadcast') loadBroadcastRecipients();
            if(tab === 'reports') generateReport();
            if(tab === 'map') setTimeout(initMap, 100);
            if(tab === 'settings') loadSettings();
        }

        function switchEmpTab(tab) {
            document.querySelectorAll('#emp-panel > div').forEach(el => el.classList.add('hidden'));
            document.getElementById('emp-view-' + tab).classList.remove('hidden');
            
            const btns = document.querySelectorAll('#emp-nav .nav-btn');
            btns.forEach(b => b.classList.remove('active'));
            const idx = ['home','call','profile','drive','chat','help'].indexOf(tab);
            if(idx > -1) btns[idx].classList.add('active');

            if(tab === 'drive') loadDriveFiles();
            if(tab === 'chat') loadChatContacts();
        }

        // --- ADMIN LOGIC ---
        function updateDashboard() {
            document.getElementById('adm-stat-emp').textContent = APP.db.employees.length;
            document.getElementById('adm-stat-req').textContent = APP.db.requests.filter(r => r.status === 'Pending').length;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('adm-stat-pres').textContent = APP.db.attendance.filter(a => a.date === today).length;
        }

        function renderCompanies() {
            const list = document.getElementById('company-list');
            list.innerHTML = APP.db.companies.map(c => `
                <div class="list-item">
                    <div class="list-content"><h4>${c.name}</h4><p>ID: ${c.id}</p></div>
                    <button class="btn btn-sm btn-danger" onclick="deleteCompany('${c.id}')"><i class="fa-solid fa-trash"></i></button>
                </div>
            `).join('') || '<div class="text-center p-4 text-muted">No companies.</div>';
        }

        function addCompany() {
            const name = document.getElementById('comp-name').value;
            if(!name) return showToast('Name required', 'error');
            APP.db.companies.push({ id: Date.now().toString(), name });
            saveData(); closeModal('companyModal'); renderCompanies(); showToast('Company Added');
        }
        
        function deleteCompany(id) {
            if(!confirm('Delete company?')) return;
            APP.db.companies = APP.db.companies.filter(c => c.id !== id);
            saveData(); renderCompanies();
        }

        function renderTeam() {
            const list = document.getElementById('team-list');
            const compSelect = document.getElementById('new-emp-comp');
            const editCompSelect = document.getElementById('admin-edit-emp-comp');
            const options = APP.db.companies.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            compSelect.innerHTML = options;
            if(editCompSelect) editCompSelect.innerHTML = options;

            list.innerHTML = APP.db.employees.map(e => `
                <div class="list-item">
                    <div class="flex" style="align-items:center; gap:12px;">
                        <div class="avatar">${e.photo ? `<img src="${e.photo}">` : e.name.charAt(0)}</div>
                        <div class="list-content">
                            <h4>${e.name} <span class="badge pending">${e.comp || 'N/A'}</span></h4>
                            <p>ID: ${e.id} | Phone: ${e.phone} | ${e.email || ''}</p>
                        </div>
                    </div>
                    <div class="flex" style="gap:5px;">
                        <button class="btn btn-sm btn-ghost" onclick="openEditEmpModal('${e.id}')"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEmp('${e.id}')"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('') || '<div class="text-center p-4 text-muted">No employees.</div>';
        }

        function addEmployee() {
            const name = document.getElementById('new-emp-name').value;
            const id = document.getElementById('new-emp-id').value;
            const pass = document.getElementById('new-emp-pass').value;
            const email = document.getElementById('new-emp-email').value;
            const emailType = document.getElementById('new-emp-email-type').value;
            if(!name || !id || !pass) return showToast('Name, ID & Password required', 'error');

            APP.db.employees.push({
                id, pass, name, email, emailType,
                photo: document.getElementById('new-emp-photo').value, 
                comp: document.getElementById('new-emp-comp').value,
                phone: document.getElementById('new-emp-phone').value,
                dob: document.getElementById('new-emp-dob').value
            });
            saveData(); closeModal('empModal'); renderTeam(); showToast('Employee Added');
        }

        function deleteEmp(id) {
            if(!confirm('Delete Employee?')) return;
            APP.db.employees = APP.db.employees.filter(e => e.id !== id);
            saveData(); renderTeam();
        }

        function openEditEmpModal(id) {
            const emp = APP.db.employees.find(e => e.id === id);
            if(!emp) return;
            document.getElementById('edit-emp-hidden-id').value = id;
            document.getElementById('admin-edit-emp-name').value = emp.name;
            document.getElementById('admin-edit-emp-pass').value = ''; 
            document.getElementById('admin-edit-emp-email').value = emp.email || '';
            document.getElementById('admin-edit-emp-email-type').value = emp.emailType || 'Official';
            document.getElementById('admin-edit-emp-comp').value = emp.comp || '';
            document.getElementById('admin-edit-emp-phone').value = emp.phone || '';
            document.getElementById('admin-edit-emp-dob').value = emp.dob || '';
            document.getElementById('admin-edit-emp-photo').value = emp.photo || '';
            openModal('editEmpModal');
        }

        function saveAdminEditEmployee() {
            const id = document.getElementById('edit-emp-hidden-id').value;
            const emp = APP.db.employees.find(e => e.id === id);
            if(emp) {
                emp.name = document.getElementById('admin-edit-emp-name').value;
                emp.comp = document.getElementById('admin-edit-emp-comp').value;
                emp.phone = document.getElementById('admin-edit-emp-phone').value;
                emp.email = document.getElementById('admin-edit-emp-email').value;
                emp.emailType = document.getElementById('admin-edit-emp-email-type').value;
                emp.dob = document.getElementById('admin-edit-emp-dob').value;
                emp.photo = document.getElementById('admin-edit-emp-photo').value;
                const newPass = document.getElementById('admin-edit-emp-pass').value;
                if(newPass) emp.pass = newPass;
                saveData(); closeModal('editEmpModal'); renderTeam(); showToast('Employee Updated');
            }
        }

        function renderPending() {
            const list = document.getElementById('pending-list');
            const pending = APP.db.requests.filter(r => r.status === 'Pending');
            
            list.innerHTML = pending.map(r => `
                <div class="list-item">
                    <div class="list-content">
                        <h4>${r.empName} <span class="badge" style="background:rgba(255,255,255,0.1); color:white;">${r.type}</span></h4>
                        <p>${r.type === 'Advance' ? 'Amount: '+r.detail : 'Date: '+r.detail}</p>
                    </div>
                    <div class="flex" style="gap:8px;">
                        <button class="btn btn-sm btn-success" onclick="processReq(${r.id}, 'Approved')"><i class="fa-solid fa-check"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="processReq(${r.id}, 'Rejected')"><i class="fa-solid fa-xmark"></i></button>
                        <button class="btn btn-sm btn-ghost" title="Delete Request" onclick="deleteReq(${r.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('') || '<div class="text-center p-4 text-muted">No pending requests.</div>';
        }

        function processReq(id, status) {
            const req = APP.db.requests.find(r => r.id === id);
            if(req) { 
                req.status = status; 
                if(status === 'Approved') sendAutoEmail(req);
                saveData(); renderPending(); showToast(`Request ${status}`); 
            }
        }

        function sendAutoEmail(req) {
            if(req.type === 'Leave' && APP.db.settings.leaveTo) {
                console.log(`Sending Leave Email to ${APP.db.settings.leaveTo}`);
                showToast(`Email notification sent to ${APP.db.settings.leaveTo}`);
            }
        }

        function deleteReq(id) {
            if(!confirm('Delete this request?')) return;
            APP.db.requests = APP.db.requests.filter(r => r.id !== id);
            saveData(); renderPending(); showToast('Request Deleted');
        }

        // --- BROADCAST MESSAGING (UPDATED) ---
        function loadBroadcastRecipients() {
            const select = document.getElementById('bc-target');
            select.innerHTML = '<option value="all">All Employees</option>' + 
                APP.db.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        }

        function sendBroadcast() {
            const target = document.getElementById('bc-target').value;
            const msg = document.getElementById('bc-msg').value;
            const type = document.getElementById('bc-type').value;
            
            if(!msg) return showToast('Message cannot be empty', 'error');

            let recipients = [];
            if(target === 'all') {
                recipients = APP.db.employees.map(e => e.id);
            } else {
                recipients = [target];
            }

            recipients.forEach(empId => {
                const participants = ['admin', empId].sort();
                const chatId = participants.join('-');
                let chat = APP.db.chats.find(c => c.id === chatId);
                if(!chat) { chat = { id: chatId, participants: participants }; APP.db.chats.push(chat); }
                
                APP.db.messages.push({
                    id: Date.now() + Math.random(),
                    chatId: chatId,
                    senderId: 'admin',
                    category: type,
                    text: msg,
                    timestamp: new Date().toISOString()
                });
            });

            saveData();
            document.getElementById('bc-msg').value = '';
            showToast('Broadcast Sent Successfully');
        }

        function broadcastToApp(app) {
            const msg = document.getElementById('bc-msg').value;
            const link = app === 'whatsapp' ? APP.db.settings.waCheckin : ''; 
            if(!msg) return showToast('Message is empty', 'error');
            
            let url = "";
            const text = `${document.getElementById('bc-type').value}: ${msg}`;
            
            if(app === 'whatsapp') {
                url = link ? `${link}?text=${encodeURIComponent(text)}` : `https://wa.me/?text=${encodeURIComponent(text)}`;
            } else if(app === 'telegram') {
                url = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`;
            }
            
            window.open(url, '_blank');
        }

        // --- ATTENDANCE MANAGER (ADMIN) ---
        function loadAttendanceManager() {
            const empSelect = document.getElementById('adm-mgr-emp');
            empSelect.innerHTML = '<option value="">Select Employee...</option>' + APP.db.employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            document.getElementById('adm-mgr-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('adm-bulk-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('adm-hist-date').value = new Date().toISOString().split('T')[0];
            renderManagerHistory();
        }

        function switchMgrTab(tab) {
            ['single', 'bulk', 'history'].forEach(t => document.getElementById('mgr-tab-'+t).classList.add('hidden'));
            document.getElementById('mgr-tab-'+tab).classList.remove('hidden');
        }

        function fillRandomCoords() {
            document.getElementById('adm-mgr-lat').value = (19.0760 + (Math.random() * 0.1)).toFixed(6);
            document.getElementById('adm-mgr-lng').value = (72.8777 + (Math.random() * 0.1)).toFixed(6);
        }

        function adminAddAttendance() {
            const empId = document.getElementById('adm-mgr-emp').value;
            const date = document.getElementById('adm-mgr-date').value;
            const status = document.getElementById('adm-mgr-status').value;
            const lat = document.getElementById('adm-mgr-lat').value;
            const lng = document.getElementById('adm-mgr-lng').value;
            
            if(!empId || !date) return showToast('Employee and Date required', 'error');

            const emp = APP.db.employees.find(e => e.id === empId);
            
            APP.db.attendance = APP.db.attendance.filter(a => !(a.empId === empId && a.date === date));

            const record = {
                id: Date.now(),
                empId: empId,
                empName: emp.name,
                date: date,
                status: status,
                inTime: status === 'P' ? document.getElementById('adm-mgr-in').value : '-',
                outTime: status === 'P' ? document.getElementById('adm-mgr-out').value : '-',
                lat: parseFloat(lat) || 0,
                lng: parseFloat(lng) || 0,
                notes: document.getElementById('adm-mgr-notes').value
            };

            APP.db.attendance.push(record);
            saveData(); renderManagerHistory(); showToast('Record Added');
        }

        function bulkMark(status) {
            const date = document.getElementById('adm-bulk-date').value;
            if(!date) return showToast('Date required', 'error');
            if(!confirm(`Mark ALL employees as ${status}?`)) return;

            APP.db.employees.forEach(emp => {
                APP.db.attendance = APP.db.attendance.filter(a => !(a.empId === emp.id && a.date === date));
                APP.db.attendance.push({
                    id: Date.now() + Math.random(),
                    empId: emp.id,
                    empName: emp.name,
                    date: date,
                    status: status,
                    inTime: status === 'P' ? '09:00' : '-',
                    outTime: status === 'P' ? '18:00' : '-',
                    lat: 0, lng: 0, notes: 'Bulk Entry'
                });
            });
            saveData(); showToast('Bulk Update Complete');
        }

        function renderManagerHistory() {
            const date = document.getElementById('adm-hist-date').value;
            const list = document.getElementById('mgr-history-list');
            const records = APP.db.attendance.filter(a => a.date === date);
            
            list.innerHTML = records.map(r => `
                <div class="list-item">
                    <div class="list-content">
                        <h4>${r.empName} <span class="status-cell status-${r.status}">${r.status}</span></h4>
                        <p>${r.inTime} - ${r.outTime}</p>
                    </div>
                    <div class="flex" style="gap:5px;">
                        <button class="btn btn-sm btn-ghost" onclick="deleteAttendance(${r.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('') || '<div class="text-center p-4 text-muted">No records for this date.</div>';
        }

        function deleteAttendance(id) {
            if(!confirm('Delete this record?')) return;
            APP.db.attendance = APP.db.attendance.filter(a => a.id !== id);
            saveData(); renderManagerHistory(); showToast('Record Deleted');
        }

        // --- REPORTS (COLOR CODED) ---
        function generateReport() {
            const type = document.getElementById('report-type').value;
            const dateVal = document.getElementById('report-date').value;
            if(!dateVal) return showToast('Select date', 'error');

            let data = [];
            if(type === 'daily') data = APP.db.attendance.filter(a => a.date === dateVal);
            else data = APP.db.attendance.filter(a => a.date.startsWith(dateVal));

            const allEmps = APP.db.employees;
            const finalData = allEmps.map((emp, idx) => {
                const att = data.find(d => d.empId === emp.id);
                return {
                    sl: idx + 1,
                    name: emp.name,
                    id: emp.id,
                    date: dateVal,
                    status: att ? att.status : 'A',
                    in: att ? att.inTime : '-',
                    out: att ? att.outTime : '-'
                };
            });

            const table = document.getElementById('report-table-el');
            table.innerHTML = `<thead><tr><th>S.No</th><th>Emp Name</th><th>Emp ID</th><th>Date</th><th>Status</th><th>In</th><th>Out</th></tr></thead><tbody>
                ${finalData.map(d => `
                    <tr>
                        <td>${d.sl}</td>
                        <td>${d.name}</td>
                        <td>${d.id}</td>
                        <td>${d.date}</td>
                        <td><span class="status-cell status-${d.status}">${d.status}</span></td>
                        <td>${d.in}</td>
                        <td>${d.out}</td>
                    </tr>
                `).join('')}
            </tbody>`;
            
            document.getElementById('report-preview').classList.remove('hidden');
            showToast('Report Generated');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Nexus HR - Attendance Report", 14, 15);
            doc.autoTable({ html: '#report-table-el', startY: 20 });
            doc.save('report.pdf');
        }

        function shareReport(platform) {
            const text = "Here is the attendance report.";
            if(platform === 'whatsapp') window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function toggleReportDate() {
            document.getElementById('report-date').type = document.getElementById('report-type').value === 'monthly' ? 'month' : 'date';
        }

        // --- SETTINGS ---
        function loadSettings() {
            const s = APP.db.settings;
            document.getElementById('cfg-master-key').value = s.masterKey;
            document.getElementById('cfg-bin-id').value = s.binId;
            document.getElementById('cfg-imgbb').value = s.imgbb || '';
            
            document.getElementById('cfg-wa-checkin').value = s.waCheckin;
            document.getElementById('cfg-wa-bday').value = s.waBday;

            document.getElementById('cfg-email-leave-to').value = s.leaveTo;
            document.getElementById('cfg-email-leave-cc').value = s.leaveCc;
            document.getElementById('cfg-email-leave-sub').value = s.leaveSub;
            document.getElementById('cfg-email-leave-body').value = s.leaveBody;

            document.getElementById('cfg-email-att-to').value = s.attTo;
            document.getElementById('cfg-email-att-cc').value = s.attCc;
            
            document.getElementById('cfg-admin-name').value = APP.db.admin.name;
            document.getElementById('cfg-admin-photo').value = APP.db.admin.photo || '';
            updateAdminAvatarPreview(APP.db.admin.photo);
        }

        function saveCloudSettings() {
            APP.db.settings.masterKey = document.getElementById('cfg-master-key').value;
            APP.db.settings.binId = document.getElementById('cfg-bin-id').value;
            APP.db.settings.imgbb = document.getElementById('cfg-imgbb').value;
            saveData(); showToast('Settings Saved'); syncFromCloud();
        }

        function saveAdminProfile() {
            const name = document.getElementById('cfg-admin-name').value;
            const pass = document.getElementById('cfg-admin-pass').value;
            const photo = document.getElementById('cfg-admin-photo').value;
            if(name) APP.db.admin.name = name;
            if(pass) APP.db.admin.pass = pass;
            if(photo) APP.db.admin.photo = photo;
            saveData(); showToast('Admin Profile Updated'); updateAdminAvatarPreview(photo);
        }

        function updateAdminAvatarPreview(url) {
            const el = document.getElementById('admin-settings-avatar');
            el.innerHTML = url ? `<img src="${url}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">` : 'A';
        }

        function updateCloudStatus(status) {
            const el = document.getElementById('cloud-status');
            el.textContent = status;
            el.className = 'badge ' + (status === 'Cloud Synced' ? 'online' : (status === 'Sync Error' ? 'rejected' : 'pending'));
        }

        function manualSync() { syncFromCloud(); showToast('Sync Triggered', 'info'); }

        function testWA(type) {
            const link = type === 'checkin' ? APP.db.settings.waCheckin : APP.db.settings.waBday;
            if(!link) return showToast('Group Link not set', 'error');
            const msg = type === 'checkin' ? "Reminder: Please Check In now." : "Happy Birthday! ðŸŽ‚";
            window.open(`${link}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function checkForUpdates() {
            document.getElementById('setting-latest').textContent = 'v2.2';
            showToast('A new version (v2.2) is available!', 'info');
        }

        // --- EMPLOYEE LOGIC ---
        function updateEmpDashboard() {
            document.getElementById('emp-name-display').textContent = APP.user.name;
            document.getElementById('emp-role-display').textContent = APP.user.comp || 'Employee';
            
            const avatarEl = document.getElementById('emp-avatar');
            avatarEl.innerHTML = APP.user.photo ? `<img src="${APP.user.photo}">` : APP.user.name.charAt(0).toUpperCase();
        }

        function saveEmployeeProfile() {
            const name = document.getElementById('edit-emp-name').value;
            const phone = document.getElementById('edit-emp-phone').value;
            const dob = document.getElementById('edit-emp-dob').value;
            const email = document.getElementById('edit-emp-email').value;
            const emailType = document.getElementById('edit-emp-email-type').value;
            const photo = document.getElementById('edit-emp-photo').value;
            const pass = document.getElementById('edit-emp-pass').value;

            if(name) APP.user.name = name;
            if(phone) APP.user.phone = phone;
            if(dob) APP.user.dob = dob;
            if(email) { APP.user.email = email; APP.user.emailType = emailType; }
            if(photo) APP.user.photo = photo;
            if(pass) APP.user.pass = pass;
            
            const idx = APP.db.employees.findIndex(e => e.id === APP.user.id);
            if(idx > -1) APP.db.employees[idx] = APP.user;
            
            saveData(); updateEmpDashboard(); showToast('Profile Updated');
        }

        function performCheckIn() {
            if(!navigator.geolocation) return showToast('GPS not supported', 'error');
            const btn = document.getElementById('btn-checkin');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Locating...';
            
            navigator.geolocation.getCurrentPosition(pos => {
                const now = new Date();
                APP.db.attendance.push({
                    id: Date.now(),
                    empId: APP.user.id, empName: APP.user.name,
                    date: now.toISOString().split('T')[0],
                    status: 'P',
                    inTime: now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}),
                    lat: pos.coords.latitude, lng: pos.coords.longitude,
                    outTime: null
                });
                saveData();
                document.getElementById('btn-checkin').classList.add('hidden');
                document.getElementById('btn-checkout').classList.remove('hidden');
                document.getElementById('att-status').classList.remove('hidden');
                document.getElementById('checkin-time').textContent = APP.db.attendance[APP.db.attendance.length-1].inTime;
                showToast('Checked In');
            }, () => { btn.innerHTML = 'Check In'; showToast('Location Denied', 'error'); });
        }

        function performCheckOut() {
            const today = new Date().toISOString().split('T')[0];
            const record = APP.db.attendance.find(a => a.empId === APP.user.id && a.date === today && !a.outTime);
            if(record) {
                record.outTime = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                saveData(); showToast('Checked Out'); location.reload();
            }
        }

        function submitReq(type) {
            const req = {
                id: Date.now(),
                empId: APP.user.id, empName: APP.user.name,
                type: type.charAt(0).toUpperCase() + type.slice(1),
                status: 'Pending',
                date: new Date().toISOString().split('T')[0]
            };
            
            if(type === 'advance') {
                req.detail = document.getElementById('req-amt').value;
                if(!req.detail) return showToast('Amount required', 'error');
            } else {
                const s = document.getElementById('req-start').value;
                const e = document.getElementById('req-end').value;
                if(!s) return showToast('Date required', 'error');
                req.detail = `${s} to ${e}`;
            }

            APP.db.requests.push(req);
            saveData();
            closeModal(type === 'advance' ? 'advModal' : 'leaveModal');
            renderMyReqs();
            showToast('Request Submitted');
        }

        function renderMyReqs() {
            const list = document.getElementById('my-req-list');
            const my = APP.db.requests.filter(r => r.empId === APP.user.id).reverse();
            list.innerHTML = my.map(r => `
                <div class="list-item">
                    <div class="list-content">
                        <h4>${r.type}</h4>
                        <p>${r.detail}</p>
                    </div>
                    <div class="flex" style="gap:5px; align-items:center;">
                        <span class="badge ${r.status.toLowerCase()}">${r.status}</span>
                        ${r.status === 'Pending' ? `<button class="btn btn-sm btn-ghost" onclick="deleteMyReq(${r.id})"><i class="fa-solid fa-trash"></i></button>` : ''}
                    </div>
                </div>
            `).join('') || '<div class="text-center p-4 text-muted">No requests.</div>';
        }

        function deleteMyReq(id) {
            if(!confirm('Cancel this request?')) return;
            APP.db.requests = APP.db.requests.filter(r => r.id !== id);
            saveData(); renderMyReqs(); showToast('Request Cancelled');
        }

        function submitRegularization() {
            const date = document.getElementById('reg-date').value;
            const reason = document.getElementById('reg-reason').value;
            if(!date || !reason) return showToast('Date and Reason required', 'error');
            APP.db.requests.push({
                id: Date.now(),
                empId: APP.user.id, empName: APP.user.name,
                type: 'Regularization',
                detail: `${date} (${document.getElementById('reg-in').value} - ${document.getElementById('reg-out').value})`,
                status: 'Pending',
                date: new Date().toISOString().split('T')[0]
            });
            saveData(); showToast('Regularization Sent');
            document.getElementById('reg-date').value = '';
            document.getElementById('reg-reason').value = '';
        }

        function uploadDrive() {
            showToast('Uploading...', 'info');
            setTimeout(() => {
                APP.db.calls.push({
                    id: Date.now(), empId: APP.user.id,
                    compNo: document.getElementById('call-comp').value,
                    date: document.getElementById('call-date').value,
                    link: 'https://drive.google.com/mock' 
                });
                saveData(); renderMyCalls();
                document.getElementById('call-comp').value = '';
                showToast('File Uploaded');
            }, 1500);
        }

        function renderMyCalls() {
            const list = document.getElementById('my-call-list');
            const my = APP.db.calls.filter(c => c.empId === APP.user.id).reverse();
            list.innerHTML = my.map(c => `
                <div class="list-item">
                    <div class="list-content">
                        <h4>${c.compNo || 'Job #' + c.id}</h4>
                        <p>${c.date}</p>
                    </div>
                    <div class="flex" style="gap:5px;">
                        <a href="${c.link}" target="_blank" class="btn btn-sm btn-ghost">View</a>
                        <button class="btn btn-sm btn-ghost" onclick="deleteMyCall(${c.id})"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            `).join('') || '<div class="text-center p-4 text-muted">No reports.</div>';
        }

        function deleteMyCall(id) {
            if(!confirm('Delete this report?')) return;
            APP.db.calls = APP.db.calls.filter(c => c.id !== id);
            saveData(); renderMyCalls(); showToast('Report Deleted');
        }

        function loadDriveFiles() {
             document.getElementById('drive-browser').innerHTML = `
                <div class="card" style="padding:16px; text-align:center; cursor:pointer;">
                    <i class="fa-solid fa-folder" style="font-size:2.5rem; color:var(--warning);"></i>
                    <div style="font-size:0.85rem;">Reports 2023</div>
                </div>
                <div class="card" style="padding:16px; text-align:center; cursor:pointer;">
                    <i class="fa-solid fa-file-pdf" style="font-size:2.5rem; color:var(--danger);"></i>
                    <div style="font-size:0.85rem;">Policies</div>
                </div>
             `;
        }

        // --- CHAT & AI (UPDATED) ---
        function loadChatContacts() {
            const list = document.getElementById('contact-list');
            const myChats = APP.db.chats.filter(c => c.participants.includes(APP.user.id));
            if(myChats.length === 0) { list.innerHTML = '<div class="text-center p-3 text-muted">No active chats.</div>'; return; }

            list.innerHTML = myChats.map(chat => {
                const otherId = chat.participants.find(id => id !== APP.user.id);
                const name = otherId === 'admin' ? 'Admin' : (APP.db.employees.find(e => e.id === otherId)?.name || 'Unknown');
                const msgs = APP.db.messages.filter(m => m.chatId === chat.id);
                const lastMsg = msgs.length ? msgs[msgs.length-1].text : 'No messages';
                const time = msgs.length ? new Date(msgs[msgs.length-1].timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

                return `
                <div class="contact-item ${APP.activeChatId === chat.id ? 'active' : ''}" onclick="openChat('${chat.id}')">
                    <div class="avatar" style="width:36px; height:36px;">
                        ${otherId === 'admin' ? 'A' : (APP.db.employees.find(e => e.id === otherId)?.photo ? `<img src="${APP.db.employees.find(e => e.id === otherId).photo}">` : 'U')}
                    </div>
                    <div class="contact-info">
                        <div class="contact-name">${name}</div>
                        <div class="contact-last-msg" style="display:flex; justify-content:space-between;">
                            <span style="overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:60%;">${lastMsg}</span>
                            <span style="font-size:0.65rem; opacity:0.5;">${time}</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function startNewChat(targetId) {
            const participants = [APP.user.id, targetId].sort();
            const chatId = participants.join('-');
            let chat = APP.db.chats.find(c => c.id === chatId);
            if(!chat) { chat = { id: chatId, participants: participants }; APP.db.chats.push(chat); saveData(); }
            openChat(chatId);
        }

        function openChat(chatId) {
            APP.activeChatId = chatId; loadChatContacts();
            if(window.innerWidth < 768) {
                document.querySelector('.chat-sidebar').classList.remove('mobile-visible');
                document.querySelector('.chat-main').classList.add('mobile-visible');
                document.getElementById('chat-back').classList.remove('hidden');
            } else { document.getElementById('chat-back').classList.add('hidden'); }
            const otherId = APP.db.chats.find(c => c.id === chatId).participants.find(id => id !== APP.user.id);
            document.getElementById('chat-title').textContent = otherId === 'admin' ? 'Admin' : (APP.db.employees.find(e => e.id === otherId)?.name || 'Unknown');
            document.getElementById('chat-actions').classList.remove('hidden'); // Show share buttons
            renderMessages(chatId);
        }

        function toggleChatView(showMain) {
            if(showMain) {
                document.querySelector('.chat-sidebar').classList.remove('mobile-visible');
                document.querySelector('.chat-main').classList.add('mobile-visible');
            } else {
                document.querySelector('.chat-sidebar').classList.add('mobile-visible');
                document.querySelector('.chat-main').classList.remove('mobile-visible');
                APP.activeChatId = null; loadChatContacts();
            }
        }

        function renderMessages(chatId) {
            const container = document.getElementById('message-container');
            const msgs = APP.db.messages.filter(m => m.chatId === chatId).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            if(msgs.length === 0) { container.innerHTML = '<div class="text-center" style="margin-top: 50px; color: var(--fg-muted); opacity: 0.5;">Start the conversation...</div>'; return; }

            container.innerHTML = msgs.map(m => {
                const isMe = m.senderId === APP.user.id;
                return `
                <div class="message-bubble ${isMe ? 'msg-sent' : 'msg-received'}">
                    <div style="font-weight:600; font-size:0.7rem; margin-bottom:4px; color:${isMe ? 'rgba(255,255,255,0.7)' : 'var(--primary)'}">${m.category}</div>
                    ${m.text}
                    <span class="msg-meta">${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                </div>`;
            }).join('');
            container.scrollTop = container.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const cat = document.getElementById('msg-category').value;
            const text = input.value.trim();
            if(!text || !APP.activeChatId) return;
            APP.db.messages.push({ id: Date.now(), chatId: APP.activeChatId, senderId: APP.user.id, category: cat, text: text, timestamp: new Date().toISOString() });
            saveData(); input.value = ''; renderMessages(APP.activeChatId); loadChatContacts();
        }

        // NEW: SHARE CHAT VIA APP
        function shareChatViaApp(app) {
            const msgs = APP.db.messages.filter(m => m.chatId === APP.activeChatId);
            const lastMsg = msgs.length ? msgs[msgs.length-1].text : "Conversation started";
            
            let url = "";
            const text = `Message from Nexus HR: ${lastMsg}`;
            
            if(app === 'whatsapp') {
                const link = APP.db.settings.waCheckin; 
                url = link ? `${link}?text=${encodeURIComponent(text)}` : `https://wa.me/?text=${encodeURIComponent(text)}`;
            } else if(app === 'telegram') {
                url = `https://t.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(text)}`;
            } else if(app === 'native') {
                if(navigator.share) {
                    navigator.share({ title: 'Nexus HR Message', text: text });
                    return;
                }
            }
            
            window.open(url, '_blank');
        }

        // --- AI RESPONDER ---
        function sendAIMessage() {
            const input = document.getElementById('ai-input');
            const text = input.value.trim().toLowerCase();
            if(!text) return;

            appendAIMessage(text, 'sent');
            input.value = '';

            setTimeout(() => {
                let reply = "I didn't understand that. Try asking about 'Attendance', 'Leave', or 'Admin'.";
                if(text.includes('check in') || text.includes('attendance')) reply = "To check in, go to the Home tab and tap the 'Check In' button. Ensure your GPS is on.";
                else if(text.includes('leave') || text.includes('holiday')) reply = "To apply for leave, go to Quick Actions > Leave. Select your dates and submit.";
                else if(text.includes('admin') || text.includes('help') || text.includes('support')) {
                    reply = "I am connecting you to the Admin now...";
                    startNewChat('admin');
                    switchEmpTab('chat');
                }
                else if(text.includes('hello') || text.includes('hi')) reply = "Hello! How can I assist you with Nexus HR today?";
                
                appendAIMessage(reply, 'received');
            }, 600);
        }

        function appendAIMessage(text, type) {
            const container = document.getElementById('ai-message-container');
            const div = document.createElement('div');
            div.className = `message-bubble ${type === 'sent' ? 'msg-sent' : 'msg-received ai-bubble'}`;
            div.innerHTML = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- GOOGLE CALENDAR ---
        function generateCalendarEvent() {
            const title = encodeURIComponent("Nexus HR Check-in");
            const details = encodeURIComponent("Daily Attendance Check-in Reminder");
            const location = encodeURIComponent("Office / Remote");
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(9,0,0);
            const start = tomorrow.toISOString().replace(/-|:|\.\d\d\d/g, "");
            const end = new Date(tomorrow.getTime() + 10*60000).toISOString().replace(/-|:|\.\d\d\d/g, "");

            window.open(`https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${start}/${end}&details=${details}&location=${location}&sf=true&output=xml`, '_blank');
        }

        // --- MAP ---
        function initMap() {
            if(!document.getElementById('map-container')) return;
            if(APP.map) { APP.map.invalidateSize(); APP.map.eachLayer(l => { if(!!l.toGeoJSON) APP.map.removeLayer(l); }); } 
            else { APP.map = L.map('map-container').setView([20.5937, 78.9629], 5); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(APP.map); }
            
            const today = new Date().toISOString().split('T')[0];
            APP.db.attendance.filter(a => a.date === today && a.lat).forEach(a => {
                L.marker([a.lat, a.lng]).addTo(APP.map).bindPopup(`<b>${a.empName}</b><br>${a.inTime}`);
            });
        }

        // --- UTILS ---
        function startClock() {
            setInterval(() => {
                const now = new Date();
                const el = document.getElementById('clock-display');
                if(el) el.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const d = document.getElementById('date-display');
                if(d) d.textContent = now.toLocaleDateString(undefined, {weekday: 'long', month: 'short', day: 'numeric'});
            }, 1000);
        }

        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        
        function showToast(msg, type='success') {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `toast`;
            t.style.borderLeftColor = type === 'error' ? 'var(--danger)' : (type === 'info' ? 'var(--primary)' : 'var(--success)');
            t.innerHTML = `<i class="fa-solid fa-${type === 'error' ? 'circle-exclamation' : 'circle-check'}"></i> ${msg}`;
            c.appendChild(t);
            if(type === 'success') playNotificationSound();
            setTimeout(() => t.remove(), 4000);
        }

        function showNotification(msg, type='info') {
            if("Notification" in window && Notification.permission === "granted") new Notification("Nexus HR", { body: msg });
            showToast(msg, type);
        }

        function requestBgPermission() { if("Notification" in window && Notification.permission !== "granted") Notification.requestPermission(); }

        function playNotificationSound() {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = 'sine'; osc.frequency.value = 523.25; 
            gain.gain.setValueAtTime(0.1, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
            osc.start(); osc.stop(ctx.currentTime + 0.5);
        }
    </script>
</body>
</html>