<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus HR â€” Enterprise Command</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --bg: #0a0b0d; --bg-elevated: #13151a; --bg-card: rgba(22, 24, 29, 0.8);
            --fg: #f0f0f2; --fg-muted: #9ca3af; --fg-dim: #4b5563;
            --accent: #f59e0b; --accent-dim: rgba(245, 158, 11, 0.15);
            --danger: #ef4444; --success: #10b981; --info: #3b82f6; --purple: #8b5cf6;
            --border: rgba(255, 255, 255, 0.08);
            --radius: 12px; --radius-lg: 20px;
            --font-display: 'Space Grotesk', sans-serif; --font-ui: 'DM Sans', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }
        body { font-family: var(--font-ui); background: var(--bg); color: var(--fg); min-height: 100vh; overflow-x: hidden; }
        
        /* Layout & Cards */
        .screen { position: relative; z-index: 10; min-height: 100vh; padding: 80px 16px 100px; max-width: 1000px; margin: 0 auto; }
        .hidden { display: none !important; }
        .card { background: var(--bg-card); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 24px; }
        
        /* Typography */
        h1, h2, h3 { font-family: var(--font-display); font-weight: 600; letter-spacing: -0.02em; }
        h2 { font-size: 1.25rem; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px; display: flex; justify-content: space-between; }
        
        /* Buttons & Inputs */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; border: none; border-radius: 10px; cursor: pointer; transition: 0.2s; width: 100%; font-weight: 600; color: #000; background: var(--accent); }
        .btn:hover { transform: translateY(-2px); }
        .btn-ghost { background: rgba(255, 255, 255, 0.05); color: var(--fg); }
        .btn-ghost:hover { background: rgba(255, 255, 255, 0.1); }
        .btn-sm { padding: 8px 12px; font-size: 0.8rem; width: auto; }
        
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.75rem; color: var(--fg-muted); font-weight: 600; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px; background: rgba(0,0,0,0.3); border: 1px solid var(--border); border-radius: 10px; color: var(--fg); }
        
        /* Navigation */
        .tab-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; padding: 8px 16px; background: rgba(10, 11, 13, 0.9); backdrop-filter: blur(24px); border-radius: 50px; z-index: 100; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); max-width: 95%; overflow-x: auto; }
        .tab-btn { width: 44px; height: 44px; border: none; background: transparent; color: var(--fg-dim); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.3s; flex-shrink: 0; }
        .tab-btn.active { color: #000; background: var(--accent); transform: translateY(-2px); }
        .tab-btn.exit-btn { color: var(--danger); }

        /* Components */
        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--border); }
        .list-item:last-child { border-bottom: none; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge.pending { background: rgba(245, 158, 11, 0.2); color: var(--accent); }
        .badge.approved { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        
        /* Chat & Storage Styles */
        .chat-layout { display: flex; height: 600px; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; background: rgba(0,0,0,0.3); }
        .chat-sidebar { width: 35%; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .chat-main { width: 65%; display: flex; flex-direction: column; }
        .chat-header { padding: 12px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.03); font-weight: 600; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .message-bubble { max-width: 75%; padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; }
        .msg-sent { align-self: flex-end; background: var(--accent); color: #000; }
        .msg-received { align-self: flex-start; background: var(--bg-elevated); border: 1px solid var(--border); }
        
        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); z-index: 200; display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: 0.3s; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; width: 100%; max-width: 500px; transform: scale(0.95); transition: 0.3s; }
        .modal-overlay.open .modal-content { transform: scale(1); }
    </style>
</head>
<body>
    <!-- Header -->
    <header style="position: fixed; top: 0; left: 0; right: 0; height: 64px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(10, 11, 13, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); z-index: 100;">
        <div class="flex items-center gap-3">
            <div style="width: 36px; height: 36px; background: var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #000;">N</div>
            <div style="font-weight: 700; font-size: 1.2rem; font-family: var(--font-display);">Nexus<span style="color:var(--accent)">HR</span></div>
        </div>
        <div id="user-display" class="text-xs text-muted">Guest</div>
    </header>

    <main id="app-container">
        <!-- Login Screen -->
        <section id="login-screen" class="screen">
            <div class="card" style="width: 100%; max-width: 380px; margin: 0 auto; text-align: center; margin-top: 50px;">
                <h1 style="margin-bottom: 20px;">Login</h1>
                <form onsubmit="handleLogin(event)">
                    <div class="input-group"><input type="text" id="username" placeholder="User ID" required></div>
                    <div class="input-group"><input type="password" id="password" placeholder="Password" required></div>
                    <button type="submit" class="btn">Login</button>
                    <div class="text-xs text-muted mt-4">Admin: admin / admin</div>
                </form>
            </div>
        </section>

        <!-- Admin Panel -->
        <section id="admin-panel" class="screen hidden">
            <div id="admin-view-dashboard" class="card">
                <h2>Admin Dashboard</h2>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div class="card" style="margin:0; padding:15px; text-align:center;">
                        <div style="font-size:1.5rem; font-weight:bold; color:var(--accent);" id="admin-total-emp">0</div>
                        <div class="text-xs text-muted">Total Employees</div>
                    </div>
                    <div class="card" style="margin:0; padding:15px; text-align:center;">
                        <div style="font-size:1.5rem; font-weight:bold; color:var(--success);" id="admin-storage-used">0 GB</div>
                        <div class="text-xs text-muted">Storage Used</div>
                    </div>
                </div>
                <h3 style="margin-top:20px;">Cloud Storage Management</h3>
                <div class="input-group">
                    <label>Upload Software (Max 10GB)</label>
                    <input type="file" id="admin-file-upload">
                    <input type="text" id="admin-file-version" placeholder="Version (e.g. 1.0)" style="margin-top:5px;">
                    <button class="btn btn-sm" style="margin-top:5px;" onclick="adminUploadFile()">Upload to Cloud</button>
                </div>
                <div id="admin-software-list" style="margin-top:10px;"></div>
            </div>
        </section>

        <!-- Employee Panel -->
        <section id="employee-panel" class="screen hidden">
            
            <!-- 1. Home View -->
            <div id="emp-view-home">
                <div class="card">
                    <h2>Welcome, <span id="emp-name-display"></span></h2>
                    <div style="text-align:center; margin: 30px 0;">
                        <div id="clock-display" style="font-size: 3rem; font-weight: 700; font-family: var(--font-display);">--:--</div>
                    </div>
                    <button id="btn-check-in" class="btn" onclick="performCheckIn()"><i class="fa-solid fa-location-dot"></i> Check In</button>
                    <button id="btn-check-out" class="btn hidden" style="background:var(--danger);" onclick="performCheckOut()"><i class="fa-solid fa-person-walking-arrow-right"></i> Check Out</button>
                </div>
            </div>

            <!-- 2. Cloud Storage View -->
            <div id="emp-view-storage" class="hidden">
                <div class="card">
                    <h2>Cloud Software <button class="btn btn-sm" onclick="openReqModal()"><i class="fa-solid fa-plus"></i> Request</button></h2>
                    <div id="software-list" class="list-container" style="border:1px solid var(--border); border-radius:var(--radius); margin-top:10px;">
                        <div class="text-center p-3 text-muted">Loading...</div>
                    </div>
                </div>
            </div>

            <!-- 3. Field Call View -->
            <div id="emp-view-field-call" class="hidden">
                <div class="card">
                    <h2>Field Call Report</h2>
                    <form onsubmit="submitFieldCall(event)">
                        <div class="input-group"><label>Complaint Number</label><input type="text" id="fc-complaint" required></div>
                        <div class="input-group"><label>Theatre Name</label><input type="text" id="fc-theatre" required></div>
                        <div class="input-group"><label>Call Type</label>
                            <select id="fc-type">
                                <option>Installation</option><option>Maintenance</option><option>Repair</option><option>Emergency</option>
                            </select>
                        </div>
                        <div class="flex gap-2">
                            <div class="input-group w-full"><label>Date</label><input type="date" id="fc-date" required></div>
                            <div class="input-group w-full"><label>Time</label><input type="time" id="fc-time" required></div>
                        </div>
                        <div class="input-group"><label>Upload Report</label><input type="file" id="fc-file"></div>
                        <div class="input-group mb-0"><label>Notes</label><textarea id="fc-notes" rows="2"></textarea></div>
                        <button type="submit" class="btn mt-4">Submit Report</button>
                    </form>
                </div>
            </div>

            <!-- 4. Messages View -->
            <div id="emp-view-messages" class="hidden">
                <div class="card" style="padding:0; height: calc(100vh - 180px); overflow:hidden;">
                    <div class="chat-layout">
                        <div class="chat-sidebar">
                            <div class="chat-header">Chats</div>
                            <div id="msg-contact-list" style="overflow-y:auto; flex:1;"></div>
                        </div>
                        <div class="chat-main">
                            <div class="chat-header" id="msg-current-chat">Select a chat</div>
                            <div id="msg-container" style="flex:1; overflow-y:auto; padding:10px;"></div>
                            <div class="chat-input-area" style="padding:10px; border-top:1px solid var(--border); display:flex; gap:10px;">
                                <input type="text" id="msg-input" placeholder="Type a message..." style="flex:1;">
                                <button class="btn" style="width:auto;" onclick="sendMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <!-- Navigation: Admin -->
    <nav id="admin-nav" class="tab-nav hidden">
        <button class="tab-btn active" onclick="switchAdminTab('dashboard', this)"><i class="fa-solid fa-gauge"></i></button>
        <button class="tab-btn exit-btn" onclick="logout()"><i class="fa-solid fa-power-off"></i></button>
    </nav>

    <!-- Navigation: Employee -->
    <nav id="emp-nav" class="tab-nav hidden">
        <button class="tab-btn active" onclick="switchEmpTab('home', this)"><i class="fa-solid fa-house"></i></button>
        <button class="tab-btn" onclick="switchEmpTab('storage', this)"><i class="fa-solid fa-cloud"></i></button>
        <button class="tab-btn" onclick="switchEmpTab('field-call', this)"><i class="fa-solid fa-phone"></i></button>
        <button class="tab-btn" onclick="switchEmpTab('messages', this)"><i class="fa-solid fa-comments"></i></button>
        <button class="tab-btn exit-btn" onclick="logout()"><i class="fa-solid fa-power-off"></i></button>
    </nav>

    <!-- Software Request Modal -->
    <div id="reqModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Request Software</h2>
            <div class="input-group"><label>Software Name</label><input type="text" id="req-name"></div>
            <div class="input-group"><label>Purpose</label><textarea id="req-purpose" rows="2"></textarea></div>
            <div class="input-group"><label>Priority</label>
                <select id="req-priority"><option>Low</option><option>Medium</option><option>High</option></select>
            </div>
            <div class="flex gap-2 mt-4">
                <button class="btn" onclick="submitSoftwareRequest()">Submit</button>
                <button class="btn btn-ghost" onclick="closeModal('reqModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast-box" style="position:fixed; top:20px; right:20px; z-index:300;"></div>

    <script>
        // --- CONFIGURATION ---
        const API_URL = 'http://localhost:3000/api'; // Backend URL
        let APP = { user: null, activeChat: null };

        // --- AUTH ---
        async function handleLogin(e) {
            e.preventDefault();
            const id = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            
            try {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ id, pass })
                });
                const data = await res.json();
                
                if(data.success) {
                    APP.user = data.user;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('user-display').textContent = APP.user.name;
                    
                    if(APP.user.role === 'admin') {
                        document.getElementById('admin-panel').classList.remove('hidden');
                        document.getElementById('admin-nav').classList.remove('hidden');
                        loadAdminDashboard();
                    } else {
                        document.getElementById('employee-panel').classList.remove('hidden');
                        document.getElementById('emp-nav').classList.remove('hidden');
                        document.getElementById('emp-name-display').textContent = APP.user.name;
                        startClock();
                        switchEmpTab('home', document.querySelector('#emp-nav .tab-btn'));
                    }
                } else {
                    showToast(data.message, 'error');
                }
            } catch(err) {
                showToast('Server connection error', 'error');
                console.error(err);
            }
        }

        function logout() { location.reload(); }

        // --- ADMIN ---
        function loadAdminDashboard() {
            fetch(`${API_URL}/storage/stats`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('admin-storage-used').textContent = data.usedFormatted;
                });

            fetch(`${API_URL}/software/list`)
                .then(r => r.json())
                .then(files => {
                    const list = document.getElementById('admin-software-list');
                    list.innerHTML = files.map(f => `
                        <div class="list-item">
                            <div>
                                <div style="font-weight:600;">${f.file_name}</div>
                                <div class="text-xs text-muted">${(f.file_size/1024/1024).toFixed(2)} MB</div>
                            </div>
                        </div>
                    `).join('');
                });
        }

        async function adminUploadFile() {
            const fileInput = document.getElementById('admin-file-upload');
            const version = document.getElementById('admin-file-version').value;
            
            if(!fileInput.files[0]) return showToast('Select a file', 'error');

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('uploaded_by', APP.user.id);
            formData.append('version', version);

            try {
                const res = await fetch(`${API_URL}/software/upload`, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if(data.success) {
                    showToast('File uploaded to Cloud', 'success');
                    loadAdminDashboard();
                    fileInput.value = '';
                } else {
                    showToast(data.error || 'Upload failed', 'error');
                }
            } catch(err) { showToast('Upload error', 'error'); }
        }

        // --- EMPLOYEE TABS ---
        function switchEmpTab(tab, btn) {
            document.querySelectorAll('#emp-nav .tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            ['home', 'storage', 'field-call', 'messages'].forEach(v => {
                document.getElementById(`emp-view-${v}`).classList.add('hidden');
            });
            document.getElementById(`emp-view-${tab}`).classList.remove('hidden');

            if(tab === 'storage') loadSoftwareList();
            if(tab === 'messages') loadMessageContacts();
        }

        // --- CLOUD STORAGE (EMPLOYEE) ---
        async function loadSoftwareList() {
            try {
                const res = await fetch(`${API_URL}/software/list`);
                const files = await res.json();
                const list = document.getElementById('software-list');
                list.innerHTML = files.length ? files.map(f => `
                    <div class="list-item">
                        <div>
                            <div style="font-weight:600;">${f.file_name}</div>
                            <div class="text-xs text-muted">Ver: ${f.version} | ${(f.file_size/1024/1024).toFixed(2)} MB</div>
                        </div>
                        <a href="${API_URL.replace('/api', '')}${f.file_url}" download class="btn btn-sm btn-ghost"><i class="fa-solid fa-download"></i></a>
                    </div>
                `).join('') : '<div class="p-3 text-center text-muted">No files available</div>';
            } catch(err) { console.error(err); }
        }

        function openReqModal() { document.getElementById('reqModal').classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        async function submitSoftwareRequest() {
            const data = {
                emp_id: APP.user.id,
                software_name: document.getElementById('req-name').value,
                purpose: document.getElementById('req-purpose').value,
                priority: document.getElementById('req-priority').value
            };
            await fetch(`${API_URL}/software/request`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            closeModal('reqModal');
            showToast('Request Sent', 'success');
        }

        // --- FIELD CALL ---
        async function submitFieldCall(e) {
            e.preventDefault();
            const formData = new FormData();
            formData.append('emp_id', APP.user.id);
            formData.append('complaint_number', document.getElementById('fc-complaint').value);
            formData.append('theatre_name', document.getElementById('fc-theatre').value);
            formData.append('call_type', document.getElementById('fc-type').value);
            formData.append('start_date', document.getElementById('fc-date').value);
            formData.append('end_date', document.getElementById('fc-date').value);
            formData.append('call_time', document.getElementById('fc-time').value);
            formData.append('notes', document.getElementById('fc-notes').value);
            
            const file = document.getElementById('fc-file').files[0];
            if(file) formData.append('report', file);

            await fetch(`${API_URL}/field-call/submit`, { method: 'POST', body: formData });
            e.target.reset();
            showToast('Field Call Submitted', 'success');
        }

        // --- MESSAGING ---
        async function loadMessageContacts() {
            try {
                const res = await fetch(`${API_URL}/employees`);
                const users = await res.json();
                const list = document.getElementById('msg-contact-list');
                
                // Filter out self
                const others = users.filter(u => u.id !== APP.user.id);
                
                list.innerHTML = others.map(u => `
                    <div class="list-item" onclick="openChat('${u.id}', '${u.name}')" style="cursor:pointer">
                        <div style="font-weight:600;">${u.name}</div>
                        <div class="text-xs text-muted">Click to chat</div>
                    </div>
                `).join('');
            } catch(err) { console.error(err); }
        }

        function openChat(userId, userName) {
            APP.activeChat = userId;
            document.getElementById('msg-current-chat').textContent = `Chat with ${userName}`;
            loadMessages(userId);
        }

        async function loadMessages(userId) {
            // In a real app, fetch specific conversation. Here we fetch all for the demo.
            const container = document.getElementById('msg-container');
            container.innerHTML = '<div class="text-center text-muted">Loading messages...</div>';
            
            try {
                const res = await fetch(`${API_URL}/messages/${APP.user.id}`);
                const msgs = await res.json();
                
                // Filter simple 1-to-1 logic for demo
                const relevant = msgs.filter(m => (m.sender_id === APP.user.id && m.receiver_id === userId) || (m.sender_id === userId && m.receiver_id === APP.user.id));
                
                container.innerHTML = relevant.length ? relevant.map(m => `
                    <div class="message-bubble ${m.sender_id === APP.user.id ? 'msg-sent' : 'msg-received'}">
                        ${m.content}
                        ${m.attachment_url ? `<br><a href="${API_URL.replace('/api','')}${m.attachment_url}" target="_blank" class="text-xs text-accent">[File]</a>` : ''}
                    </div>
                `).join('') : '<div class="text-center text-muted mt-4">No messages yet</div>';
                
                container.scrollTop = container.scrollHeight;
            } catch(err) { console.error(err); }
        }

        async function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text || !APP.activeChat) return;

            const formData = new FormData();
            formData.append('sender_id', APP.user.id);
            formData.append('receiver_id', APP.activeChat);
            formData.append('content', text);

            await fetch(`${API_URL}/messages/send`, { method: 'POST', body: formData });
            input.value = '';
            loadMessages(APP.activeChat);
        }

        // --- UTILS ---
        function startClock() {
            setInterval(() => {
                const el = document.getElementById('clock-display');
                if(el) el.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            }, 1000);
        }

        function showToast(msg, type='success') {
            const t = document.createElement('div');
            t.style.cssText = `background:var(--bg-elevated); border:1px solid var(--border); padding:10px 15px; border-radius:8px; margin-bottom:10px; color:${type==='error'?'var(--danger)':'var(--success)'}; animation: slideIn 0.3s;`;
            t.textContent = msg;
            document.getElementById('toast-box').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // Check In/Out Logic (Simplified for demo, normally uses GPS)
        function performCheckIn() {
            document.getElementById('btn-check-in').classList.add('hidden');
            document.getElementById('btn-check-out').classList.remove('hidden');
            showToast('Checked In', 'success');
        }
        function performCheckOut() {
            document.getElementById('btn-check-out').classList.add('hidden');
            document.getElementById('btn-check-in').classList.remove('hidden');
            showToast('Checked Out', 'success');
        }

        // Admin Tab Switch
        function switchAdminTab(tab, btn) {
            document.querySelectorAll('#admin-nav .tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
    </script>
</body>
</html>