<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus HR ‚Äî Enterprise Command</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            /* Theme Colors - Deep Space Dark */
            --bg: #0a0b0d;
            --bg-elevated: #13151a;
            --bg-card: rgba(22, 24, 29, 0.8);
            --fg: #f0f0f2;
            --fg-muted: #9ca3af;
            --fg-dim: #4b5563;
            
            /* Accents */
            --accent: #f59e0b; /* Amber */
            --accent-dim: rgba(245, 158, 11, 0.15);
            --accent-glow: rgba(245, 158, 11, 0.4);
            --danger: #ef4444;
            --success: #10b981;
            --info: #3b82f6;
            --purple: #8b5cf6;
            
            /* Structure */
            --border: rgba(255, 255, 255, 0.08);
            --border-strong: rgba(255, 255, 255, 0.15);
            --radius: 12px;
            --radius-lg: 20px;
            
            /* Typography */
            --font-display: 'Space Grotesk', sans-serif;
            --font-ui: 'DM Sans', sans-serif;
        }

        /* Local Mode Overrides */
        body.local-mode {
            --bg: #0f172a; /* Darker Blue-Grey */
            --bg-elevated: #1e293b;
            --accent: #06b6d4; /* Cyan */
            --accent-dim: rgba(6, 182, 212, 0.15);
            --accent-glow: rgba(6, 182, 212, 0.4);
        }

        /* Reset & Base */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        html { scroll-behavior: smooth; }
        body { 
            font-family: var(--font-ui); background: var(--bg); color: var(--fg); 
            min-height: 100vh; overflow-x: hidden; line-height: 1.5; 
            transition: background 0.4s ease;
        }

        /* Ambient Background */
        .bg-gradient-orb { position: fixed; border-radius: 50%; filter: blur(100px); opacity: 0.25; animation: orbFloat 25s ease-in-out infinite; pointer-events: none; z-index: 0; }
        .orb-1 { width: 500px; height: 500px; background: radial-gradient(circle, var(--accent) 0%, transparent 70%); top: -150px; right: -150px; }
        .orb-2 { width: 400px; height: 400px; background: radial-gradient(circle, var(--purple) 0%, transparent 70%); bottom: -100px; left: -100px; animation-delay: -12s; }
        @keyframes orbFloat { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-30px, 30px); } }

        /* Layout */
        .screen { position: relative; z-index: 10; min-height: 100vh; padding: 80px 16px 100px; max-width: 1000px; margin: 0 auto; }
        .hidden { display: none !important; }
        
        /* Cards */
        .card { background: var(--bg-card); backdrop-filter: blur(20px); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); transition: transform 0.2s, border-color 0.2s; }
        .card:hover { border-color: var(--border-strong); }

        /* Typography */
        h1, h2, h3, h4 { font-family: var(--font-display); color: var(--fg); font-weight: 600; letter-spacing: -0.02em; }
        h1 { font-size: 1.8rem; }
        h2 { font-size: 1.25rem; margin-bottom: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        h3 { font-size: 0.75rem; margin-bottom: 12px; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; }
        
        /* Buttons */
        .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 20px; border: none; border-radius: 10px; font-family: var(--font-ui); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s; text-decoration: none; width: 100%; }
        .btn-primary { background: var(--accent); color: #000; box-shadow: 0 4px 15px var(--accent-dim); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px var(--accent-glow); }
        .btn-danger { background: var(--danger); color: #fff; }
        .btn-success { background: var(--success); color: #000; }
        .btn-ghost { background: rgba(255, 255, 255, 0.03); color: var(--fg-muted); border: 1px solid var(--border); }
        .btn-ghost:hover { background: rgba(255, 255, 255, 0.08); color: var(--fg); }
        .btn-sm { padding: 8px 12px; font-size: 0.8rem; border-radius: 8px; }

        /* Forms */
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; margin-bottom: 8px; font-size: 0.75rem; font-weight: 600; color: var(--fg-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .input-group input, .input-group select, .input-group textarea { width: 100%; padding: 12px 14px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border); border-radius: 10px; color: var(--fg); font-family: var(--font-ui); font-size: 0.95rem; transition: all 0.2s; }
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent-dim); }
        
        /* Navigation (Bottom Dock) */
        .tab-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; padding: 8px 16px; background: rgba(10, 11, 13, 0.9); backdrop-filter: blur(24px); border-radius: 50px; z-index: 100; border: 1px solid var(--border); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); max-width: 95%; overflow-x: auto; }
        
        .tab-btn { 
            width: 44px; height: 44px; 
            border: none; background: transparent; color: var(--fg-dim); font-size: 1.1rem; 
            cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            transition: all 0.3s; position: relative; flex-shrink: 0;
        }
        /* Tab Glow Effect */
        .tab-btn::after { content: ''; position: absolute; inset: 0; border-radius: 50%; background: var(--accent); opacity: 0; transform: scale(0.8); transition: 0.3s; z-index: -1; box-shadow: 0 0 10px var(--accent-glow); }
        .tab-btn.active { color: #000; transform: translateY(-2px); }
        .tab-btn.active::after { opacity: 1; transform: scale(1); box-shadow: 0 0 15px var(--accent); }
        .tab-btn.exit-btn { color: var(--danger); margin-left: 8px; }
        .tab-btn.exit-btn.active::after { background: var(--danger); }
        
        /* Grid & Layouts */
        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media(min-width: 768px) { .settings-grid { grid-template-columns: 1fr 1fr; } }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
        .mt-4 { margin-top: 16px; }
        .mb-2 { margin-bottom: 8px; }
        .mb-0 { margin-bottom: 0; }
        .w-full { width: 100%; }
        .text-center { text-align: center; }
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-muted { color: var(--fg-muted); }
        .font-bold { font-weight: 700; }

        /* Modals */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); z-index: 200; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-content { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: 0.3s; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6); }
        .modal-overlay.open .modal-content { transform: scale(1); }

        /* Toast */
        .toast-container { position: fixed; top: 80px; left: 20px; right: 20px; z-index: 300; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast { background: var(--bg-elevated); border: 1px solid var(--border); padding: 12px 16px; border-radius: 10px; display: flex; align-items: center; gap: 10px; animation: toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto; border-left: 3px solid var(--accent); }
        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--danger); }
        .toast.info { border-left-color: var(--info); }
        @keyframes toastIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Components */
        .profile-photo { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; position: relative; }
        .profile-photo img { width: 100%; height: 100%; object-fit: cover; }
        .profile-photo.sm { width: 40px; height: 40px; }
        .profile-photo.lg { width: 100px; height: 100px; margin: 0 auto; }

        #map-container { height: 300px; width: 100%; border-radius: var(--radius); border: 1px solid var(--border); margin-top: 16px; z-index: 1; }
        .leaflet-container { background: var(--bg-elevated) !important; }

        .list-container { display: flex; flex-direction: column; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; background: rgba(0,0,0,0.2); }
        .list-item { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.01); transition: 0.2s; }
        .list-item:last-child { border-bottom: none; }
        .list-item:hover { background: rgba(255,255,255,0.03); }
        .list-item-content { display: flex; align-items: center; gap: 12px; flex: 1; }
        
        .stat-card { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; text-align: center; cursor: pointer; transition: 0.2s; }
        .stat-card:hover { border-color: var(--accent); background: var(--accent-dim); }
        .stat-val { font-size: 2.5rem; font-weight: 700; font-family: var(--font-display); background: linear-gradient(135deg, #fff, #888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        .badge { padding: 4px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .badge.pending { background: rgba(245, 158, 11, 0.2); color: var(--accent); }
        .badge.approved { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .badge.rejected { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .badge.online { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }

        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; inset: 0; background-color: #333; border-radius: 24px; transition: .3s; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .3s; }
        input:checked + .toggle-slider { background-color: var(--accent); }
        input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* Table */
        .log-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        .log-table th { text-align: left; color: var(--fg-muted); padding: 8px; border-bottom: 1px solid var(--border); font-size: 0.75rem; text-transform: uppercase; }
        .log-table td { padding: 10px 8px; border-bottom: 1px solid var(--border); color: var(--fg); }
        .log-table tr:hover td { background: rgba(255,255,255,0.02); }

        .status-p { color: var(--success); font-weight: 800; }
        .status-l { color: var(--accent); font-weight: 800; }
        .status-a { color: var(--danger); font-weight: 800; }
        
        .code-font { font-family: monospace; font-size: 0.8rem; color: var(--accent); }

        /* --- CHAT STYLES --- */
        .chat-layout { display: flex; height: 600px; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; background: rgba(0,0,0,0.3); }
        .chat-sidebar { width: 35%; border-right: 1px solid var(--border); background: rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        .chat-main { width: 65%; display: flex; flex-direction: column; background: var(--bg-card); position: relative; }
        @media(max-width: 768px) { 
            .chat-layout { flex-direction: column; height: 70vh; } 
            .chat-sidebar { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid var(--border); display: none; }
            .chat-sidebar.mobile-visible { display: flex; }
            .chat-main { width: 100%; height: 60%; display: none; }
            .chat-main.mobile-visible { display: flex; }
        }
        .chat-header { padding: 12px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.03); font-weight: 600; display: flex; align-items: center; justify-content: space-between; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .message-bubble { max-width: 75%; padding: 10px 14px; border-radius: 12px; font-size: 0.9rem; line-height: 1.4; position: relative; word-wrap: break-word; }
        .msg-sent { align-self: flex-end; background: var(--accent); color: #000; border-bottom-right-radius: 2px; }
        .msg-received { align-self: flex-start; background: var(--bg-elevated); color: var(--fg); border: 1px solid var(--border); border-bottom-left-radius: 2px; }
        .msg-meta { font-size: 0.65rem; opacity: 0.7; text-align: right; margin-top: 4px; display: block; }
        .chat-input-area { padding: 12px; border-top: 1px solid var(--border); background: rgba(0,0,0,0.2); display: flex; gap: 10px; }
        .contact-item { padding: 12px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s; }
        .contact-item:hover, .contact-item.active { background: rgba(255,255,255,0.05); }
        .contact-info { flex: 1; overflow: hidden; }
        .contact-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .contact-last-msg { font-size: 0.75rem; color: var(--fg-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- FILE MANAGER STYLES --- */
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 16px; }
        .file-item { display: flex; flex-direction: column; align-items: center; padding: 16px; background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .file-item:hover { background: rgba(255,255,255,0.06); border-color: var(--accent); }
        .file-icon { font-size: 2rem; color: var(--fg-muted); margin-bottom: 8px; }
        .file-name { font-size: 0.75rem; text-align: center; word-break: break-word; }
        .folder-icon { color: var(--accent); }
    </style>
</head>
<body>
    <div class="bg-gradient-orb orb-1"></div>
    <div class="bg-gradient-orb orb-2"></div>

    <!-- Header -->
    <header style="position: fixed; top: 0; left: 0; right: 0; height: 64px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(10, 11, 13, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid var(--border); z-index: 100;">
        <div class="flex items-center gap-3">
            <div style="width: 36px; height: 36px; background: var(--accent); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #000; font-size: 1.1rem; box-shadow: 0 0 15px var(--accent-glow);">N</div>
            <div style="font-weight: 700; font-size: 1.2rem; font-family: var(--font-display);">Nexus<span style="color:var(--accent)">HR</span></div>
        </div>
        <div id="cloud-indicator" class="badge online" style="cursor: pointer;" onclick="manualSync()">Local</div>
    </header>

    <main id="app-container">
        <!-- Login Screen -->
        <section id="login-screen" class="screen">
            <div class="flex items-center justify-center" style="min-height: 80vh;">
                <div class="card" style="width: 100%; max-width: 380px; text-align: center;">
                    <div style="margin-bottom: 24px;">
                        <div style="width: 80px; height: 80px; background: var(--accent); border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #000; box-shadow: 0 0 30px var(--accent-glow);">
                            <i class="fa-solid fa-fingerprint"></i>
                        </div>
                        <h1 style="font-size: 1.6rem;">Workforce Command</h1>
                        <p style="color: var(--fg-muted); font-size: 0.9rem;">Secure Enterprise Access</p>
                    </div>
                    
                    <div class="flex justify-between items-center mb-4" style="background: rgba(255,255,255,0.03); padding: 12px; border-radius: 12px; margin-bottom: 24px;">
                        <span style="font-size: 0.85rem; font-weight: 600;">Local Offline Mode</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="login-local-mode" onchange="toggleLocalMode(this)">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <form onsubmit="handleLogin(event)">
                        <div class="input-group">
                            <input type="text" id="username" placeholder="User ID" required style="text-align: center; font-size: 1.1rem;">
                        </div>
                        <div class="input-group mb-0">
                            <input type="password" id="password" placeholder="Password" required style="text-align: center; font-size: 1.1rem;">
                        </div>
                        <button type="submit" class="btn btn-primary mt-4">Authenticate</button>
                    </form>
                </div>
            </div>
        </section>

        <!-- Admin Panel -->
        <section id="admin-panel" class="screen hidden">
            <!-- Dashboard View -->
            <div id="admin-view-dashboard">
                <div class="card">
                    <h2>Command Center <i class="fa-solid fa-chart-line" style="color: var(--fg-muted); font-size: 0.9rem;"></i></h2>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                        <div class="stat-card" onclick="openStatModal('total')">
                            <div class="stat-val" id="stat-total">0</div>
                            <div style="font-size: 0.8rem; color: var(--fg-muted); margin-top: 5px;">Total Staff</div>
                        </div>
                        <div class="stat-card" onclick="openStatModal('online')">
                            <div class="stat-val" id="stat-online">0</div>
                            <div style="font-size: 0.8rem; color: var(--fg-muted); margin-top: 5px;">Active Now</div>
                        </div>
                        <div class="stat-card" onclick="openStatModal('pending')">
                            <div class="stat-val" id="stat-adv">0</div>
                            <div style="font-size: 0.8rem; color: var(--fg-muted); margin-top: 5px;">Pending Advances</div>
                        </div>
                        <div class="stat-card" onclick="openStatModal('checkins')">
                            <div class="stat-val" id="stat-checkins">0</div>
                            <div style="font-size: 0.8rem; color: var(--fg-muted); margin-top: 5px;">Present Today</div>
                        </div>
                    </div>
                    
                    <h3 style="margin-top: 24px; margin-bottom: 12px; display: flex; justify-content: space-between;">
                        Live Operations Map 
                        <span class="text-xs text-muted" style="font-weight: 400;">GPS Enabled</span>
                    </h3>
                    <div id="map-container"></div>
                </div>

                <div class="card">
                    <h2>Security Log <span class="text-xs text-muted font-normal">Recent Access</span></h2>
                    <div style="overflow-x: auto;">
                        <table class="log-table">
                            <thead><tr><th>User</th><th>Device</th><th>IP</th><th>Time</th></tr></thead>
                            <tbody id="security-log-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Team View -->
            <div id="admin-view-team" class="hidden">
                <div class="card">
                    <h2>Team Directory <button class="btn btn-sm btn-primary" onclick="openEmpModal()" style="margin-left: auto;"><i class="fa-solid fa-plus"></i> Add</button></h2>
                    <div id="team-list"></div>
                </div>
            </div>

            <!-- Advances View -->
            <div id="admin-view-advances" class="hidden">
                <div class="card">
                    <h2>Advance Requests <span class="text-xs text-muted font-normal">Finance Approval</span></h2>
                    <div id="admin-advance-list"></div>
                </div>
            </div>

            <!-- Leaves View -->
            <div id="admin-view-leaves" class="hidden">
                <div class="card">
                    <h2>Leave Requests <span class="text-xs text-muted font-normal">HR Approval</span></h2>
                    <div id="admin-leave-list"></div>
                </div>
            </div>

            <!-- Communication Hub -->
            <div id="admin-view-msg" class="hidden">
                <div class="card">
                    <h2>Communication Hub</h2>
                    <div class="settings-grid">
                        <div class="stat-card" onclick="openMsgModal('chat')">
                            <i class="fa-brands fa-whatsapp" style="font-size: 2rem; color: var(--success); margin-bottom: 10px;"></i>
                            <div style="font-weight: 600;">WhatsApp Chat</div>
                            <div class="text-xs text-muted">Direct / Group</div>
                        </div>
                        <div class="stat-card" onclick="openMsgModal('meeting')">
                            <i class="fa-solid fa-video" style="font-size: 2rem; color: var(--purple); margin-bottom: 10px;"></i>
                            <div style="font-weight: 600;">Schedule Meeting</div>
                            <div class="text-xs text-muted">Link & Notifications</div>
                        </div>
                        <div class="stat-card" onclick="openMsgModal('important')">
                            <i class="fa-solid fa-file-excel" style="font-size: 2rem; color: var(--accent); margin-bottom: 10px;"></i>
                            <div style="font-weight: 600;">Important Doc</div>
                            <div class="text-xs text-muted">Send Excel/PDF via WA</div>
                        </div>
                        <div class="stat-card" onclick="openMsgModal('projector')">
                            <i class="fa-solid fa-bell" style="font-size: 2rem; color: var(--info); margin-bottom: 10px;"></i>
                            <div style="font-weight: 600;">Service Reminder</div>
                            <div class="text-xs text-muted">DCI / Non-DCI Alerts</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div id="admin-view-reports" class="hidden">
                <div class="card">
                    <h2>Attendance Reports</h2>
                    <div class="settings-grid">
                        <div>
                            <div class="input-group"><label>Report Type</label>
                                <select id="report-type-select" onchange="toggleReportDateInput()">
                                    <option value="daily">Daily Report</option>
                                    <option value="monthly">Monthly Summary</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Select Company (Optional)</label>
                                <select id="report-company-select" multiple style="height: 100px;">
                                    <option value="all">All Companies</option>
                                </select>
                            </div>
                            <div class="input-group" id="report-date-container">
                                <label id="report-date-label">Select Date</label>
                                <input type="date" id="report-date-input">
                            </div>
                            <button class="btn btn-primary" onclick="generateReport()"><i class="fa-solid fa-magnifying-glass"></i> Generate Report</button>
                        </div>
                        <div class="flex flex-col justify-center items-center text-center" style="background: rgba(0,0,0,0.2); border-radius: var(--radius); padding: 20px;">
                            <div class="text-sm text-muted mb-2">Default Sender Email</div>
                            <div class="code-font" id="report-sender-display">Not Configured</div>
                        </div>
                    </div>
                </div>

                <div id="report-result-card" class="card hidden">
                    <h2>Report <span id="report-period-display"></span></h2>
                    <div style="overflow-x: auto;">
                        <table class="log-table" id="report-table"></table>
                    </div>
                    <div class="settings-grid" style="margin-top: 20px;">
                        <button class="btn btn-ghost" onclick="downloadReportPDF()"><i class="fa-solid fa-file-pdf"></i> Export PDF</button>
                        <button class="btn btn-ghost" onclick="shareReport('wa')"><i class="fa-brands fa-whatsapp"></i> WhatsApp</button>
                    </div>
                </div>
            </div>

            <!-- Cloud Storage Manager (Admin) -->
            <div id="admin-view-cloud" class="hidden">
                <div class="card">
                    <h2>
                        Cloud Storage Manager 
                        <div style="display:flex; gap:5px;">
                             <button class="btn btn-sm btn-primary" onclick="toggleActiveDrive('gdrive')" style="background: var(--info);"><i class="fa-brands fa-google-drive"></i> G-Drive</button>
                             <button class="btn btn-sm btn-primary" onclick="toggleActiveDrive('pcloud')" style="background: var(--success);"><i class="fa-solid fa-cloud"></i> P-Cloud</button>
                        </div>
                    </h2>
                    <p class="text-xs text-muted mb-4">Current Active Source: <span id="active-drive-name" class="font-bold text-accent">Google Drive</span></p>
                    
                    <div class="input-group">
                        <label id="active-drive-label">Active Drive Link</label>
                        <div class="flex gap-2">
                            <input type="text" id="admin-drive-link" placeholder="https://drive.google.com/..." onchange="saveGlobalSettings()">
                            <button class="btn btn-primary" style="width: auto;" onclick="window.open(document.getElementById('admin-drive-link').value, '_blank')"><i class="fa-solid fa-external-link-alt"></i></button>
                        </div>
                    </div>

                    <div id="admin-cloud-list" class="file-grid mt-4">
                        <!-- Files Loaded Here -->
                        <div class="text-center text-muted w-full" style="grid-column: 1/-1;">Enter a link above or switch drive sources.</div>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="admin-view-settings" class="hidden">
                <div class="card">
                    <h2>System Configuration</h2>
                    
                    <div class="settings-grid">
                        <div>
                            <h3>Cloud & API Keys</h3>
                            <div class="input-group"><label>JSON Bin ID</label><input type="text" id="cfg-bin-id" readonly value="6989fe3fae596e708f1dd133" style="opacity: 0.7;"></div>
                            <div class="input-group"><label>JSON Master Key</label><input type="password" id="cfg-master-key" readonly value="$2a$10$31RRwjp5GFNYo/puv4Q/wOln3poLiM/SM3lXde69LjAIKizHfzYSe" style="opacity: 0.7;"></div>
                            <div class="input-group"><label>ImgBB API Key</label><input type="password" id="cfg-imgbb-key" placeholder="ImgBB Key"></div>
                        </div>
                    </div>

                    <div style="height: 1px; background: var(--border); margin: 24px 0;"></div>
                    
                    <!-- AUTOMATION SETTINGS -->
                    <div style="border: 1px solid var(--border); padding: 20px; border-radius: var(--radius); background: rgba(245, 158, 11, 0.05);">
                        <h3 style="color: var(--accent); margin-bottom: 15px;">ü§ñ WhatsApp Automation Engine</h3>
                        
                        <div class="settings-grid">
                            <div>
                                <h4 class="text-xs text-muted mb-2">API Configuration</h4>
                                <div class="input-group"><label>WhatsApp API Token</label><input type="password" id="cfg-wa-token" placeholder="Bearer Token..."></div>
                                <div class="input-group"><label>Instance ID / Phone ID</label><input type="text" id="cfg-wa-instance" placeholder="e.g. 12345678"></div>
                            </div>
                            <div>
                                <h4 class="text-xs text-muted mb-2">Group Links & Reminders</h4>
                                <div class="input-group"><label>Check-in Group Link</label><input type="text" id="cfg-wa-checkin-group" placeholder="https://chat.whatsapp.com/..."></div>
                                <div class="input-group"><label>Birthday Group Link</label><input type="text" id="cfg-wa-birthday-group" placeholder="https://chat.whatsapp.com/..."></div>
                                <div class="input-group"><label>Auto-Checkin Time</label><input type="time" id="cfg-checkin-time" value="09:30"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="height: 1px; background: var(--border); margin: 24px 0;"></div>

                    <!-- CLOUD DRIVE LINK SETTINGS -->
                    <div style="border: 1px solid var(--border); padding: 20px; border-radius: var(--radius); background: rgba(59, 130, 246, 0.05);">
                        <h3 style="color: var(--info); margin-bottom: 15px;">‚òÅÔ∏è Cloud Drive Links</h3>
                        <p class="text-xs text-muted mb-4">Configure links for both Google Drive and P-Cloud. Links are saved permanently.</p>
                        
                        <div class="settings-grid">
                            <div>
                                <div class="input-group"><label>Google Drive Link</label><input type="text" id="cfg-gdrive-link" placeholder="https://drive.google.com/..."></div>
                            </div>
                            <div>
                                <div class="input-group"><label>P-Cloud Link</label><input type="text" id="cfg-pcloud-link" placeholder="https://my.pcloud.com/..."></div>
                            </div>
                        </div>
                        
                        <div class="input-group mt-4">
                             <label>Default Cloud Storage</label>
                             <select id="cfg-active-drive" class="w-full">
                                 <option value="gdrive">Google Drive</option>
                                 <option value="pcloud">P-Cloud</option>
                             </select>
                        </div>

                        <div style="margin-top: 24px; text-align: right;">
                            <button class="btn btn-primary" onclick="saveGlobalSettings()" style="width: auto; padding-left: 30px; padding-right: 30px;">
                                <i class="fa-solid fa-save"></i> Save All Settings
                            </button>
                        </div>
                    </div>

                    <div style="height: 1px; background: var(--border); margin: 24px 0;"></div>

                    <!-- CALL REPORT UPLOAD SETTINGS -->
                    <div style="border: 1px solid var(--border); padding: 20px; border-radius: var(--radius); background: rgba(168, 85, 247, 0.05);">
                        <h3 style="color: var(--purple); margin-bottom: 15px;">üìÇ Call Report Upload Configuration</h3>
                        <p class="text-xs text-muted mb-4">Define where employees upload call reports and the target Gmail ID.</p>
                        
                        <div class="settings-grid">
                            <div>
                                <div class="input-group"><label>Target Gmail ID</label><input type="email" id="cfg-call-report-email" placeholder="reports@company.com"></div>
                                <p class="text-xs text-muted mt-2">Reports will be sent to this address.</p>
                            </div>
                            <div>
                                <div class="input-group"><label>Upload Destination</label>
                                    <select id="cfg-call-report-dest">
                                        <option value="gdrive">Google Drive</option>
                                        <option value="pcloud">P-Cloud</option>
                                    </select>
                                </div>
                                <p class="text-xs text-muted mt-2">Employees will be prompted to upload to this location.</p>
                            </div>
                        </div>
                         <div style="margin-top: 24px; text-align: right;">
                            <button class="btn btn-primary" onclick="saveCallReportSettings()" style="width: auto; padding-left: 30px; padding-right: 30px;">
                                <i class="fa-solid fa-save"></i> Save Report Settings
                            </button>
                        </div>
                    </div>

                </div>
            </div>
        </section>

        <!-- Employee Panel -->
        <section id="employee-panel" class="screen hidden">
            <!-- Home View -->
            <div id="emp-view-home">
                <div class="card">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="profile-photo" id="emp-dash-photo"><i class="fa-solid fa-user"></i></div>
                        <div>
                            <h2 id="emp-dash-name" style="margin: 0; border: none; padding: 0; font-size: 1.3rem;">Employee</h2>
                            <div class="text-xs text-muted" id="emp-dash-role">Designation</div>
                        </div>
                    </div>

                    <div class="text-center" style="margin: 32px 0;">
                        <div id="clock-display" style="font-size: 3rem; font-weight: 700; font-family: var(--font-display); color: var(--fg); text-shadow: 0 0 20px rgba(255,255,255,0.1);">--:--</div>
                        <div id="date-display" style="color: var(--accent); font-size: 0.9rem; margin-top: 4px; font-weight: 600;"></div>
                    </div>

                    <button id="btn-check-in" class="btn btn-primary" onclick="performCheckIn()"><i class="fa-solid fa-location-dot"></i> Check In</button>
                    <button id="btn-check-out" class="btn btn-danger hidden" onclick="performCheckOut()"><i class="fa-solid fa-person-walking-arrow-right"></i> Check Out</button>
                    
                    <div id="att-status" class="hidden" style="margin-top: 20px; background: rgba(0,0,0,0.3); padding: 16px; border-radius: 12px; text-align: center; border: 1px solid var(--border);">
                        <div class="text-xs text-muted">Current Status</div>
                        <div class="badge approved" style="font-size: 0.9rem; margin: 4px 0;">Checked In</div>
                        <div style="margin-top: 8px; font-size: 0.95rem; font-weight: 600;" id="att-times">--:--</div>
                    </div>
                </div>

                <!-- RESTORED: My Requests (Advances & Leaves) -->
                <div class="card">
                    <h2>My Requests</h2>
                    <div class="input-group">
                         <label>Quick Action</label>
                         <div style="display:flex; gap:10px;">
                             <button class="btn btn-ghost" onclick="openAdvanceModal()"><i class="fa-solid fa-money-bill-wave"></i> Advance</button>
                             <button class="btn btn-ghost" onclick="openLeaveModal()"><i class="fa-regular fa-calendar-check"></i> Leave</button>
                         </div>
                    </div>
                    <div id="my-advance-list" style="margin-bottom: 16px;"></div>
                    <div id="my-leave-list"></div>
                </div>
            </div>

            <!-- Call Tab View -->
            <div id="emp-view-call" class="hidden">
                <div class="card">
                    <h2>Field Call Update <button class="btn btn-sm btn-primary" onclick="openCallModal()" style="margin-left: auto;"><i class="fa-solid fa-plus"></i> Upload Report</button></h2>
                    <div id="call-list" class="list-container mt-4">
                        <div class="p-3 text-center text-muted">No call reports found.</div>
                    </div>
                </div>
            </div>

            <!-- Chat Tab View -->
            <div id="emp-view-chat" class="hidden">
                <div class="card" style="padding: 0; height: calc(100vh - 180px); overflow: hidden;">
                    <div class="chat-layout">
                        <div class="chat-sidebar" id="emp-chat-sidebar">
                            <div class="chat-header">
                                <span>Chats</span>
                                <button class="btn btn-sm btn-primary" onclick="openNewChatModal()"><i class="fa-solid fa-plus"></i> New</button>
                            </div>
                            <div id="emp-contact-list" style="overflow-y: auto; flex: 1;"></div>
                        </div>
                        <div class="chat-main" id="emp-chat-main">
                            <div class="chat-header">
                                <div class="flex items-center gap-2">
                                    <button class="btn btn-sm btn-ghost hidden" id="emp-back-to-list" onclick="toggleEmpChatView(false)" style="width:30px; padding:0;"><i class="fa-solid fa-arrow-left"></i></button>
                                    <div id="emp-current-chat-name" style="font-size: 0.95rem;">Select a chat</div>
                                </div>
                                <button class="btn btn-sm btn-ghost" onclick="openChatOptions()"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                            </div>
                            <div class="chat-messages" id="emp-messages-container">
                                <div class="text-center text-muted" style="margin-top: 50px;">Select a contact to start chatting</div>
                            </div>
                            <div class="chat-input-area">
                                <input type="text" id="emp-chat-input" placeholder="Type a message..." onkeypress="handleChatInputKey(event)">
                                <button class="btn btn-primary" style="width: auto;" onclick="sendEmpMessage()"><i class="fa-solid fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cloud Storage View (Employee) -->
            <div id="emp-view-cloud" class="hidden">
                <div class="card">
                    <h2>Cloud Storage <span class="badge online" style="margin-left:auto;" id="emp-active-drive-badge">G-Drive</span></h2>
                    <p class="text-xs text-muted mb-4">Shared resources from Admin.</p>
                    
                    <div class="input-group">
                        <label id="emp-drive-label">Link</label>
                        <div class="flex gap-2">
                            <input type="text" id="emp-drive-link" placeholder="https://drive.google.com/..." readonly>
                            <button class="btn btn-primary" style="width: auto;" onclick="window.open(document.getElementById('emp-drive-link').value, '_blank')"><i class="fa-brands fa-google-drive"></i> Open</button>
                        </div>
                    </div>

                    <div id="emp-cloud-list" class="file-grid mt-4">
                         <div class="text-center text-muted w-full" style="grid-column: 1/-1;">Waiting for Admin to configure Drive Link...</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Navigation: Admin -->
    <nav id="admin-nav" class="tab-nav hidden">
        <button class="tab-btn active" onclick="switchAdminTab('dashboard', this)"><i class="fa-solid fa-chart-pie"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('team', this)"><i class="fa-solid fa-users"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('advances', this)"><i class="fa-solid fa-money-bill-transfer"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('leaves', this)"><i class="fa-regular fa-calendar-check"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('msg', this)"><i class="fa-solid fa-comments"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('reports', this)"><i class="fa-solid fa-file-invoice"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('cloud', this)"><i class="fa-solid fa-cloud"></i></button>
        <button class="tab-btn" onclick="switchAdminTab('settings', this)"><i class="fa-solid fa-cogs"></i></button>
        <button class="tab-btn" onclick="openAdminProfileModal()"><i class="fa-solid fa-user-shield"></i></button>
        <button class="tab-btn exit-btn" onclick="logout()"><i class="fa-solid fa-power-off"></i></button>
    </nav>
    
    <!-- Navigation: Employee -->
    <nav id="emp-nav" class="tab-nav hidden">
        <button class="tab-btn active" onclick="switchEmpTab('home', this)"><i class="fa-solid fa-house"></i></button>
        <button class="tab-btn" onclick="switchEmpTab('call', this)"><i class="fa-solid fa-phone"></i></button>
        <button class="tab-btn" onclick="switchEmpTab('chat', this)"><i class="fa-solid fa-comments"></i></button>
        <button class="tab-btn" onclick="switchEmpTab('cloud', this)"><i class="fa-solid fa-cloud"></i></button>
        <button class="tab-btn exit-btn" onclick="logout()"><i class="fa-solid fa-power-off"></i></button>
    </nav>

    <div id="toast-box" class="toast-container"></div>

    <!-- Modals -->
    <!-- Call Modal -->
    <div id="callModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Upload Call Report</h2>
            <p class="text-xs text-muted mb-4">Upload link to: <span id="call-modal-target-email" class="text-accent font-bold">admin@company.com</span></p>
            
            <div class="input-group"><label>Complain Number</label><input type="text" id="call-comp-no"></div>
            <div class="input-group"><label>Date</label><input type="date" id="call-date"></div>
            <div class="input-group"><label>Remark</label><textarea id="call-remark" rows="3"></textarea></div>
            
            <!-- Upload Link Only -->
            <div class="input-group">
                <label>Upload Report Link (Drive/P-Cloud)</label>
                <div class="flex gap-2">
                    <input type="text" id="call-drive-link" placeholder="Paste Report Link here">
                    <button class="btn btn-primary" style="width: auto;" onclick="window.open('https://drive.google.com/', '_blank')"><i class="fa-brands fa-google-drive"></i> Drive</button>
                    <button class="btn btn-success" style="width: auto;" onclick="window.open('https://my.pcloud.com/', '_blank')"><i class="fa-solid fa-cloud"></i> P-Cloud</button>
                </div>
            </div>

            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" onclick="saveCallRecord()">Upload Report</button>
                <button class="btn btn-ghost w-full" onclick="closeModal('callModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- File Upload Modal -->
    <div id="uploadModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Upload File</h2>
            <div class="input-group"><label>Select File</label><input type="file" id="admin-upload-file"></div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" onclick="uploadAdminFile()">Save Link</button>
                <button class="btn btn-ghost w-full" onclick="closeModal('uploadModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Advance Modal -->
    <div id="advReqModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Request Advance</h2>
            <div class="input-group"><label>Amount (INR)</label><input type="number" id="adv-amount"></div>
            <div class="input-group"><label>Reason</label><textarea id="adv-reason" rows="2"></textarea></div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" onclick="submitAdvance()">Send Request</button>
                <button class="btn btn-ghost w-full" onclick="closeModal('advReqModal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Leave Modal -->
    <div id="leaveReqModal" class="modal-overlay">
        <div class="modal-content">
            <h2>Apply for Leave</h2>
            <div class="input-group"><label>Leave Type</label>
                <select id="leave-type">
                    <option value="Sick Leave">Sick Leave</option>
                    <option value="Casual Leave">Casual Leave</option>
                    <option value="Earned Leave">Earned Leave</option>
                </select>
            </div>
            <div class="input-group"><label>Start Date</label><input type="date" id="leave-start"></div>
            <div class="input-group mb-0"><label>End Date</label><input type="date" id="leave-end"></div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" onclick="submitLeave()">Submit Request</button>
                <button class="btn btn-ghost w-full" onclick="closeModal('leaveReqModal')">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- New Chat Modal -->
    <div id="newChatModal" class="modal-overlay">
        <div class="modal-content">
            <h2>New Conversation</h2>
            <div class="input-group">
                <label>Recipients</label>
                <select id="new-chat-recipients" multiple style="height: 150px;">
                    <!-- Populated via JS -->
                </select>
            </div>
            <div class="flex gap-2 mt-4">
                <button class="btn btn-primary w-full" onclick="startNewChat()">Start Chat</button>
                <button class="btn btn-ghost w-full" onclick="closeModal('newChatModal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CONFIG = {
            JSON_BIN_ID: '6989fe3fae596e708f1dd133',
            JSON_BIN_KEY: '$2a$10$31RRwjp5GFNYo/puv4Q/wOln3poLiM/SM3lXde69LjAIKizHfzYSe',
        };

        const DEFAULT_DB = {
            admins: [{ id: 'admin', pass: 'admin', name: 'Super Admin', photo: '', mobile: '', email: '' }],
            employees: [],
            companies: [],
            advances: [],
            leaves: [],
            attendance: [],
            logs: [],
            calls: [], // { id, empId, compNo, date, remark, driveLink, fileName, fileUrl }
            messages: [],
            chats: [],
            settings: {
                binId: CONFIG.JSON_BIN_ID,
                masterKey: CONFIG.JSON_BIN_KEY,
                imgbbKey: '',
                senderEmail: '',
                trackingEnabled: true,
                
                // Automation Settings
                waToken: "",
                waInstanceId: "",
                waCheckInGroup: "",
                waBirthdayGroup: "",
                checkInTime: "09:30",
                
                // Drive Settings
                gdriveLink: "",
                pcloudLink: "",
                activeDrive: "gdrive", // 'gdrive' or 'pcloud'
                
                // Call Report Settings
                callReportEmail: "admin@company.com",
                callReportDest: "gdrive" // 'gdrive' or 'pcloud'
            }
        };

        let APP = {
            user: null,
            db: JSON.parse(JSON.stringify(DEFAULT_DB)),
            map: null,
            isLocalMode: false,
            activeChatId: null
        };

        // --- INIT ---
        window.onload = () => {
            loadSettings();
            loadData();
            startClock();
            document.getElementById('report-date-input').value = new Date().toISOString().split('T')[0];
        };

        // --- DATA & AUTH ---
        function loadData() {
            if (APP.db.settings.binId && APP.db.settings.masterKey && !APP.isLocalMode) {
                fetch(`https://api.jsonbin.io/v3/b/${APP.db.settings.binId}/latest`, {
                    headers: { 'X-Master-Key': APP.db.settings.masterKey }
                })
                .then(r => r.json())
                .then(res => {
                    if(res.record) {
                        APP.db = { ...DEFAULT_DB, ...res.record };
                        APP.db.settings = { ...DEFAULT_DB.settings, ...res.record.settings };
                        // Ensure arrays exist
                        if(!APP.db.chats) APP.db.chats = [];
                        if(!APP.db.messages) APP.db.messages = [];
                        if(!APP.db.calls) APP.db.calls = [];
                        
                        loadSettings();
                        renderUI();
                        updateCloudStatus('online');
                    }
                })
                .catch(() => {
                    loadLocalBackup();
                    updateCloudStatus('error');
                });
            } else {
                loadLocalBackup();
                updateCloudStatus(APP.isLocalMode ? 'local' : 'error');
            }
        }

        function loadLocalBackup() {
            const local = localStorage.getItem('nexushr_db_v3');
            if(local) APP.db = { ...DEFAULT_DB, ...JSON.parse(local) };
            if(!APP.db.chats) APP.db.chats = [];
            if(!APP.db.messages) APP.db.messages = [];
            if(!APP.db.calls) APP.db.calls = [];
            renderUI();
        }

        function saveData() {
            localStorage.setItem('nexushr_db_v3', JSON.stringify(APP.db));
            if(!APP.isLocalMode) syncToCloud();
        }

        function syncToCloud() {
            if(!APP.db.settings.binId || !APP.db.settings.masterKey) return;
            document.getElementById('cloud-indicator').textContent = 'Syncing...';
            fetch(`https://api.jsonbin.io/v3/b/${APP.db.settings.binId}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'X-Master-Key': APP.db.settings.masterKey 
                },
                body: JSON.stringify(APP.db)
            })
            .then(() => updateCloudStatus('online'))
            .catch(() => updateCloudStatus('error'));
        }

        function updateCloudStatus(status) {
            const el = document.getElementById('cloud-indicator');
            if(status === 'online') { el.textContent = 'Cloud Synced'; el.className = 'badge online'; }
            else if(status === 'error') { el.textContent = 'Cloud Error'; el.className = 'badge rejected'; }
            else { el.textContent = 'Local Mode'; el.className = 'badge pending'; }
        }

        function handleLogin(e) {
            e.preventDefault();
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;
            if(u === APP.db.admins[0].id && p === APP.db.admins[0].pass) {
                postLogin(APP.db.admins[0], 'admin');
                return;
            }
            const emp = APP.db.employees.find(x => x.id === u && x.pass === p);
            if(emp) { postLogin(emp, 'employee'); return; }
            showToast('Invalid credentials', 'error');
        }

        function postLogin(user, role) {
            APP.user = user;
            document.getElementById('login-screen').classList.add('hidden');
            if(role === 'admin') {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-nav').classList.remove('hidden');
                renderAdminDashboard();
                setTimeout(initMap, 100);
            } else {
                document.getElementById('employee-panel').classList.remove('hidden');
                document.getElementById('emp-nav').classList.remove('hidden');
                renderEmployeeDashboard();
                loadEmpChatContacts();
            }
        }

        // --- CHAT SYSTEM ---
        function loadEmpChatContacts() {
            const list = document.getElementById('emp-contact-list');
            list.innerHTML = '';

            const myChats = APP.db.chats.filter(c => c.participants.includes(APP.user.id));
            if(myChats.length === 0) {
                list.innerHTML = '<div class="p-3 text-center text-muted">No active chats.<br>Click + to start.</div>';
                return;
            }

            myChats.forEach(chat => {
                let otherIds = chat.participants.filter(id => id !== APP.user.id);
                let names = otherIds.map(id => id === 'admin' ? 'Admin' : (APP.db.employees.find(e=>e.id===id)?.name || 'Unknown')).join(', ');
                const msgs = APP.db.messages.filter(m => m.chatId === chat.id);
                const lastMsg = msgs.length > 0 ? msgs[msgs.length - 1].text : 'No messages';
                const time = msgs.length > 0 ? new Date(msgs[msgs.length - 1].timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

                const item = document.createElement('div');
                item.className = `contact-item ${APP.activeChatId === chat.id ? 'active' : ''}`;
                item.onclick = () => openChat(chat.id);
                item.innerHTML = `
                    <div class="profile-photo sm"><i class="fa-solid fa-user"></i></div>
                    <div class="contact-info">
                        <div class="contact-name">${names}</div>
                        <div class="contact-last-msg">${lastMsg} <span style="float:right; opacity:0.5; font-size:0.7em;">${time}</span></div>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function openChat(chatId) {
            APP.activeChatId = chatId;
            loadEmpChatContacts();
            const chat = APP.db.chats.find(c => c.id === chatId);
            let names = chat.participants.filter(id => id !== APP.user.id).map(id => id === 'admin' ? 'Admin' : (APP.db.employees.find(e=>e.id===id)?.name || 'Unknown')).join(', ');
            document.getElementById('emp-current-chat-name').textContent = names;

            const container = document.getElementById('emp-messages-container');
            container.innerHTML = '';
            const msgs = APP.db.messages.filter(m => m.chatId === chatId).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            msgs.forEach(m => {
                const isMe = m.senderId === APP.user.id;
                const bubble = document.createElement('div');
                bubble.className = `message-bubble ${isMe ? 'msg-sent' : 'msg-received'}`;
                bubble.innerHTML = `${escapeHtml(m.text)}<span class="msg-meta">${new Date(m.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>`;
                container.appendChild(bubble);
            });
            container.scrollTop = container.scrollHeight;
            document.getElementById('emp-chat-main').classList.add('mobile-visible');
        }

        function sendEmpMessage() {
            const input = document.getElementById('emp-chat-input');
            const text = input.value.trim();
            if(!text || !APP.activeChatId) return;
            APP.db.messages.push({ id: Date.now(), chatId: APP.activeChatId, senderId: APP.user.id, text: text, timestamp: new Date().toISOString() });
            saveData();
            input.value = '';
            openChat(APP.activeChatId);
            loadEmpChatContacts();
        }
        
        function openNewChatModal() {
            const select = document.getElementById('new-chat-recipients');
            select.innerHTML = '';
            const adminOpt = document.createElement('option');
            adminOpt.value = 'admin';
            adminOpt.textContent = 'Admin (Super Admin)';
            select.appendChild(adminOpt);
            APP.db.employees.forEach(e => {
                if(e.id !== APP.user.id) {
                    const opt = document.createElement('option');
                    opt.value = e.id;
                    opt.textContent = `${e.name} (${e.id})`;
                    select.appendChild(opt);
                }
            });
            document.getElementById('newChatModal').classList.add('open');
        }

        function startNewChat() {
            const select = document.getElementById('new-chat-recipients');
            const selected = Array.from(select.selectedOptions).map(o => o.value);
            if(selected.length === 0) return showToast('Select recipient', 'error');
            const participants = [APP.user.id, ...selected].sort();
            const chatId = participants.join('-');
            let chat = APP.db.chats.find(c => c.id === chatId);
            if(!chat) {
                chat = { id: chatId, participants: participants, createdAt: new Date().toISOString() };
                APP.db.chats.push(chat);
                saveData();
            }
            closeModal('newChatModal');
            loadEmpChatContacts();
            openChat(chatId);
        }

        // --- CALL LOGIC ---
        function openCallModal() {
            document.getElementById('call-comp-no').value = '';
            document.getElementById('call-date').value = '';
            document.getElementById('call-remark').value = '';
            document.getElementById('call-drive-link').value = ''; 
            
            // Show Target Email
            const email = APP.db.settings.callReportEmail || "Not Configured";
            document.getElementById('call-modal-target-email').textContent = email;
            
            document.getElementById('callModal').classList.add('open');
        }

        function saveCallRecord() {
            const compNo = document.getElementById('call-comp-no').value;
            const date = document.getElementById('call-date').value;
            const remark = document.getElementById('call-remark').value;
            const driveLink = document.getElementById('call-drive-link').value; // Get Drive Link
            
            if(!compNo || !date) return showToast("Fields required", "error");
            if(!driveLink) return showToast("Report Link is required", "error");
            
            APP.db.calls.push({
                id: Date.now(),
                empId: APP.user.id,
                empName: APP.user.name,
                compNo: compNo,
                date: date,
                remark: remark,
                driveLink: driveLink, // Save Drive Link
                timestamp: new Date().toISOString()
            });

            saveData();
            renderCallList();
            closeModal('callModal');
            showToast("Call Report Uploaded", "success");
        }

        function renderCallList() {
            const list = document.getElementById('call-list');
            const myCalls = APP.db.calls.filter(c => c.empId === APP.user.id);
            if(myCalls.length === 0) {
                list.innerHTML = '<div class="p-3 text-center text-muted">No records found.</div>';
                return;
            }
            list.innerHTML = myCalls.map(c => `
                <div class="list-item">
                    <div class="list-item-content">
                        <div>
                            <div style="font-weight:600;">${c.compNo}</div>
                            <div class="text-xs text-muted">${c.date} | ${c.remark}</div>
                        </div>
                    </div>
                    <!-- Download Button -->
                    <a href="${c.driveLink}" target="_blank" class="btn btn-sm btn-primary" style="background:var(--info); width: auto;">
                        <i class="fa-solid fa-download"></i> Download
                    </a>
                </div>
            `).join('');
        }

        // --- DRIVE LINK LOGIC ---
        function uploadAdminFile() {
            closeModal('uploadModal');
            showToast("Please enter the link in the Cloud Drive Link field.", "info");
        }

        function loadAdminCloudFiles() {
            updateCloudDisplay(); 
        }

        // New: Toggle between G-Drive and P-Cloud
        function toggleActiveDrive(driveType) {
            APP.db.settings.activeDrive = driveType;
            saveData();
            updateCloudDisplay();
            showToast(`Switched to ${driveType === 'gdrive' ? 'Google Drive' : 'P-Cloud'}`, "info");
        }

        function updateCloudDisplay() {
            const active = APP.db.settings.activeDrive || 'gdrive';
            const link = active === 'gdrive' ? APP.db.settings.gdriveLink : APP.db.settings.pcloudLink;
            const label = active === 'gdrive' ? 'Google Drive Link' : 'P-Cloud Link';
            const name = active === 'gdrive' ? 'Google Drive' : 'P-Cloud';
            
            // Update Admin Cloud Tab
            document.getElementById('admin-drive-link').value = link || "";
            document.getElementById('active-drive-label').textContent = label;
            document.getElementById('active-drive-name').textContent = name;
            
            // Update Employee Cloud Tab
            document.getElementById('emp-drive-link').value = link || "";
            document.getElementById('emp-drive-label').textContent = label;
            document.getElementById('emp-active-drive-badge').textContent = active === 'gdrive' ? 'G-Drive' : 'P-Cloud';
        }

        // --- EMPLOYEE ADVANCE & LEAVE LOGIC ---
        function openAdvanceModal() {
            document.getElementById('adv-amount').value = '';
            document.getElementById('adv-reason').value = '';
            document.getElementById('advReqModal').classList.add('open');
        }

        function submitAdvance() {
            const amt = document.getElementById('adv-amount').value;
            if(!amt) return showToast('Enter amount', 'error');
            APP.db.advances.push({ id: Date.now().toString(), empId: APP.user.id, empName: APP.user.name, amount: amt, reason: document.getElementById('adv-reason').value, date: new Date().toISOString().split('T')[0], status: 'Pending' });
            saveData();
            closeModal('advReqModal');
            showMyAdvances();
            showToast('Request Sent', 'success');
        }

        function openLeaveModal() {
            document.getElementById('leave-type').value = 'Sick Leave';
            document.getElementById('leave-start').value = '';
            document.getElementById('leave-end').value = '';
            document.getElementById('leaveReqModal').classList.add('open');
        }

        function submitLeave() {
            const type = document.getElementById('leave-type').value;
            const start = document.getElementById('leave-start').value;
            const end = document.getElementById('leave-end').value;
            if(!start || !end) { showToast('Please select dates', 'error'); return; }
            APP.db.leaves.push({ id: Date.now().toString(), empId: APP.user.id, empName: APP.user.name, type: type, start: start, end: end, dateApplied: new Date().toISOString().split('T')[0], status: 'Pending' });
            saveData();
            closeModal('leaveReqModal');
            showMyLeaves();
            showToast('Leave Request Sent', 'success');
        }

        function showMyAdvances() {
            const list = document.getElementById('my-advance-list');
            const mine = APP.db.advances.filter(a => a.empId === APP.user.id).reverse();
            list.innerHTML = mine.map(a => `<div class="list-item" style="padding: 8px 12px;"><div class="flex justify-between w-full"><span>Rs. ${a.amount}</span><span class="badge ${a.status.toLowerCase()}">${a.status}</span></div><div class="text-xs text-muted">${a.date}</div></div>`).join('');
        }

        function showMyLeaves() {
            const list = document.getElementById('my-leave-list');
            const mine = APP.db.leaves.filter(l => l.empId === APP.user.id).reverse();
            list.innerHTML = mine.map(l => `<div class="list-item" style="padding: 8px 12px;"><div class="flex justify-between w-full"><span>${l.type}</span><span class="badge ${l.status.toLowerCase()}">${a.status}</span></div><div class="text-xs text-muted">${l.start} to ${l.end}</div></div>`).join('');
        }

        // --- ADMIN UI HELPERS ---
        function renderAdminDashboard() {
            document.getElementById('stat-total').textContent = APP.db.employees.length;
            document.getElementById('stat-online').textContent = Math.floor(APP.db.employees.length * 0.7);
            document.getElementById('stat-adv').textContent = APP.db.advances.filter(a => a.status === 'Pending').length;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('stat-checkins').textContent = APP.db.attendance.filter(a => a.date === today).length;
            renderSecurityLog();
        }

        function renderSecurityLog() {
            const tbody = document.getElementById('security-log-body');
            tbody.innerHTML = APP.db.logs.slice(0, 5).map(l => `<tr><td>${l.user}</td><td class="text-xs text-muted">${l.device}</td><td class="code-font">${l.ip}</td><td class="text-xs">${l.time.split(',')[1]}</td></tr>`).join('') || '<tr><td colspan="4" class="text-center text-muted">No logs yet</td></tr>';
        }

        function initMap() {
            if (APP.map) { APP.map.invalidateSize(); return; }
            const mapContainer = document.getElementById('map-container');
            if(!mapContainer || mapContainer.offsetParent === null) return;
            APP.map = L.map('map-container').setView([20.5937, 78.9629], 5); 
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(APP.map);
            const today = new Date().toISOString().split('T')[0];
            let markerCount = 0;
            APP.db.employees.forEach(emp => {
                const lastAtt = APP.db.attendance.find(a => a.empId === emp.id && a.date === today);
                if(lastAtt && lastAtt.lat) { 
                    L.marker([lastAtt.lat, lastAtt.lng]).addTo(APP.map).bindPopup(`<b>${emp.name}</b><br>Checked In: ${lastAtt.in}`); 
                    markerCount++;
                }
            });
            if(markerCount === 0) {
                APP.db.employees.forEach(emp => {
                   if(emp.companyId) L.marker([20.5937 + (Math.random()-0.5)*5, 78.9629 + (Math.random()-0.5)*5]).addTo(APP.map).bindPopup(`<b>${emp.name}</b><br><span style="color:#888">Location Estimate</span>`);
                });
            }
        }

        // --- UTILS ---
        function startClock() {
            setInterval(() => {
                const now = new Date();
                const el = document.getElementById('clock-display');
                if(el) el.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                const d = document.getElementById('date-display');
                if(d) d.textContent = now.toLocaleDateString(undefined, {weekday: 'long', month: 'short', day: 'numeric'});
            }, 1000);
        }

        function switchAdminTab(tab, btn) {
            document.querySelectorAll('#admin-nav .tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('#admin-panel > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(`admin-view-${tab}`).classList.remove('hidden');
            if(tab === 'dashboard') setTimeout(initMap, 100);
            if(tab === 'cloud') updateCloudDisplay();
        }

        function switchEmpTab(tab, btn) {
            document.querySelectorAll('#emp-nav .tab-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('#employee-panel > div').forEach(d => d.classList.add('hidden'));
            document.getElementById(`emp-view-${tab}`).classList.remove('hidden');
            if(tab === 'call') renderCallList();
            if(tab === 'chat') loadEmpChatContacts();
            if(tab === 'cloud') updateCloudDisplay(); // Syncs the drive link
        }

        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        function showToast(msg, type='success') {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerHTML = type === 'success' ? `<i class="fa-solid fa-check-circle"></i> ${msg}` : `<i class="fa-solid fa-circle-info"></i> ${msg}`;
            document.getElementById('toast-box').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        function saveGlobalSettings() {
            // Save WA Settings
            APP.db.settings.waToken = document.getElementById('cfg-wa-token').value;
            APP.db.settings.waInstanceId = document.getElementById('cfg-wa-instance').value;
            APP.db.settings.waCheckInGroup = document.getElementById('cfg-wa-checkin-group').value;
            APP.db.settings.waBirthdayGroup = document.getElementById('cfg-wa-birthday-group').value;
            APP.db.settings.checkInTime = document.getElementById('cfg-checkin-time').value;
            
            // Save Cloud Settings
            APP.db.settings.gdriveLink = document.getElementById('cfg-gdrive-link').value;
            APP.db.settings.pcloudLink = document.getElementById('cfg-pcloud-link').value;
            APP.db.settings.activeDrive = document.getElementById('cfg-active-drive').value;
            
            updateCloudDisplay();
            saveData();
            showToast("All Settings Saved Permanently");
        }
        function saveCallReportSettings() {
             APP.db.settings.callReportEmail = document.getElementById('cfg-call-report-email').value;
             APP.db.settings.callReportDest = document.getElementById('cfg-call-report-dest').value;
             saveData();
             showToast("Call Report Settings Saved");
        }
        function renderUI() {
            if(APP.user && APP.user.role === 'admin') renderAdminDashboard();
            if(APP.user && APP.user.role !== 'admin') renderEmployeeDashboard();
        }
        function renderEmployeeDashboard() {
            document.getElementById('emp-dash-name').textContent = APP.user.name;
            document.getElementById('emp-dash-role').textContent = APP.user.id;
            showMyAdvances();
            showMyLeaves();
        }
        function logout() { location.reload(); }
        function openUploadModal(role) { document.getElementById('uploadModal').classList.add('open'); }
        function openStatModal(t) { alert("Stat: "+t); }
        function handleChatInputKey(e) { if(e.key === 'Enter') sendEmpMessage(); }
        function toggleEmpChatView(show) { 
             if(show) document.getElementById('emp-chat-main').classList.add('mobile-visible');
             else document.getElementById('emp-chat-main').classList.remove('mobile-visible');
        }
        function performCheckIn() { showToast("Checked In"); }
        function performCheckOut() { showToast("Checked Out"); }
        function escapeHtml(text) { 
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;'}; 
            return text.replace(/[&<>"']/g, m => map[m]); 
        }
        function toggleLocalMode(c) { APP.isLocalMode = c.checked; document.body.classList.toggle('local-mode'); }
        function manualSync() { loadData(); }
        function loadSettings() { 
             // Load inputs with DB values
             document.getElementById('cfg-wa-token').value = APP.db.settings.waToken || "";
             document.getElementById('cfg-wa-instance').value = APP.db.settings.waInstanceId || "";
             document.getElementById('cfg-wa-checkin-group').value = APP.db.settings.waCheckInGroup || "";
             document.getElementById('cfg-wa-birthday-group').value = APP.db.settings.waBirthdayGroup || "";
             document.getElementById('cfg-checkin-time').value = APP.db.settings.checkInTime || "09:30";
             
             document.getElementById('cfg-gdrive-link').value = APP.db.settings.gdriveLink || "";
             document.getElementById('cfg-pcloud-link').value = APP.db.settings.pcloudLink || "";
             document.getElementById('cfg-active-drive').value = APP.db.settings.activeDrive || "gdrive";
             
             // Call Report Settings
             document.getElementById('cfg-call-report-email').value = APP.db.settings.callReportEmail || "";
             document.getElementById('cfg-call-report-dest').value = APP.db.settings.callReportDest || "gdrive";
             
             // Initialize Display
             updateCloudDisplay();
        }
        function openAdminProfileModal() { alert("Profile Modal"); }
        function openEmpModal() { alert("Employee Modal"); }
        function openMsgModal() { alert("Message Modal"); }
        function generateReport() { alert("Report Generated"); }
        function toggleReportDateInput() {}
        function downloadReportPDF() { alert("PDF Downloaded"); }
        function shareReport() { alert("Shared"); }
        function openChatOptions() { alert("Chat Options"); }
        function saveCloudSettings() { showToast("Saved"); }
        function renderTeamList() {} 
        function renderAdvanceListAdmin() {} 
        function renderAdminLeaves() {}
        function renderCompanyList() {}
        function loadSettingsUI() {}
    </script>
</body>
</html>