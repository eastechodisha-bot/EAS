<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAS Cloud - Status Fix</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --bg-light: #f1f5f9;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { background-color: var(--bg-light); color: var(--text-main); min-height: 100vh; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .p-4 { padding: 1rem; }
        .text-sm { font-size: 0.875rem; }
        .font-bold { font-weight: 700; }
        .text-center { text-align: center; }
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        
        .btn {
            padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; 
            font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            font-size: 0.9rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-main); }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }

        .input-group { margin-bottom: 1rem; text-align: left; }
        .input-group label { display: block; margin-bottom: 0.25rem; font-size: 0.85rem; color: var(--text-muted); }
        .input-control {
            width: 100%; padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px;
            font-size: 1rem; transition: border 0.2s;
        }
        .input-control:focus { outline: none; border-color: var(--primary); }

        /* --- AUTH SCREEN --- */
        #auth-screen {
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            background: linear-gradient(135deg, var(--primary) 0%, #1e293b 100%);
            padding: 1rem;
        }
        .auth-card {
            background: var(--surface); padding: 2rem; border-radius: 16px; 
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); width: 100%; max-width: 450px; 
            position: relative;
        }
        .role-switch {
            display: flex; background: var(--bg-light); padding: 4px; border-radius: 8px; margin-bottom: 1.5rem;
        }
        .role-btn {
            flex: 1; padding: 8px; text-align: center; border-radius: 6px; cursor: pointer; font-weight: 600; color: var(--text-muted);
        }
        .role-btn.active { background: var(--surface); color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* Version Badge Style */
        .version-badge {
            background: #eff6ff; color: var(--primary);
            padding: 4px 12px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;
            display: inline-block; margin-top: 0.5rem; border: 1px solid #dbeafe;
        }

        /* CLOUD SETTINGS IN LOGIN */
        .cloud-login-panel {
            background: #f8fafc; border: 1px dashed var(--border); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;
        }
        .cloud-login-panel h4 { font-size: 0.9rem; margin-bottom: 0.5rem; color: var(--text-muted); display: flex; justify-content: space-between; }
        
        .cloud-inputs { display: none; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .cloud-inputs.open { display: block; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Bottom Status Bar (For Emp/General) */
        .login-footer-status {
            margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center; gap: 8px;
            font-size: 0.8rem; color: var(--text-muted);
        }

        /* LED Status */
        .led { width: 10px; height: 10px; border-radius: 50%; background: #ccc; display: inline-block; box-shadow: 0 0 2px rgba(0,0,0,0.2); }
        .led.connected { background: var(--success); box-shadow: 0 0 5px var(--success); }
        .led.disconnected { background: var(--danger); }
        .led.syncing { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* --- DASHBOARD LAYOUT --- */
        #dashboard-screen { display: flex; flex-direction: column; min-height: 100vh; }
        
        /* Sidebar */
        #sidebar {
            width: 260px; background: var(--surface); border-right: 1px solid var(--border);
            position: fixed; height: 100vh; left: 0; top: 0; z-index: 50;
            transition: transform 0.3s ease;
        }
        .app-logo {
            padding: 1.5rem; font-size: 1.25rem; font-weight: bold; color: var(--primary);
            border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.5rem;
        }
        .nav-menu { padding: 1rem; flex: 1; overflow-y: auto; }
        .nav-item {
            display: flex; align-items: center; padding: 0.75rem 1rem; color: var(--text-muted);
            text-decoration: none; border-radius: 8px; margin-bottom: 0.25rem; cursor: pointer;
        }
        .nav-item:hover { background: var(--bg-light); color: var(--text-main); }
        .nav-item.active { background: #eff6ff; color: var(--primary); font-weight: 600; }
        .nav-item i { width: 24px; }

        /* Main Content */
        #main-content { margin-left: 260px; flex: 1; display: flex; flex-direction: column; min-height: 100vh; width: calc(100% - 260px); }
        
        /* Header */
        header {
            height: 64px; background: var(--surface); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 1.5rem;
            position: sticky; top: 0; z-index: 40;
        }
        .cloud-status { display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: var(--text-muted); }
        
        /* Views */
        .view-container { padding: 1.5rem; overflow-y: auto; flex: 1; }
        .card { background: var(--surface); border-radius: 10px; padding: 1.5rem; border: 1px solid var(--border); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .card h3 { margin-bottom: 1rem; color: var(--text-main); display: flex; justify-content: space-between; align-items: center; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); }
        th { color: var(--text-muted); font-weight: 600; }
        .user-avatar { border-radius: 50%; object-fit: cover; }
        .badge { padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }

        /* Map */
        #map-container { height: 400px; width: 100%; border-radius: 8px; z-index: 1; }

        /* Toast */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; pointer-events: none; }
        #toast-container > div { pointer-events: all; }

        /* Modals */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal.open { opacity: 1; pointer-events: all; }
        .modal-content { background: var(--surface); padding: 2rem; border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            #sidebar { transform: translateX(-100%); }
            #sidebar.open { transform: translateX(0); }
            #main-content { margin-left: 0; width: 100%; }
            .mobile-only { display: block; }
            .desktop-only { display: none; }
        }
    </style>
</head>
<body>

    <!-- Toast Notifications -->
    <div id="toast-container"></div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-card">
            <div class="text-center mb-4">
                <i class="fa-solid fa-cloud fa-3x" style="color:var(--primary); margin-bottom:1rem;"></i>
                <h2>EAS Cloud</h2>
                <span id="version-display" class="version-badge">v2.11.0</span>
            </div>
            
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="role-switch">
                    <div id="btn-role-emp" class="role-btn active" onclick="selectRole('EMP')">Employee</div>
                    <div id="btn-role-admin" class="role-btn" onclick="selectRole('ADMIN')">Admin</div>
                </div>

                <!-- CLOUD SETTINGS (Admin Only) -->
                <div id="admin-cloud-settings" class="cloud-login-panel hidden">
                    <h4>
                        <span><i class="fa-solid fa-server"></i> Cloud Connection</span>
                        <button type="button" class="btn btn-outline btn-sm" onclick="toggleCloudEdit()">Edit Keys</button>
                    </h4>
                    
                    <div style="font-size: 0.75rem; display: flex; align-items: center; gap: 6px; margin-top: 5px;">
                        <span id="admin-led-login" class="led disconnected"></span>
                        <span id="admin-text-login">Initializing...</span>
                    </div>

                    <!-- Manual Key Update Section -->
                    <div id="cloud-edit-area" class="cloud-inputs">
                        <div class="input-group" style="margin-bottom: 0.5rem;">
                            <label class="text-xs">Bin ID</label>
                            <input type="text" id="edit-bin-id" class="input-control" style="padding: 6px; font-size: 0.8rem;">
                        </div>
                        <div class="input-group" style="margin-bottom: 0;">
                            <label class="text-xs"> Master Key</label>
                            <input type="text" id="edit-master-key" class="input-control" style="padding: 6px; font-size: 0.8rem; letter-spacing: -0.5px;">
                        </div>
                        <button type="button" class="btn btn-primary btn-sm w-full mt-2" onclick="saveNewCloudKeys()">Save & Sync</button>
                    </div>
                </div>

                <div class="input-group">
                    <label>User ID or Email</label>
                    <input type="text" id="login-user" name="username" class="input-control" placeholder="admin or emp" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" id="login-pass" name="password" class="input-control" placeholder="1234" required>
                </div>
                <button type="submit" class="btn btn-primary w-full">Secure Login</button>
            </form>

            <!-- GENERAL STATUS BAR (Visible for everyone) -->
            <div id="login-footer-status" class="login-footer-status">
                <span id="general-led-login" class="led disconnected"></span>
                <span id="general-text-login">Checking connection...</span>
            </div>
        </div>
    </div>

    <!-- DASHBOARD SCREEN -->
    <div id="dashboard-screen" class="hidden">
        
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="app-logo">
                <i class="fa-solid fa-layer-group"></i> EAS Portal
            </div>
            
            <div class="p-4 text-center border-b" style="border-color:var(--border);">
                <img id="nav-avatar" src="" class="user-avatar" style="width:64px; height:64px; margin-bottom:0.5rem;">
                <h4 id="nav-username" class="font-bold">User</h4>
                <span id="nav-role" class="badge badge-secondary">ROLE</span>
            </div>

            <!-- Admin Menu -->
            <div id="menu-admin" class="nav-menu hidden">
                <div class="nav-item active" onclick="navTo('adm-dash')"><i class="fa-solid fa-chart-pie"></i> Dashboard</div>
                <div class="nav-item" id="adm-team" onclick="navTo('adm-team')"><i class="fa-solid fa-users"></i> Team</div>
                <div class="nav-item" id="adm-att" onclick="navTo('adm-att')"><i class="fa-solid fa-calendar-check"></i> Attendance</div>
                <div class="nav-item" id="adm-leave" onclick="navTo('adm-leave')"><i class="fa-solid fa-plane-departure"></i> Leaves</div>
                <div class="nav-item" id="adm-comp" onclick="navTo('adm-comp')"><i class="fa-solid fa-building"></i> Companies</div>
            </div>

            <!-- Employee Menu -->
            <div id="menu-emp" class="nav-menu hidden">
                <div class="nav-item active" onclick="navTo('emp-att')"><i class="fa-solid fa-location-dot"></i> Attendance</div>
                <div class="nav-item" id="emp-leave" onclick="navTo('emp-leave')"><i class="fa-solid fa-calendar-plus"></i> My Leaves</div>
                <div class="nav-item" onclick="navTo('emp-adv')"><i class="fa-solid fa-hand-holding-dollar"></i> Advance</div>
                <div class="nav-item" onclick="navTo('emp-settings')"><i class="fa-solid fa-gear"></i> Settings</div>
            </div>

            <div class="p-4 border-t" style="border-color:var(--border)">
                <button onclick="logout()" class="btn btn-outline w-full text-danger"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
            </div>
        </nav>

        <!-- Backdrop for mobile -->
        <div id="backdrop" onclick="toggleSidebar(false)" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:40;"></div>

        <!-- Main Content -->
        <main id="main-content">
            <header>
                <div class="flex items-center gap-4">
                    <i class="fa-solid fa-bars mobile-only" style="font-size:1.2rem; cursor:pointer;" onclick="toggleSidebar()"></i>
                    <h3 class="desktop-only">Enterprise Access System</h3>
                </div>
                <div class="cloud-status">
                    <div class="desktop-only text-right mr-2">
                        <div id="cloud-text">Initializing...</div>
                        <div id="desk-text" class="text-sm text-muted">Cloud Service</div>
                    </div>
                    <div id="cloud-led" class="led disconnected"></div>
                </div>
            </header>

            <div class="view-container">
                
                <!-- === ADMIN VIEWS === -->
                
                <!-- Dashboard -->
                <div id="adm-dash" class="view-section">
                    <div class="flex gap-4" style="flex-wrap: wrap;">
                        <div class="card" style="flex:1;">
                            <h3>Total Employees</h3>
                            <p class="font-bold" style="font-size:2rem;" id="dash-total-emp">0</p>
                        </div>
                        <div class="card" style="flex:1;">
                            <h3>Present Today</h3>
                            <p class="font-bold" style="font-size:2rem; color:var(--success);" id="dash-present">0</p>
                        </div>
                        <div class="card" style="flex:1;">
                            <h3>Pending Leaves</h3>
                            <p class="font-bold" style="font-size:2rem; color:var(--warning);" id="dash-leaves">0</p>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Live Attendance Map</h3>
                        <div id="map-container"></div>
                    </div>
                </div>

                <!-- Team -->
                <div id="adm-team" class="view-section hidden">
                    <div class="card">
                        <h3>Employees <button class="btn btn-primary btn-sm" onclick="openModal('modal-add-emp')">+ Add New</button></h3>
                        <div style="overflow-x:auto;">
                            <table>
                                <thead><tr><th>Avatar</th><th>Name</th><th>Company</th><th>Role</th><th>Action</th></tr></thead>
                                <tbody id="team-table"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Attendance Report -->
                <div id="adm-att" class="view-section hidden">
                    <div class="card">
                        <h3>Daily Report</h3>
                        <div class="flex gap-2 mb-4">
                            <input type="date" id="rep-date" class="input-control">
                            <button class="btn btn-primary" onclick="loadReport()">Load</button>
                            <button class="btn btn-outline" onclick="sendWhatsApp('ATTENDANCE')">Broadcast</button>
                        </div>
                        <table>
                            <thead><tr><th>Name</th><th>Check In</th><th>Check Out</th><th>Loc</th><th>Status</th><th>Action</th></tr></thead>
                            <tbody id="att-report"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Leaves -->
                <div id="adm-leave" class="view-section hidden">
                    <div class="card">
                        <h3>Leave Requests</h3>
                        <table>
                            <thead><tr><th>Employee</th><th>Dates</th><th>Reason</th><th>Action</th></tr></thead>
                            <tbody id="leave-approve-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Companies -->
                <div id="adm-comp" class="view-section hidden">
                    <div class="card">
                        <h3>Companies <button class="btn btn-danger btn-sm" onclick="delComp(null)">Purge All</button></h3>
                        <div class="flex gap-2 mb-4">
                            <input type="text" id="comp-name" placeholder="Name" class="input-control">
                            <input type="email" id="comp-email" placeholder="Email" class="input-control">
                            <button class="btn btn-success" onclick="addCompany()">Add</button>
                        </div>
                        <table>
                            <thead><tr><th>Name</th><th>Email</th><th>Action</th></tr></thead>
                            <tbody id="comp-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- === EMPLOYEE VIEWS === -->

                <!-- Emp Att -->
                <div id="emp-att" class="view-section hidden">
                    <div class="card text-center" style="padding: 3rem 1rem;">
                        <div id="clock" class="font-bold" style="font-size: 3rem; margin-bottom: 1rem;">00:00:00</div>
                        <div id="att-status" class="badge badge-warning mb-2" style="font-size: 1.2rem; padding: 0.5rem 1rem;">Not Checked In</div>
                        
                        <div class="flex gap-4 justify-center mt-4">
                            <button id="btn-emp-checkin" class="btn btn-success btn-lg" onclick="doCheckIn()">
                                <i class="fa-solid fa-fingerprint"></i> Check In
                            </button>
                            <button id="btn-emp-checkout" class="btn btn-secondary btn-lg hidden" onclick="doCheckOut()">
                                <i class="fa-solid fa-person-walking-arrow-right"></i> Check Out
                            </button>
                        </div>
                        <p class="text-sm text-muted mt-4">Location required for Check-In</p>
                    </div>
                </div>

                <!-- Emp Leaves -->
                <div id="emp-leave" class="view-section hidden">
                    <div class="card">
                        <h3>Apply for Leave</h3>
                        <div class="flex flex-col gap-2">
                            <input type="date" id="leave-from" class="input-control">
                            <input type="date" id="leave-to" class="input-control">
                            <input type="text" id="leave-reason" class="input-control" placeholder="Reason">
                            <button class="btn btn-primary" onclick="applyLeave()">Submit Request</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3>History</h3>
                        <table>
                            <thead><tr><th>Dates</th><th>Reason</th><th>Status</th></tr></thead>
                            <tbody id="emp-leave-history"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Emp Advance -->
                <div id="emp-adv" class="view-section hidden">
                    <div class="card">
                        <h3>Request Advance / Payroll Query</h3>
                        <div class="flex flex-col gap-2">
                            <select id="adv-type" class="input-control">
                                <option>Salary Advance</option>
                                <option>Reimbursement</option>
                                <option>Document Request</option>
                            </select>
                            <input type="number" id="adv-amount" class="input-control" placeholder="Amount (if applicable)">
                            <textarea id="adv-desc" class="input-control" rows="3" placeholder="Description"></textarea>
                            <button class="btn btn-primary" onclick="sendAdvanceRequest()">Send via Email</button>
                        </div>
                    </div>
                </div>

                <!-- Emp Settings -->
                <div id="emp-settings" class="view-section hidden">
                    <div class="card">
                        <h3>Profile Settings</h3>
                        <div class="input-group">
                            <label>Display Name</label>
                            <input type="text" id="set-name" class="input-control">
                        </div>
                        <div class="input-group">
                            <label>New Password</label>
                            <input type="password" id="set-pass" class="input-control" placeholder="Leave blank to keep current">
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">Update Profile</button>
                    </div>
                    <div class="card">
                        <h3>App Permissions</h3>
                        <div class="flex gap-2">
                            <button class="btn btn-outline" onclick="requestPerms()"><i class="fa-solid fa-location-crosshairs"></i> GPS</button>
                            <button class="btn btn-outline" onclick="requestNotif()"><i class="fa-solid fa-bell"></i> Notify</button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- === MODALS === -->

    <!-- Add Employee Modal -->
    <div id="modal-add-emp" class="modal">
        <div class="modal-content">
            <h3>Add New Employee</h3>
            <div class="flex flex-col gap-2">
                <input type="text" id="new-emp-id" class="input-control" placeholder="Unique ID (e.g. EMP102)">
                <input type="text" id="new-emp-name" class="input-control" placeholder="Full Name">
                <select id="new-emp-comp" class="input-control"></select>
                <input type="tel" id="new-emp-mobile" class="input-control" placeholder="Mobile (with country code)">
                <input type="email" id="new-emp-email" class="input-control" placeholder="Email">
                <input type="text" id="new-emp-pass" class="input-control" placeholder="Password (Default: 1234)">
                <div class="flex gap-2 mt-2">
                    <button class="btn btn-primary w-full" onclick="addEmployee()">Create</button>
                    <button class="btn btn-outline w-full" onclick="closeModal('modal-add-emp')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Application Logic -->
    <script>
        /* --- CONFIG & CREDENTIALS --- */
        const APP_VERSION = "v2.11.0-LOGIN-STATUS";
        
        // HARDCODED CREDENTIALS
        let CLOUD_CONFIG = {
            binId: "6989e18c43b1c97be971bb47", 
            masterKey: "$2a$10$31RRwjp5GFNYo/puv4Q/wOln3poLiM/SM3lXde69LjAIKizHfzYSe"
        };

        /* --- DATA STORE & INIT --- */
        const Store = {
            get: (key) => {
                try { return JSON.parse(localStorage.getItem('eas_' + key)); } 
                catch(e) { console.error("Store Read Error", e); return []; }
            },
            set: (key, data) => localStorage.setItem('eas_' + key, JSON.stringify(data)),
            
            init: function() {
                let users = this.get('users');
                if (!users || users.length === 0) {
                    const defaultUsers = [
                        { id: 'Admin', name: 'Administrator', role: 'ADMIN', pass: '1234', company: '', mobile: '', email: '', photo: 'https://i.pravatar.cc/150?u=admin' },
                        { id: 'EMP', name: 'John Doe', role: 'EMP', pass: '1234', company: 'TechSolutions', mobile: '919876543210', email: 'john@tech.com', photo: 'https://i.pravatar.cc/150?u=john' }
                    ];
                    this.set('users', defaultUsers);
                    users = defaultUsers;
                }
                if(!localStorage.getItem('eas_companies')) {
                    this.set('companies', [
                        { id: 1, name: 'TechSolutions', email: 'finance@techsolutions.com' },
                        { id: 2, name: 'LogiCorp', email: 'accounts@logi.com' }
                    ]);
                }
                
                if($('version-display')) $('version-display').innerText = APP_VERSION;
                this.sync();
            }
        };

        Store.init();
        let currentUser = null;
        let currentRole = 'EMP';
        let map = null;
        let markers = [];
        let appIsOnline = true; 

        /* --- UTILITIES --- */
        const $ = (id) => document.getElementById(id);
        const notify = (msg, type='success') => {
            const t = document.createElement('div');
            t.style.cssText = `padding:15px; background:${type==='success'?'#10b981':'#ef4444'}; color:white; border-radius:8px; animation:slideIn 0.3s; box-shadow:0 5px 15px rgba(0,0,0,0.2); min-width: 250px; text-align:center; margin-bottom:10px;`;
            t.innerHTML = msg;
            $('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        };

        /* --- CLOUD SYNC LOGIC --- */
        function updateCloudStatus() {
            // Dashboard Header LEDs
            const led = $('cloud-led');
            const txt = $('cloud-text');

            // Login Screen LEDs (Admin Panel)
            const adminLed = $('admin-led-login');
            const adminTxt = $('admin-text-login');

            // Login Screen LEDs (General Footer)
            const genLed = $('general-led-login');
            const genTxt = $('general-text-login');

            // Set all to syncing
            applyStatus(led, txt, 'syncing', 'Syncing...');
            applyStatus(adminLed, adminTxt, 'syncing', 'Syncing...');
            applyStatus(genLed, genTxt, 'syncing', 'Syncing...');

            setTimeout(() => {
                const isOnline = navigator.onLine; 
                const className = isOnline ? 'connected' : 'disconnected';
                const msg = isOnline ? 'Connected' : 'Offline';

                applyStatus(led, txt, className, msg);
                applyStatus(adminLed, adminTxt, className, msg);
                applyStatus(genLed, genTxt, className, msg);
            }, 1500);
        }

        function applyStatus(ledEl, textEl, className, textMsg) {
            if(!ledEl) return;
            ledEl.className = `led ${className}`;
            if(textEl) textEl.innerText = textMsg;
        }

        function manualCloudSync() {
            notify('Syncing...', 'info');
            Store.sync().then(success => {
                if(success) {
                    notify('Sync Complete');
                    updateCloudStatus();
                } else {
                    notify('Sync Failed. Check connection.', 'error');
                }
            });
        }

        setInterval(updateCloudStatus, 10000);
        updateCloudStatus();

        /* --- AUTH --- */
        function selectRole(role) {
            currentRole = role;
            const empBtn = $('btn-role-emp');
            const adminBtn = $('btn-role-admin');
            const cloudPanel = $('admin-cloud-settings');

            empBtn.classList.remove('active');
            adminBtn.classList.remove('active');

            if (role === 'EMP') {
                empBtn.classList.add('active');
                cloudPanel.classList.add('hidden');
            } else {
                adminBtn.classList.add('active');
                cloudPanel.classList.remove('hidden');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const u = $('login-user').value.trim();
            const p = $('login-pass').value.trim();
            const users = Store.get('users');
            
            const user = users.find(x => (x.id.toLowerCase() === u.toLowerCase() || x.email.toLowerCase() === u.toLowerCase()) && x.pass === p);

            if(user) {
                if(user.role !== currentRole) {
                    notify(`Select ${user.role} tab to login`, 'error');
                    return;
                }
                
                if (!appIsOnline) {
                    notify('Login Disabled (Offline Mode)', 'error');
                    return;
                }

                currentUser = user;
                initDashboard();
            } else {
                notify('Invalid Credentials', 'error');
            }
        }

        function logout() {
            currentUser = null;
            $('dashboard-screen').classList.add('hidden');
            $('auth-screen').classList.remove('hidden');
            $('login-user').value = '';
            $('login-pass').value = '';
            selectRole('EMP');
        }

        /* --- DASHBOARD INIT --- */
        function initDashboard() {
            $('auth-screen').classList.add('hidden');
            $('dashboard-screen').classList.remove('hidden');
            
            $('nav-username').innerText = currentUser.name;
            $('nav-role').innerText = currentUser.role;
            $('nav-avatar').src = currentUser.photo || `https://ui-avatars.com/api/?name=${currentUser.name}`;
            $('set-name').value = currentUser.name;

            if(currentUser.role === 'EMP') {
                $('menu-emp').classList.remove('hidden');
                $('menu-admin').classList.add('hidden');
                navTo('emp-att');
                startClock();
            } else {
                $('menu-admin').classList.remove('hidden');
                $('menu-emp').classList.add('hidden');
                navTo('adm-dash');
                initAdminMap();
                loadAdminStats();
            }
        }

        function navTo(viewId) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            $(viewId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = Array.from(document.querySelectorAll('.nav-item')).find(el => el.getAttribute('onclick').includes(viewId));
            if(activeNav) activeNav.classList.add('active');

            if(window.innerWidth <= 768) {
                toggleSidebar(false);
            }
        }

        function toggleSidebar(forceState) {
            const sidebar = $('sidebar');
            const backdrop = $('backdrop');
            const isOpen = sidebar.classList.contains('open');
            const newState = forceState !== undefined ? forceState : !isOpen;

            if(newState) {
                sidebar.classList.add('open');
                backdrop.classList.remove('hidden');
            } else {
                sidebar.classList.remove('open');
                backdrop.classList.add('hidden');
            }
        }

        /* --- CLOUD KEY UPDATE LOGIC --- */
        function toggleCloudEdit() {
            const area = $('cloud-edit-area');
            const btnId = $('edit-bin-id');
            const btnKey = $('edit-master-key');
            
            if(area.classList.contains('open')) {
                area.classList.remove('open');
            } else {
                // Pre-fill with current keys
                btnId.value = CLOUD_CONFIG.binId;
                btnKey.value = CLOUD_CONFIG.masterKey;
                area.classList.add('open');
            }
        }

        function saveNewCloudKeys() {
            const newBin = $('edit-bin-id').value.trim();
            const newKey = $('edit-master-key').value.trim();
            
            if(!newBin || !newKey) return notify("Both fields required", 'error');
            
            CLOUD_CONFIG.binId = newBin;
            CLOUD_CONFIG.masterKey = newKey;
            
            notify("Keys Updated. Syncing...");
            manualCloudSync();
            $('cloud-edit-area').classList.remove('open');
        }

        /* --- EMPLOYEE LOGIC --- */
        function startClock() {
            setInterval(() => {
                const now = new Date();
                $('clock').innerText = now.toLocaleTimeString();
            }, 1000);
        }

        function doCheckIn() {
            if(!navigator.geolocation) return notify('GPS not supported', 'error');
            notify('Fetching location...', 'info');
            navigator.geolocation.getCurrentPosition(pos => {
                const att = Store.get('attendance');
                const today = new Date().toISOString().split('T')[0];
                
                if(att.find(x => x.userId === currentUser.id && x.date === today)) {
                    return notify('Already checked in today', 'error');
                }
                att.push({
                    id: Date.now(),
                    userId: currentUser.id,
                    userName: currentUser.name,
                    date: today,
                    checkIn: new Date().toLocaleTimeString(),
                    checkOut: null,
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude
                });
                Store.set('attendance', att);
                Store.push('attendance', att);

                $('att-status').innerText = 'Checked In';
                $('att-status').className = 'badge badge-success mb-2';
                $('att-status').style.background = 'var(--success)';
                $('btn-emp-checkout').classList.remove('hidden');
                notify(`Checked In @ ${pos.coords.latitude.toFixed(4)}, ${pos.coords.longitude.toFixed(4)}`);
            }, err => notify('GPS Access Denied', 'error'));
        }

        function doCheckOut() {
            const att = Store.get('attendance');
            const today = new Date().toISOString().split('T')[0];
            const rec = att.find(x => x.userId === currentUser.id && x.date === today);
            if(rec) {
                rec.checkOut = new Date().toLocaleTimeString();
                Store.set('attendance', att);
                Store.push('attendance', att);

                $('att-status').innerText = 'Checked Out';
                $('att-status').style.background = 'var(--secondary)';
                $('btn-emp-checkout').classList.add('hidden');
                notify('Checked out successfully');
            }
        }

        function applyLeave() {
            const from = $('leave-from').value;
            const to = $('leave-to').value;
            const reason = $('leave-reason').value;
            if(!from || !to || !reason) return notify('Fill all fields', 'error');
            const leaves = Store.get('leaves');
            leaves.push({
                id: Date.now(),
                userId: currentUser.id,
                userName: currentUser.name,
                from, to, reason,
                status: 'Pending'
            });
            Store.set('leaves', leaves);
            Store.push('leaves', leaves);

            notify('Leave request sent');
            $('leave-from').value = ''; $('leave-to').value = ''; $('leave-reason').value = '';
            loadEmpLeaves();
        }

        function loadEmpLeaves() {
            const tbody = $('emp-leave-history');
            if(!tbody) return;
            tbody.innerHTML = '';
            const leaves = Store.get('leaves').filter(x => x.userId === currentUser.id);
            leaves.forEach(l => {
                let color = 'orange';
                if(l.status === 'Approved') color = 'green';
                if(l.status === 'Rejected') color = 'red';
                tbody.innerHTML += `<tr><td>${l.from} to ${l.to}</td><td>${l.reason}</td><td><span style="font-weight:bold; color:${color}">${l.status}</span></td></tr>`;
            });
        }

        function sendAdvanceRequest() {
            const type = $('adv-type').value;
            const amt = $('adv-amount').value;
            const desc = $('adv-desc').value;
            const comp = Store.get('companies').find(c => c.name === currentUser.company);
            const email = comp ? comp.email : 'finance@company.com';
            if(!amt) return notify('Enter amount', 'error');
            notify(`Request sent to ${email}`, 'success');
            window.location.href = `mailto:${email}?subject=Advance Request: ${currentUser.name}&body=Type: ${type}%0AAmount: ${amt}%0ADescription: ${desc}`;
        }

        function requestPerms() { if('geolocation' in navigator) navigator.geolocation.getCurrentPosition(()=>notify('GPS Allowed'), ()=>notify('GPS Denied','error')); }
        function requestNotif() { Notification.requestPermission().then(p => notify(p==='granted'?'Notifications Enabled':'Notifications Denied', p==='granted'?'success':'error')); }
        function saveSettings() {
            const users = Store.get('users');
            const idx = users.findIndex(u => u.id === currentUser.id);
            if(idx > -1) {
                users[idx].name = $('set-name').value;
                if($('set-pass').value) users[idx].pass = $('set-pass').value;
                Store.set('users', users);
                Store.push('users', users);
                currentUser = users[idx];
                notify('Profile Updated');
            }
        }

        /* --- ADMIN LOGIC --- */
        function initAdminMap() {
            if(!map) {
                map = L.map('map-container').setView([20.5937, 78.9629], 5);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            }
            refreshMapMarkers();
        }

        function refreshMapMarkers() {
            if(!map) return;
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const att = Store.get('attendance');
            const today = new Date().toISOString().split('T')[0];
            att.forEach(r => {
                if(r.date === today && r.lat) {
                    const m = L.marker([r.lat, r.lng]).addTo(map).bindPopup(`${r.userName}<br>Checked In: ${r.checkIn}`);
                    markers.push(m);
                }
            });
        }

        function loadAdminStats() {
            const users = Store.get('users').filter(u => u.role === 'EMP');
            $('dash-total-emp').innerText = users.length;
            const today = new Date().toISOString().split('T')[0];
            const present = Store.get('attendance').filter(a => a.date === today).length;
            $('dash-present').innerText = present;
            const leaves = Store.get('leaves').filter(l => l.status === 'Pending').length;
            $('dash-leaves').innerText = leaves;
            loadCompanies(); 
        }

        /* COMPANY MANAGEMENT */
        function loadCompanies() {
            const tbody = $('comp-table');
            if(!tbody) return;
            tbody.innerHTML = '';
            const comps = Store.get('companies');
            const selects = [$('new-emp-comp'), $('msg-company')];
            selects.forEach(sel => {
                if(sel) {
                    sel.innerHTML = '<option value="">Select Company</option>';
                    comps.forEach(c => sel.innerHTML += `<option value="${c.name}">${c.name}</option>`);
                }
            });
            comps.forEach(c => {
                tbody.innerHTML += `<tr><td>${c.name}</td><td>${c.email}</td><td><button class="btn btn-danger btn-sm" onclick="delComp(${c.id})">Del</button></td></tr>`;
            });
        }

        function addCompany() {
            const name = $('comp-name').value;
            const email = $('comp-email').value;
            if(!name) return notify('Enter name', 'error');
            const comps = Store.get('companies');
            comps.push({ id: Date.now(), name, email });
            Store.push('companies', comps);
            loadCompanies();
            $('comp-name').value = '';
            $('comp-email').value = '';
        }

        function delComp(id) {
            if(confirm('Delete Company?')) {
                const comps = Store.get('companies').filter(c => c.id !== id);
                Store.set('companies', comps);
                Store.push('companies', comps);
                loadCompanies();
            }
        }

        /* TEAM MANAGEMENT */
        function loadTeam() {
            const tbody = $('team-table');
            if(!tbody) return;
            tbody.innerHTML = '';
            const users = Store.get('users').filter(u => u.role === 'EMP');
            users.forEach(u => {
                tbody.innerHTML += `
                    <tr>
                        <td><img src="${u.photo}" class="user-avatar" style="width:30px;height:30px;"></td>
                        <td>${u.name} (${u.id})</td>
                        <td>${u.company}</td>
                        <td>EMP</td>
                        <td><button class="btn btn-danger btn-sm" onclick="delUser('${u.id}')">Remove</button></td>
                    </tr>`;
            });
        }

        function addEmployee() {
            const id = $('new-emp-id').value;
            const name = $('new-emp-name').value;
            const comp = $('new-emp-comp').value;
            const mobile = $('new-emp-mobile').value;
            const email = $('new-emp-email').value;
            const pass = $('new-emp-pass').value || '1234';
            if(!id || !name) return notify('Fill required fields', 'error');
            const users = Store.get('users');
            if(users.find(u => u.id === id)) return notify('ID exists', 'error');
            users.push({ id, name, role: 'EMP', company: comp, mobile, email, pass, photo: `https://ui-avatars.com/api/?name=${name}` });
            Store.push('users', users);
            closeModal('modal-add-emp');
            loadTeam();
            notify('Employee Added');
        }

        function delUser(id) {
            if(confirm('Remove employee?')) {
                const users = Store.get('users').filter(u => u.id !== id);
                Store.set('users', users);
                Store.push('users', users);
                loadTeam();
            }
        }

        /* ATTENDANCE & LEAVES */
        function loadReport() {
            const date = $('rep-date').value;
            if(!date) return notify('Select date', 'error');
            const tbody = $('att-report');
            if(!tbody) return;
            tbody.innerHTML = '';
            const att = Store.get('attendance').filter(a => a.date === date);
            const users = Store.get('users');
            users.forEach(u => {
                if(u.role === 'ADMIN') return;
                const leaves = Store.get('leaves').filter(l => l.userId === u.id && l.status === 'Approved');
                const isLeave = leaves.some(l => date >= l.from && date <= l.to);
                if(isLeave) {
                    tbody.innerHTML += `<tr><td>${u.name}</td><td colspan="2">On Leave</td><td>-</td><td><span style="font-weight:bold;color:orange">Leave</span></td><td>-</td></tr>`;
                    return;
                }
                const record = att.find(a => a.userId === u.id);
                if(record) {
                    tbody.innerHTML += `
                        <tr>
                            <td>${u.name}</td>
                            <td>${record.checkIn}</td>
                            <td>${record.checkOut || '--:--'}</td>
                            <td><a href="#" onclick="openMap(${record.lat}, ${record.lng})">View</a></td>
                            <td><span style="font-weight:bold;color:green">Present</span></td>
                            <td><button class="btn btn-outline btn-sm" onclick="regAtt(${record.id})">Edit</button></td>
                        </tr>`;
                } else {
                    tbody.innerHTML += `<tr><td>${u.name}</td><td>-</td><td>-</td><td>-</td><td><span style="font-weight:bold;color:red">Absent</span></td><td><button class="btn btn-outline btn-sm" onclick="markMan('${u.id}', '${date}')">Mark</button></td></tr>`;
                }
            });
        }

        function regAtt(id) {
            const time = prompt('Enter corrected Check-in time:');
            if(time) {
                const att = Store.get('attendance');
                const r = att.find(x => x.id === id);
                if(r) { r.checkIn = time; Store.set('attendance', att); Store.push('attendance', att); loadReport(); notify('Regularized'); }
            }
        }

        function markMan(uid, date) {
            const time = prompt('Enter Check-in time:');
            if(time) {
                const att = Store.get('attendance');
                att.push({ id: Date.now(), userId: uid, date, checkIn: time, checkOut: null, lat:0, lng:0 });
                Store.set('attendance', att);
                Store.push('attendance', att);
                loadReport();
                notify('Marked Present');
            }
        }

        function loadLeavesForApproval() {
            const tbody = $('leave-approve-table');
            if(!tbody) return;
            tbody.innerHTML = '';
            const leaves = Store.get('leaves').filter(l => l.status === 'Pending');
            leaves.forEach(l => {
                tbody.innerHTML += `
                    <tr>
                        <td>${l.userName}</td>
                        <td>${l.from} to ${l.to}</td>
                        <td>${l.reason}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="procLeave(${l.id}, 'Approved')"></button>
                            <button class="btn btn-danger btn-sm" onclick="procLeave(${l.id}, 'Rejected')"></button>
                        </td>
                    </tr>`;
            });
        }

        function procLeave(id, status) {
            const leaves = Store.get('leaves');
            const l = leaves.find(x => x.id === id);
            if(l) {
                l.status = status;
                Store.set('leaves', leaves);
                Store.push('leaves', leaves);
                loadLeavesForApproval();
                notify(`Leave ${status}`);
            }
        }

        function sendWhatsApp(type) {
            const target = 'all';
            const msg = prompt("Enter broadcast message:");
            let phones = "";
            const users = Store.get('users').filter(u => u.role === 'EMP');
            users.forEach(u => phones += u.mobile + ",");
            
            if(!phones || !msg) return notify('Select recipients and message', 'error');
            const fullMsg = `[${type}] ${msg}`;
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(fullMsg)}&phone=${phones}`, '_blank');
            notify('WhatsApp Opened');
        }

        /* --- STORE SYNC METHODS --- */
        Store.sync = async function() {
            const binId = CLOUD_CONFIG.binId;
            const masterKey = CLOUD_CONFIG.masterKey;

            if (!binId || !masterKey) {
                console.log("Cloud Sync Skipped: No credentials.");
                return; 
            }

            try {
                const url = `https://api.jsonbin.io/v3/b/${binId}/latest`;
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': masterKey }
                });
                const data = await response.json();
                const record = data.record;

                if (record) {
                    console.log("Data fetched from Cloud successfully.");
                    if(record.users) this.set('users', record.users);
                    if(record.attendance) this.set('attendance', record.attendance);
                    if(record.leaves) this.set('leaves', record.leaves);
                    if(record.companies) this.set('companies', record.companies);
                    return true;
                }
                return false;
            } catch (error) {
                console.error("Sync Error:", error);
                return false;
            }
        };

        Store.push = async function(key, data) {
            this.set(key, data);
            const binId = CLOUD_CONFIG.binId;
            const masterKey = CLOUD_CONFIG.masterKey;

            if (!binId || !masterKey) return; 

            try {
                const fullState = {
                    users: this.get('users'),
                    attendance: this.get('attendance'),
                    leaves: this.get('leaves'),
                    companies: this.get('companies')
                };
                const payload = { record: fullState };

                const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'X-Master-Key': masterKey },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    console.log("Cloud Push Successful.");
                } else {
                    console.error("Cloud Push Failed.");
                }
            } catch (e) {
                console.error("Cloud Push Error:", e);
            }
        };

        /* --- HELPERS --- */
        function openModal(id) { 
            const el = $(id); 
            el.classList.remove('hidden'); 
            setTimeout(() => el.classList.add('open'), 10); 
        }
        function closeModal(id) { 
            const el = $(id); 
            el.classList.remove('open'); 
            setTimeout(() => el.classList.add('hidden'), 200); 
        }
        function openMap(lat, lng) { window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank'); }

        /* --- INIT LOADERS --- */
        if($('adm-team')) $('adm-team').addEventListener('click', loadTeam);
        if($('adm-comp')) $('adm-comp').addEventListener('click', loadCompanies);
        if($('adm-att')) $('adm-att').addEventListener('click', loadReport);
        if($('adm-leave')) $('adm-leave').addEventListener('click', loadLeavesForApproval);
        if($('emp-leave')) $('emp-leave').addEventListener('click', loadEmpLeaves);
    </script>
</body>
</html>